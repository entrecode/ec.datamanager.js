(function(f){if(typeof exports==="object"&&typeof module!=="undefined"){module.exports=f()}else if(typeof define==="function"&&define.amd){define([],f)}else{var g;if(typeof window!=="undefined"){g=window}else if(typeof global!=="undefined"){g=global}else if(typeof self!=="undefined"){g=self}else{g=this}g.DataManager=f()}})(function(){var define,module,exports;return function e(t,n,r){function s(o,u){if(!n[o]){if(!t[o]){var a=typeof require=="function"&&require;if(!u&&a)return a(o,!0);if(i)return i(o,!0);var f=new Error("Cannot find module '"+o+"'");throw f.code="MODULE_NOT_FOUND",f}var l=n[o]={exports:{}};t[o][0].call(l.exports,function(e){var n=t[o][1][e];return s(n?n:e)},l,l.exports,e,t,n,r)}return n[o].exports}var i=typeof require=="function"&&require;for(var o=0;o<r.length;o++)s(r[o]);return s}({1:[function(require,module,exports){"use strict";var halfred=require("halfred");var locale=require("locale");var util=require("./util");var Asset=function(asset,dm){this.value=asset;this._dm=dm};Asset.prototype.save=function(){var asset=this;return Promise.resolve().then(function(){return asset._dm._getTraversal()}).then(function(traversal){delete asset.value._curies;delete asset.value._curiesMap;delete asset.value._resolvedCuriesMap;delete asset.value._validation;delete asset.value._original;delete asset.value._embedded;return util.putP(traversal.continue().newRequest().follow("ec:api/assets").withTemplateParameters({assetID:asset.value.assetID}).withRequestOptions(asset._dm._requestOptions({"Content-Type":"application/json"})),asset.value)}).then(function(res){return util.checkResponse(res[0])}).then(function(res){if(res.statusCode===204){return Promise.resolve(true)}asset.value=halfred.parse(JSON.parse(res.body));return Promise.resolve(asset)}).catch(util.errorHandler)};Asset.prototype.delete=function(){var asset=this;return Promise.resolve().then(function(){return asset._dm._getTraversal()}).then(function(traversal){return util.deleteP(traversal.continue().newRequest().follow("ec:api/assets").withTemplateParameters({assetID:asset.value.assetID}).withRequestOptions(asset._dm._requestOptions()))}).then(function(res){return util.checkResponse(res[0])}).then(function(){return Promise.resolve(true)}).catch(util.errorHandler)};Asset.prototype.getFileUrl=function(locale){return this._negotiate(false,false,null,locale)};Asset.prototype.getImageUrl=function(size,locale){if(this.value.type!=="image"){throw new Error("ec.datamanager.js getImageUrl only works on image assets")}return this._negotiate(true,false,size,locale)};Asset.prototype.getImageThumbUrl=function(size,locale){if(this.value.type!=="image"){throw new Error("ec.datamanager.js getImageThumbUrl only works on image assets")}return this._negotiate(true,true,size,locale)};Asset.prototype._negotiate=function(image,thumb,size,requestedLocale){var asset=JSON.parse(JSON.stringify(this.value));if(requestedLocale){var supportedLocales=new locale.Locales(compact(uniq(asset.files.map(function(elem){return elem.locale}))));var bestLocale=new locale.Locales(requestedLocale).best(supportedLocales).toString();bestLocale=/^([^\.]+)/.exec(bestLocale)[1];var filesWithLocale=asset.files.filter(function(file){return file.locale===bestLocale});if(filesWithLocale&&filesWithLocale.length>0){asset.files=filesWithLocale}}if(!image&&!thumb&&asset.type!=="image"){return asset.files[0].url}var first=asset.files[0];asset.files=remove(asset.files,function(file){return file.resolution===null});if(asset.files.length===0){return first.url}asset.files.sort(function(left,right){var leftMax=Math.max(left.resolution.height,left.resolution.width);var rightMax=Math.max(right.resolution.height,right.resolution.width);if(leftMax<rightMax){return 1}else if(leftMax>rightMax){return-1}else{return 0}});var imageFiles=asset.files.filter(function(file){if(thumb){return file.url.indexOf("_thumb")!==-1}else{return file.url.indexOf("_thumb")===-1}});if(!imageFiles||imageFiles.length===0){imageFiles=asset.files}var largest=imageFiles[0];if(size){imageFiles=imageFiles.filter(function(file){return file.resolution.height>=size||file.resolution.width>=size});imageFiles=imageFiles.slice(-1)}if(imageFiles.length>0){return imageFiles[0].url}else{return largest.url}};Asset.prototype.getOriginal=function(){var asset=JSON.parse(JSON.stringify(this.value));if(asset.type!=="image"){return asset.files[0]}var first=asset.files[0];asset.files=remove(asset.files,function(file){return file.resolution===null});if(asset.files.length===0){return first}asset.files.sort(function(left,right){var leftMax=Math.max(left.resolution.height,left.resolution.width);var rightMax=Math.max(right.resolution.height,right.resolution.width);if(leftMax<rightMax){return 1}else if(leftMax>rightMax){return-1}else{return 0}});return asset.files[0]};function uniq(arr){var u={},a=[];for(var i=0,l=arr.length;i<l;++i){if(Object.prototype.hasOwnProperty.call(u,arr[i])){continue}a.push(arr[i]);u[arr[i]]=1}return a}function compact(arr){var a=[];for(var i=0;i<arr.length;i++){if(arr[i]){a.push(arr[i])}}return a}function remove(arr,func){var a=[];for(var i=0;i<arr.length;i++){if(!func.call(this,arr[i])){a.push(arr[i])}}return a}module.exports=Asset},{"./util":7,halfred:13,locale:20}],2:[function(require,module,exports){"use strict";var halfred=require("halfred");var loki=require("lokijs");var request=require("superagent");var shiroTrie=require("shiro-trie");var traverson=require("traverson");var TraversonJsonHalAdapter=require("traverson-hal");var Asset=require("./Asset");var Entry=require("./Entry");var Model=require("./Model");var User=require("./User");var Tag=require("./Tag");var util=require("./util");if(typeof Promise==="undefined"){require("es6-promise").polyfill()}traverson.registerMediaType(TraversonJsonHalAdapter.mediaType,TraversonJsonHalAdapter);var DataManager=function(options){if(!options||!options.hasOwnProperty("url")&&!options.hasOwnProperty("id")){throw new Error("ec_sdk_no_url_or_id_set")}if(options.hasOwnProperty("url")&&options.url!==null){this.url=options.url}else{this.id=options.id;this.url="https://datamanager.entrecode.de/api/"+this.id}if(this.url.slice(-1)==="/"){this.url=this.url.substr(0,this.url.length-1)}if(!this.id){this.id=this.url.split("/").reverse()[0]}if(!/^[a-f0-9]+$/i.test(this.id)){throw new Error("ec_sdk_invalid_url")}this._fileUrl=this.url.replace("api/"+this.id,"files");this._modelCache={};this._rootTraversal=null;if(options.hasOwnProperty("accessToken")){this.accessToken=options.accessToken}if(options.hasOwnProperty("clientID")){this.clientID=options.clientID}if(options.hasOwnProperty("errorHandler")){this.errorHandler=options.errorHandler}util._dm=this};DataManager._fileUrl="https://datamanager.entrecode.de/files";DataManager._getFileUrl=function(assetID,locale,url){return Promise.resolve().then(function(){if(!assetID){return Promise.reject(new Error("ec_sdk_no_assetid_provided"))}var req=request.get(url+"/"+assetID+"/url");if(locale){req.set("Accept-Language",locale)}return new Promise(function(resolve,reject){req.end(function(err,res){if(err){return reject(err)}if(!res.body.hasOwnProperty("url")){return reject(new Error("ec_sdk_could_not_get_url_for_file"))}return resolve(res.body.url)})})})};DataManager._getImageUrl=function(assetID,size,locale,url){return Promise.resolve().then(function(){if(!assetID){return Promise.reject(new Error("ec_sdk_no_assetid_provided"))}var req=request.get(url+"/"+assetID+"/url");if(locale){req.set("Accept-Language",locale)}if(size){req.query({size:size})}return new Promise(function(resolve,reject){req.end(function(err,res){if(err){return reject(err)}if(!res.body.hasOwnProperty("url")){return reject(new Error("ec_sdk_could_not_get_url_for_file"))}return resolve(res.body.url)})})})};DataManager._getImageThumbUrl=function(assetID,size,locale,url){return Promise.resolve().then(function(){if(!assetID){return Promise.reject(new Error("ec_sdk_no_assetid_provided"))}if(size&&size<=50){size=50}else if(size&&size<=100){size=100}else if(size&&size<=200){size=200}else{size=400}var req=request.get(url+"/"+assetID+"/url");if(locale){req.set("Accept-Language",locale)}req.query({size:size,thumb:true});return new Promise(function(resolve,reject){req.end(function(err,res){if(err){return reject(err)}if(!res.body.hasOwnProperty("url")){return reject(new Error("ec_sdk_could_not_get_url_for_file"))}return resolve(res.body.url)})})})};DataManager.getFileUrl=function(assetID,locale){return DataManager._getFileUrl(assetID,locale,DataManager._fileUrl)};DataManager.getImageUrl=function(assetID,size,locale){return DataManager._getImageUrl(assetID,size,locale,DataManager._fileUrl)};DataManager.getImageThumbUrl=function(assetID,size,locale){return DataManager._getImageThumbUrl(assetID,size,locale,DataManager._fileUrl)};DataManager.prototype.getFileUrl=function(assetID,locale){return DataManager._getFileUrl(assetID,locale,this._fileUrl)};DataManager.prototype.getImageUrl=function(assetID,size,locale){return DataManager._getImageUrl(assetID,size,locale,this._fileUrl)};DataManager.prototype.getImageThumbUrl=function(assetID,size,locale){return DataManager._getImageThumbUrl(assetID,size,locale,this._fileUrl)};DataManager.prototype.resolve=function(){var dm=this;return Promise.resolve().then(function(){return util.getP(traverson.from(dm.url).jsonHal().withRequestOptions(dm._requestOptions()))}).then(function(r){dm._rootTraversal=r[1];return util.checkResponse(r[0])}).then(function(res){var body=halfred.parse(JSON.parse(res.body));dm.metadata=body;return Promise.resolve(dm)}).catch(util.errorHandler)};DataManager.prototype.modelList=function(){var dm=this;return Promise.resolve().then(function(){return util.getP(traverson.from(dm.url).jsonHal().withRequestOptions(dm._requestOptions()))}).then(function(r){dm._rootTraversal=r[1];return util.checkResponse(r[0])}).then(function(res){var body=JSON.parse(res.body);var out={};for(var i=0;i<body.models.length;i++){out[body.models[i].title]=new Model(body.models[i].title,body.models[i],dm)}dm._modelCache=out;return Promise.resolve(out)}).catch(util.errorHandler)};DataManager.prototype.enableCache=function(models,env,maxCacheAge){return this._makeDB(env).then(function(){var promises=[];if(typeof models==="string"){models=[models]}if(Array.isArray(models)){models.map(function(model){promises.push(this.model(model).enableCache(env,maxCacheAge))}.bind(this))}else{for(var key in models){if(models.hasOwnProperty(key)){promises.push(this.model(key).enableCache(env,models[models[key]]))}}}return Promise.all(promises)}.bind(this))};DataManager.prototype.clearCache=function(models){if(!models){models=this._db.listCollections().map(function(collection){return collection.name})}if(typeof models==="string"){models=[models]}return Promise.all(models.map(function(model){this.model(model).clearCache()}.bind(this)))};DataManager.prototype.model=function(title,metadata){var dm=this;if(dm._modelCache[title]){return dm._modelCache[title]}return dm._modelCache[title]=new Model(title,metadata,dm)};DataManager.prototype.assetList=function(options){var dm=this;return Promise.resolve().then(function(){return dm._getTraversal()}).then(function(traversal){var t=traversal.continue().newRequest().follow("ec:api/assets");if(options){t.withTemplateParameters(util.optionsToQueryParameter(options))}t.withRequestOptions(dm._requestOptions());return util.getP(t)}).then(function(res){return util.checkResponse(res[0])}).then(function(res){var body=halfred.parse(JSON.parse(res.body));if(body.hasOwnProperty("count")&&body.count===0&&body.hasOwnProperty("total")){return Promise.resolve({assets:[],count:body.count,total:body.total})}var assets=body.embeddedArray("ec:api/asset");var out=[];if(!assets){out.push(new Asset(body,dm))}else{for(var i=0;i<assets.length;i++){out.push(new Asset(assets[i],dm))}}return Promise.resolve({assets:out,count:body.count,total:body.total})}).catch(util.errorHandler)};DataManager.prototype.assets=function(options){return this.assetList(options).then(function(list){return Promise.resolve(list.assets)})};DataManager.prototype.asset=function(assetID){var dm=this;return Promise.resolve().then(function(){if(!assetID){return Promise.reject(new Error("ec_sdk_no_assetid_provided"))}var options={};if(typeof assetID==="string"){options.filter={assetID:{exact:assetID}}}else{options=assetID}return dm.assets(options)}).then(function(assets){if(!assets.length){return Promise.reject(new Error("ec_sdk_no_match_due_to_filter"))}return Promise.resolve(assets[0])}).catch(util.errorHandler)};DataManager.prototype.createAsset=function(input,tags,title){var dm=this;return Promise.resolve().then(function(){return dm._getTraversal()}).then(function(traversal){return util.getUrlP(traversal.continue().newRequest().follow("ec:api/assets"))}).then(function(url){var req=request.post(url[0]);if(dm.accessToken){req.set("Authorization","Bearer "+dm.accessToken)}var isFormData;if(typeof input==="string"){isFormData=false;req.attach("file",input)}else if(Array.isArray(input)){isFormData=false;for(var i=0;i<input.length;i++){req.attach("file",input[i])}}else{isFormData=true;req.send(input)}if(title){if(isFormData){input.field("title",title)}else{req.field("title",title)}}if(tags){if(isFormData){input.field("tags",JSON.stringify(tags))}else{req.field("tags",JSON.stringify(tags))}}return new Promise(function(resolve,reject){req.end(function(err,res){if(err){return reject(err)}return resolve(res)})})}).then(function(res){return util.checkResponse(res)}).then(function(res){var regex=/^.*\?assetID=([0-9A-Fa-f]{8}-[0-9A-Fa-f]{4}-4[0-9A-Fa-f]{3}-[89ABab][0-9A-Fa-f]{3}-[0-9A-Fa-f]{12})$/;var body=halfred.parse(res.body);var assets=body.linkArray("ec:asset");var out=[];for(var i=0;i<assets.length;i++){out.push(dm.asset(regex.exec(assets[i].href)[1]))}return Promise.resolve(out)}).catch(util.errorHandler)};DataManager.prototype.tagList=function(options){var dm=this;return Promise.resolve().then(function(){return dm._getTraversal()}).then(function(traversal){return util.getP(traversal.continue().newRequest().follow("ec:api/assets","ec:api/tags").withTemplateParameters([null,null,util.optionsToQueryParameter(options)]).withRequestOptions(dm._requestOptions()))}).then(function(res){return util.checkResponse(res[0])}).then(function(res){var body=halfred.parse(JSON.parse(res.body));if(body.hasOwnProperty("count")&&body.count===0&&body.hasOwnProperty("total")){return Promise.resolve({tags:[],count:body.count,total:body.total})}var tags=body.embeddedArray("ec:api/tag");var out=[];if(!tags){out.push(new Tag(body,dm))}else{for(var i=0;i<tags.length;i++){out.push(new Tag(tags[i],dm))}}return Promise.resolve({tags:out,count:body.count,total:body.total})}).catch(util.errorHandler)};DataManager.prototype.tags=function(options){return this.tagList(options).then(function(list){return Promise.resolve(list.tags)})};DataManager.prototype.tag=function(tag){var dm=this;return Promise.resolve().then(function(){if(!tag){return Promise.reject(new Error("ec_sdk_no_tag_name_provided"))}var options={};if(typeof tag==="string"){options.filter={tag:{exact:tag}}}else{options=tag}return dm.tags(options)}).then(function(tags){if(!tags.length){return Promise.reject(new Error("ec_sdk_no_match_due_to_filter"))}return Promise.resolve(tags[0])}).catch(util.errorHandler)};DataManager.prototype.registerAnonymous=function(validUntil){var dm=this;var userTraversal;return Promise.resolve().then(function(){return dm._getTraversal()}).then(function(traversal){var t=traversal.continue().newRequest().follow(dm.id+":_auth/anonymous");if(validUntil){t.withTemplateParameters({validUntil:validUntil})}return util.postP(t,{})}).then(function(res){userTraversal=res[1];return util.checkResponse(res[0])}).then(function(res){var body=JSON.parse(res.body);dm.accessToken=body.jwt;dm._user=new User(true,body,dm,userTraversal);dm._rootTraversal=null;return Promise.resolve(dm._user)}).catch(util.errorHandler)};DataManager.prototype.account=function(){var dm=this;var rootTraversal;return Promise.resolve().then(function(){if(!dm.accessToken){return Promise.reject(new Error("ec_sdk_not_logged_in"))}return util.getP(traverson.from(dm.url).jsonHal().withRequestOptions(dm._requestOptions()))}).then(function(res){rootTraversal=res[1];return util.checkResponse(res[0])}).then(function(res){var body=halfred.parse(JSON.parse(res.body));dm._rootTraversal=rootTraversal;dm.metadata=body;if(!dm.metadata.account){return Promise.reject(new Error("ec_skd_no_public_user"))}dm._user=new User(dm.metadata.account.email===null,dm.metadata.account,dm);return Promise.resolve(dm._user)}).catch(util.errorHandler)};DataManager.prototype.getAuthLink=function(relation,templateParameter){var dm=this;return Promise.resolve().then(function(){if(dm.clientID){if(!templateParameter){templateParameter={}}if(!templateParameter.hasOwnProperty("clientID")){templateParameter.clientID=dm.clientID}}return dm._getTraversal()}).then(function(traversal){var t=traversal.continue().newRequest().follow(dm.id+":_auth/"+relation);if(templateParameter){t.withTemplateParameters(templateParameter)}return util.getUrlP(t)}).then(function(url){return Promise.resolve(url[0])}).catch(util.errorHandler)};DataManager.prototype.emailAvailable=function(email){var dm=this;return Promise.resolve().then(function(){return dm._getTraversal()}).then(function(traversal){return util.getP(traversal.continue().newRequest().follow(dm.id+":_auth/email-available").withTemplateParameters({email:email}))}).then(function(res){return util.checkResponse(res[0])}).then(function(res){return Promise.resolve(JSON.parse(res.body).available)}).catch(util.errorHandler)};DataManager.prototype.can=function(permission){var dm=this;return Promise.resolve().then(function(){return dm._getTraversal()}).then(function(traversal){var modelTitle=permission.split(":")[0];return util.getP(traversal.continue().newRequest().follow(dm.id+":"+modelTitle+"/_permissions").withRequestOptions(dm._requestOptions()))}).then(function(res){return util.checkResponse(res[0])}).then(function(res){var body=halfred.parse(JSON.parse(res.body));var permissions=shiroTrie.new();permissions.add(body.permissions);if(permissions.check(permission)){return Promise.resolve(true)}return Promise.reject(new Error("permission_denied"))}).catch(util.errorHandler)};DataManager.prototype.logout=function(){this.accessToken=null;this._rootTraversal=null;this._modelCache={};this._db=null;this._cacheMetaData=null};DataManager.cloneEntry=function(entry){console.warn("DataManager.cloneEntry is deprecated. Use entry.clone() instead.");return entry.clone()};DataManager.cloneEntries=function(entries){return entries.map(function(entry){return entry.clone()})};DataManager.cloneAsset=function(asset){return new Asset(halfred.parse(JSON.parse(JSON.stringify(asset.value.original()))),asset._dm)};DataManager.cloneAssets=function(assets){return assets.map(function(asset){return DataManager.cloneAsset(asset)})};DataManager.cloneTag=function(tag){return new Tag(halfred.parse(JSON.parse(JSON.stringify(tag.value.original()))),tag._dm)};DataManager.cloneTags=function(tags){return tags.map(function(tag){return DataManager.cloneTag(tag)})};DataManager.prototype._getTraversal=function(){var dm=this;var rootTraversal;if(dm._rootTraversal){return Promise.resolve(dm._rootTraversal)}return Promise.resolve().then(function(){return util.getP(traverson.from(dm.url).jsonHal().withRequestOptions(dm._requestOptions()))}).then(function(res){rootTraversal=res[1];return util.checkResponse(res[0])}).then(function(){dm._rootTraversal=rootTraversal;return Promise.resolve(dm._rootTraversal)})};DataManager.prototype._requestOptions=function(additionalHeaders){var out={};out.headers={};if(this.accessToken){out.headers["Authorization"]="Bearer "+this.accessToken}if(additionalHeaders){for(var header in additionalHeaders){if(additionalHeaders.hasOwnProperty(header)){out.headers[header]=additionalHeaders[header]}}}return out};DataManager.prototype._makeDB=function(env){if(!env){env=DataManager.DB_NODEJS}if(this._db&&this._cacheMetaData){return Promise.resolve(this._db)}return new Promise(function(resolve,reject){this._db=new loki(this.id+".db.json",{env:env,autosaveInterval:5e3,autoload:true,autoloadCallback:function(err){return resolve(this._db)}.bind(this)})}.bind(this)).then(function(db){this._cacheMetaData=db.getCollection("_metadata");if(!this._cacheMetaData){this._cacheMetaData=db.addCollection("_metadata",{indices:["etag","created","title"]})}return Promise.resolve(db)}.bind(this))};DataManager.DB_NODEJS="NODEJS";DataManager.DB_CORDOVA="CORDOVA";DataManager.DB_BROWSER="BROWSER";module.exports=DataManager},{"./Asset":1,"./Entry":3,"./Model":4,"./Tag":5,"./User":6,"./util":7,"es6-promise":12,halfred:13,lokijs:22,"shiro-trie":27,superagent:29,traverson:74,"traverson-hal":34}],3:[function(require,module,exports){"use strict";var halfred=require("halfred");var util=require("./util");var locale=require("locale");var traverson=require("traverson");var TraversonJsonHalAdapter=require("traverson-hal");var Asset=require("./Asset");traverson.registerMediaType(TraversonJsonHalAdapter.mediaType,TraversonJsonHalAdapter);var Entry=function(entry,dm,model){this.value=entry;this._dm=dm;this._model=model};Entry.prototype.save=function(){var entry=this;var traversal;return Promise.resolve().then(function(){var property;cleanEntry(entry);var t;if(entry.value._links&&entry.value._links.hasOwnProperty("self")){t=traverson.from(entry.value._links.self[0].href).jsonHal()}else{t=traverson.from(entry._dm.url).jsonHal().follow(entry._dm.id+":"+entry._model.title).withTemplateParameters({_id:entry.value._id})}t.withRequestOptions(entry._dm._requestOptions({"Content-Type":"application/json"}));var valueToSave={};if(!entry.value.hasOwnProperty("$loki")||!entry.value.hasOwnProperty("meta")){return util.putP(t,entry.value)}for(property in entry.value){if(entry.value.hasOwnProperty(property)&&property!=="$loki"&&property!=="meta"){valueToSave[property]=entry.value[property]}}return util.putP(t,valueToSave)}).then(function(res){traversal=res[1];return util.checkResponse(res[0])}).then(function(res){if(res.statusCode===204){return Promise.resolve(true)}entry.value=halfred.parse(JSON.parse(res.body));if(entry._isNested){makeNestedToResource(entry,entry._dm)}entry._traversal=traversal;return Promise.resolve(entry)}).catch(util.errorHandler)};Entry.prototype.delete=function(){var entry=this;return Promise.resolve().then(function(){var t;if(entry.value._links&&entry.value._links.hasOwnProperty("self")){t=traverson.from(entry.value._links.self[0].href).jsonHal()}else{t=traverson.from(entry._dm.url).jsonHal().follow(entry._dm.id+":"+entry._model.title).withTemplateParameters({_id:entry.value._id})}t.withRequestOptions(entry._dm._requestOptions({"Content-Type":"application/json"}));return util.deleteP(t)}).then(function(res){return util.checkResponse(res[0])}).then(function(res){return Promise.resolve(true)}).catch(util.errorHandler)};Entry.prototype.getTitle=function(property){var links=this.value.linkArray(this._dm.id+":"+this._model.title+"/"+property);if(!links){return undefined}if(!Array.isArray(this.value[property])){return links[0].title}var out=[];for(var i in links){if(links.hasOwnProperty(i)){out.push(links[i].title)}}return out};Entry.prototype.getModelTitle=function(property){var links=this.value.linkArray(this._dm.id+":"+this._model.title+"/"+property);if(!links){return undefined}var regex=new RegExp("^.*/api/"+this._dm.id+"/([a-zA-Z0-9_\\-]{1,256})?.*$");return regex.exec(links[0].href)[1]};function cleanEntry(entry){delete entry.value._curies;delete entry.value._curiesMap;delete entry.value._resolvedCuriesMap;delete entry.value._validation;delete entry.value._original;delete entry.value._embedded;removeNestedResources(entry)}function removeNestedResources(entry){for(var field in entry.value){if(entry.value.hasOwnProperty(field)){if(Array.isArray(entry.value[field])){entry.value[field]=entry.value[field].map(function(e){if(e instanceof Asset){return e.value.assetID}else if(e instanceof Entry){return e.value._id}else{return e}})}else{if(entry.value[field]instanceof Asset){entry.value[field]=entry.value[field].value.assetID}else if(entry.value[field]instanceof Entry){entry.value[field]=entry.value[field].value._id}}}}}function makeNestedToResource(entry,dm){entry._isNested=true;for(var link in entry.value._links){var l=/^[a-f0-9]{8}:.+\/(?!creator)(.+)$/.exec(link);if(l){if(Array.isArray(entry.value[l[1]])){entry.value[l[1]]=entry.value[l[1]].map(function(e){if(e.hasOwnProperty("assetID")){return new Asset(halfred.parse(e),dm)}if(e.hasOwnProperty("_id")){var out=new Entry(halfred.parse(e),dm);out._model=dm.model(entry.value.link(link).name);makeNestedToResource(out,dm);return out}return e})}else{if(entry.value[l[1]].hasOwnProperty("assetID")){entry.value[l[1]]=new Asset(halfred.parse(entry.value[l[1]]),dm)}else if(entry.value[l[1]].hasOwnProperty("_id")){entry.value[l[1]]=new Entry(halfred.parse(entry.value[l[1]]),dm,dm.model(entry.value.link(link).name));makeNestedToResource(entry.value[l[1]],dm)}}}}}Entry.prototype.clone=function(){cleanEntry(this);var e=new Entry(halfred.parse(JSON.parse(JSON.stringify(this.value))),this._dm);if(this._isNested){makeNestedToResource(e,this._dm)}return e};Entry._makeNestedToResource=makeNestedToResource;function uniq(arr){var u={},a=[];for(var i=0,l=arr.length;i<l;++i){if(Object.prototype.hasOwnProperty.call(u,arr[i])){continue}a.push(arr[i]);u[arr[i]]=1}return a}function compact(arr){var a=[];for(var i=0;i<arr.length;i++){if(arr[i]){a.push(arr[i])}}return a}function remove(arr,func){var a=[];for(var i=0;i<arr.length;i++){if(!func.call(this,arr[i])){a.push(arr[i])}}return a}Entry.prototype.getFileUrl=function(field,locale){return this._negotiate(field,false,false,null,locale)};Entry.prototype.getImageUrl=function(field,size,locale){return this._negotiate(field,true,false,size,locale)};Entry.prototype.getImageThumbUrl=function(field,size,locale){return this._negotiate(field,true,true,size,locale)};Entry.prototype._negotiate=function(field,image,thumb,size,requestedLocale){var original=this.value.embeddedArray(this._dm.id+":"+this._model.title+"/"+field+"/asset");if(!original){if(Array.isArray(this.value[field])){return[]}return undefined}var assets=JSON.parse(JSON.stringify(original));var results=assets.map(function(asset){if(requestedLocale){var supportedLocales=new locale.Locales(compact(uniq(asset.files.map(function(elem){return elem.locale}))));var bestLocale=new locale.Locales(requestedLocale).best(supportedLocales).toString();bestLocale=/^([^\.]+)/.exec(bestLocale)[1];var filesWithLocale=asset.files.filter(function(file){return file.locale===bestLocale});if(filesWithLocale&&filesWithLocale.length>0){asset.files=filesWithLocale}}if(!image&&!thumb&&asset.type!=="image"){return asset.files[0].url}var first=asset.files[0];asset.files=remove(asset.files,function(file){return file.resolution===null});if(asset.files.length===0){return first.url}asset.files.sort(function(left,right){var leftMax=Math.max(left.resolution.height,left.resolution.width);var rightMax=Math.max(right.resolution.height,right.resolution.width);if(leftMax<rightMax){return 1}else if(leftMax>rightMax){return-1}else{return 0}});var imageFiles=asset.files.filter(function(file){if(thumb){return file.url.indexOf("_thumb")!==-1}else{return file.url.indexOf("_thumb")===-1}});if(!imageFiles||imageFiles.length===0){imageFiles=asset.files}var largest=imageFiles[0];if(size){imageFiles=imageFiles.filter(function(file){return file.resolution.height>=size||file.resolution.width>=size});imageFiles=imageFiles.slice(-1)}if(imageFiles.length>0){return imageFiles[0].url}else{return largest.url}});if(!Array.isArray(this.value[field])){return results[0]}return results};Entry.prototype.getOriginal=function(field){var original=this.value.embeddedArray(this._dm.id+":"+this._model.title+"/"+field+"/asset");if(!original){throw new Error("ec.datamanager.js cannot find embedded asset for field "+field)}var assets=JSON.parse(JSON.stringify(original));var results=assets.map(function(asset){if(asset.type!=="image"){return asset.files[0]}var first=asset.files[0];asset.files=remove(asset.files,function(file){return file.resolution===null});if(asset.files.length===0){return first}asset.files.sort(function(left,right){var leftMax=Math.max(left.resolution.height,left.resolution.width);var rightMax=Math.max(right.resolution.height,right.resolution.width);if(leftMax<rightMax){return 1}else if(leftMax>rightMax){return-1}else{return 0}});return asset.files[0]});if(!Array.isArray(this.value[field])){return results[0]}return results};module.exports=Entry},{"./Asset":1,"./util":7,halfred:13,locale:20,traverson:74,"traverson-hal":34}],4:[function(require,module,exports){"use strict";var halfred=require("halfred");var request=require("superagent");var traverson=require("traverson");var isReachableLib=require("is-reachable");var Asset=require("./Asset");var Entry=require("./Entry");var util=require("./util");var sizeRegex=/[&\?]size=(\d+)/;var pageRegex=/[&\?]page=(\d+)/;var Model=function(title,metadata,dm){this.id=title;this.title=title;this.metadata=metadata;this._traversal=null;this._dm=dm};Model.prototype.enableCache=function(env,maxCacheAge){return Promise.resolve().then(function(){return this._dm._makeDB(env)}.bind(this)).then(function(db){this._maxAge=maxCacheAge||6e5;this._items=db.getCollection(this.title)||db.addCollection(this.title,{indices:["_id","_entryTitle"]});this._dm._modelCache[this.title]=this;return this._loadData()}.bind(this)).catch(util.errorHandler)};Model.prototype.clearCache=function(){if(!this._maxAge){return Promise.resolve(new Error("Cache not activated."))}return Promise.resolve().then(function(){delete this._maxAge;this._dm._cacheMetaData.removeWhere({title:this.title});this._items.removeDataOnly();delete this._items;return new Promise(function(resolve,reject){this._dm._db.save(function(err){if(err){return reject(err)}return resolve()}.bind(this))}.bind(this))}.bind(this))};Model.prototype.resolve=function(){var model=this;var traversal;return Promise.resolve().then(function(){return util.getP(traverson.from(model._dm.url).jsonHal().withRequestOptions(model._dm._requestOptions()))}).then(function(res){traversal=res[1];return util.checkResponse(res[0])}).then(function(res){var body=JSON.parse(res.body);for(var i=0;i<body.models.length;i++){if(body.models[i].title===model.title){model.metadata=body.models[i];model._dm._rootTraversal=traversal;return Promise.resolve(model)}}return Promise.reject(new Error("ec_sdk_model_not_found"))}).catch(util.errorHandler)};Model.prototype.getSchema=function(method){var model=this;return Promise.resolve().then(function(){if(!method){method="get"}method.toLowerCase();if(["get","put","post"].indexOf(method)===-1){return Promise.reject(new Error("ec_sdk_invalid_method_for_schema"))}return util.superagentEndP(request.get(model._dm.url.replace("/api/","/api/schema/")+"/"+model.title).query({template:method}))}).then(function(res){return util.checkResponse(res)}).then(function(res){return Promise.resolve(res.body)}).catch(util.errorHandler)};Model.prototype.entryList=function(options){if(this._maxAge){return Promise.resolve().then(function(){switch(options&&options.cacheType?options.cacheType:"default"){case"stale":return Promise.resolve(this._items);case"refresh":return this._loadData(true);case"default":default:return this._ensureNotStale()}}.bind(this)).then(function(items){return util.filterCached(items,options)}.bind(this)).then(function(filtered){filtered.entries=filtered.elements.map(function(entry){return new Entry(halfred.parse(entry),this._dm,this)}.bind(this));delete filtered.elements;if(options&&options.cacheType==="stale"){options.cacheType="refresh";filtered.refreshedData=this.entryList(options)}filtered.page=options&&"page"in options?options.page:1;var size;var page;if(options){size=options.size;page=options.page}
if(size*page<filtered.total){options.size=size;options.page=page+1||2;filtered.next=this.entryList(options)}if(size*page-size>0){options.size=size;options.page=page-1||undefined;filtered.prev=this.entryList(options)}if(page&&page>=2){options.size=size;delete options.page;filtered.first=this.entryList(options)}return Promise.resolve(filtered)}.bind(this)).catch(util.errorHandler)}var model=this;return Promise.resolve().then(function(){return model._dm._getTraversal()}).then(function(traversal){var t=traversal.continue().newRequest().follow(model._dm.id+":"+model.title);if(options){t.withTemplateParameters(util.optionsToQueryParameter(options))}t.withRequestOptions(model._dm._requestOptions());return util.getP(t)}).then(function(res){return util.checkResponse(res[0])}).then(function(res){var body=halfred.parse(JSON.parse(res.body));if(body.hasOwnProperty("count")&&body.count===0&&body.hasOwnProperty("total")){return Promise.resolve({entries:[],count:body.count,total:body.total})}var entries=body.embeddedArray(model._dm.id+":"+model.title);var e=[];if(!entries){e.push(new Entry(body,model._dm,model))}else{for(var i=0;i<entries.length;i++){e.push(new Entry(entries[i],model._dm,model))}}var out={entries:e,count:body.count,total:body.total,page:options&&"page"in options?options.page:1};var optionsClone=options?JSON.parse(JSON.stringify(options)):{};var next=body.link("next");if(next){var s=sizeRegex.exec(next.href);var p=pageRegex.exec(next.href);if(s){optionsClone.size=s[1]}else{delete optionsClone.size}if(p){optionsClone.page=p[1]}else{delete options.page}out.next=function(){return model.entryList(this)};out.next=out.next.bind(JSON.parse(JSON.stringify(optionsClone)))}var prev=body.link("prev");if(prev){var s=sizeRegex.exec(prev.href);var p=pageRegex.exec(prev.href);if(s){optionsClone.size=s[1]}else{delete optionsClone.size}if(p){optionsClone.page=p[1]}else{delete optionsClone.page}out.prev=function(){return model.entryList(this)};out.prev=out.prev.bind(JSON.parse(JSON.stringify(optionsClone)))}var first=body.link("first");if(first){var s=sizeRegex.exec(first.href);var p=pageRegex.exec(first.href);if(s){optionsClone.size=s[1]}else{delete optionsClone.size}if(p){optionsClone.page=p[1]}else{delete optionsClone.page}out.first=function(){return model.entryList(this)};out.first=out.first.bind(JSON.parse(JSON.stringify(optionsClone)))}return Promise.resolve(out)}).catch(util.errorHandler)};Model.prototype.entries=function(options){var model=this;if(options&&options.hasOwnProperty("cacheType")&&options.cacheType==="stale"){options.cacheType="default"}return model.entryList(options).then(function(list){return Promise.resolve(list.entries)})};Model.prototype.entry=function(id,levels,fields){var options={};if(typeof id==="string"){options.filter={_id:{exact:id}}}else{options=id;if(id.hasOwnProperty("id")){options.filter={_id:{exact:id.id}};delete options.id}if(id.hasOwnProperty("_id")){options.filter={_id:{exact:id._id}};delete options._id}}if(levels){options.levels=levels}if(fields){options.fields=fields}return this.entries(options).then(function(res){if(!res.length){return Promise.reject(new Error("ec_sdk_no_match_due_to_filter"))}return Promise.resolve(res[0])})};Model.prototype.nestedEntry=function(id,levels,fields){return this.entry(id,levels,fields).then(function(entry){Entry._makeNestedToResource(entry,this._dm);return Promise.resolve(entry)}.bind(this))};Model.prototype.createEntry=function(entry){var model=this;return Promise.resolve().then(function(){return model._dm._getTraversal()}).then(function(traversal){return util.postP(traversal.continue().newRequest().follow(model._dm.id+":"+model.title).withRequestOptions(model._dm._requestOptions({"Content-Type":"application/json"})),entry)}).then(function(res){return util.checkResponse(res[0])}).then(function(res){if(res.statusCode===204){return Promise.resolve(true)}return Promise.resolve(new Entry(halfred.parse(JSON.parse(res.body)),model._dm,model))}).catch(util.errorHandler)};Model.prototype.deleteEntry=function(entryId){var model=this;return Promise.resolve().then(function(){return model._dm._getTraversal()}).then(function(traversal){return util.deleteP(traversal.continue().newRequest().follow(model._dm.id+":"+model.title).withTemplateParameters({_id:entryId}).withRequestOptions(model._dm._requestOptions()))}).then(function(res){return util.checkResponse(res[0])}).then(function(){return Promise.resolve(true)}).catch(util.errorHandler)};Model.prototype._ensureNotStale=function(){var maxAge=(new Date).getTime()-this._maxAge;var metadata=this._dm._cacheMetaData.find({title:this.title})[0];if(!metadata||!metadata.hasOwnProperty("created")){metadata={created:0}}var created=new Date(metadata.created).getTime();if(created>maxAge){return Promise.resolve(this._items)}if(!this._loadDataActivePromise){this._loadDataActivePromise=this._loadData(true)}return this._loadDataActivePromise};Model.prototype._loadData=function(force){return Promise.resolve().then(function(){return this._isReachable("google.de")}.bind(this)).then(function(){if(this._items.data.length>0&&!force){return Promise.resolve(this._items)}return this._load()}.bind(this)).catch(function(error){this._loadDataActivePromise=null;if(error.message==="offline"){if(this._items.data.length>0){console.warn("Network unreachable. Loading cached data for model "+this.title+".");return Promise.resolve(this._items)}return Promise.reject(new Error("Network unreachable. No cached data available for model "+this.title+"."))}return Promise.reject(error)}.bind(this))};Model.prototype._load=function(){return Promise.resolve().then(function(){return this._dm._getTraversal()}.bind(this)).then(function(traversal){return util.getP(traversal.continue().newRequest().follow(this._dm.id+":"+this.title).withRequestOptions(this._dm._requestOptions()).withTemplateParameters({size:0}))}.bind(this)).then(function(res){return util.checkResponse(res[0])}.bind(this)).then(function(res){var body=halfred.parse(JSON.parse(res.body));var entries=body.embeddedResourceArray(this._dm.id+":"+this.title);this._items.removeDataOnly();for(var i=0;i<entries.length;i++){this._items.insert(entries[i].original())}this._dm._cacheMetaData.removeWhere({title:this.title});this._dm._cacheMetaData.insert({title:this.title,etag:res.headers.etag,created:(new Date).toISOString()});return new Promise(function(resolve,reject){this._dm._db.save(function(err){if(err){return reject(err)}this._loadDataActivePromise=null;return resolve(this._items)}.bind(this))}.bind(this))}.bind(this)).catch(function(err){this._loadDataActivePromise=null;return Promise.reject(err)}.bind(this))};Model.prototype._isReachable=function(dests){return new Promise(function(resolve,reject){isReachableLib(dests,function(onBrowserOKOnNodeNull,reachable){if(onBrowserOKOnNodeNull||reachable){return resolve()}return reject(new Error("offline"))})})};module.exports=Model},{"./Asset":1,"./Entry":3,"./util":7,halfred:13,"is-reachable":18,superagent:29,traverson:74}],5:[function(require,module,exports){"use strict";var halfred=require("halfred");var traverson=require("traverson");var util=require("./util");var Tag=function(tag,dm,traversal){this.value=tag;this._dm=dm;this._traversal=traversal};Tag.prototype.save=function(){var tag=this;var traversal;return Promise.resolve().then(function(){return tag._getTraversal()}).then(function(traversal){delete tag.value._curies;delete tag.value._curiesMap;delete tag.value._resolvedCuriesMap;delete tag.value._validation;delete tag.value._original;delete tag.value._embedded;return util.putP(traversal.continue().newRequest().follow("self").withRequestOptions(tag._dm._requestOptions({"Content-Type":"application/json"})),tag.value)}).then(function(res){traversal=res[1];return util.checkResponse(res[0])}).then(function(res){if(res.statusCode===204){return Promise.resolve(true)}tag.value=halfred.parse(JSON.parse(res.body));tag._traversal=traversal;return Promise.resolve(tag)}).catch(util.errorHandler)};Tag.prototype.delete=function(){var tag=this;return Promise.resolve().then(function(){return tag._getTraversal()}).then(function(traversal){return util.deleteP(traversal.continue().newRequest().follow("self").withRequestOptions(tag._dm._requestOptions()))}).then(function(res){return util.checkResponse(res[0])}).then(function(){return Promise.resolve(true)}).catch(util.errorHandler)};Tag.prototype._getTraversal=function(){var tag=this;if(tag._traversal){return Promise.resolve(tag._traversal)}var traversal;return Promise.resolve().then(function(){return util.getP(traverson.from(tag.value.link("self").href).jsonHal().withRequestOptions(tag._dm._requestOptions()))}).then(function(res){traversal=res[1];return util.checkResponse(res[0])}).then(function(){tag._traversal=traversal;return Promise.resolve(tag._traversal)})};module.exports=Tag},{"./util":7,halfred:13,traverson:74}],6:[function(require,module,exports){"use strict";var util=require("./util");var User=function(isAnon,user,dm){this.value=user;this._isAnon=isAnon;this._dm=dm};User.prototype.logout=function(){var user=this;return Promise.resolve().then(function(){if(user._isAnon){user._dm.accessToken=undefined;user._dm._user=undefined;user._dm._rootTraversal=undefined;return Promise.resolve()}return Promise.reject(new Error("ec_sdk_user_not_logged_out"))}).catch(util.errorHandler)};User.prototype.isAnonymous=function(){return this._isAnon};User.prototype.isAnon=User.prototype.isAnonymous;module.exports=User},{"./util":7}],7:[function(require,module,exports){"use strict";var util={};util._dm=null;util.optionsToQueryParameter=function(options){var query={};if(options&&options.hasOwnProperty("size")){query.size=options.size}if(options&&options.hasOwnProperty("page")){query.page=options.page}if(options&&options.hasOwnProperty("sort")&&Array.isArray(options.sort)){query.sort=options.sort.join(",")}if(options&&options.hasOwnProperty("levels")){query._levels=options.levels}if(options&&options.hasOwnProperty("fields")&&Array.isArray(options.fields)){query._fields=options.fields.join(",")}if(options&&options.hasOwnProperty("filter")){for(var key in options.filter){if(options.filter.hasOwnProperty(key)){var value=options.filter[key];if(value.hasOwnProperty("exact")){query[key]=value.exact}if(value.hasOwnProperty("search")){query[key+"~"]=value.search}if(value.hasOwnProperty("from")){query[key+"From"]=value.from}if(value.hasOwnProperty("to")){query[key+"To"]=value.to}if(value.hasOwnProperty("any")&&Array.isArray(value.any)){query[key]=value.any.join(",")}if(value.hasOwnProperty("all")&&Array.isArray(value.all)){query[key]=value.all.join("+")}}}}return query};util.filterCached=function(items,options){var chain=items.chain();if(options&&options.hasOwnProperty("filter")){for(var field in options.filter){if(options.filter.hasOwnProperty(field)){var fieldFilter=options.filter[field];for(var filter in fieldFilter){if(fieldFilter.hasOwnProperty(filter)){var f={};if(filter==="exact"){f[field]=fieldFilter[filter]}if(filter==="search"){f[field]={$contains:fieldFilter[filter]}}if(filter==="from"){f[field]={$gte:fieldFilter[filter]}}if(filter==="to"){f[field]={$lte:fieldFilter[filter]}}chain=chain.find(f)}}}}}if(options&&options.hasOwnProperty("sort")&&Array.isArray(options.sort)){var sort=[];for(var i=0;i<options.sort.length;i++){if(options.sort[i].indexOf("-")===0){sort.push([options.sort[i].slice(1),true])}else if(options.sort[i].indexOf("+")===0){sort.push(options.sort[i].slice(1))}else{sort.push(options.sort[i])}}chain=chain.compoundsort(sort)}var out={};out.total=chain.copy().data().length;chain=chain.copy();if(options&&options.hasOwnProperty("size")&&options.size===0){options.size=Number.MAX_VALUE}if(options&&options.hasOwnProperty("page")){chain=chain.offset(options.page*(options.size||10)-(options.size||10))}if(options&&options.hasOwnProperty("size")){chain=chain.limit(options.size)}out.elements=chain.data();out.count=out.elements.length;return Promise.resolve(out)};util.checkResponse=function(res){if(res.statusCode>=200&&res.statusCode<=299){return Promise.resolve(res)}var errorMessage;try{errorMessage=JSON.parse(res.body)}catch(parsingError){errorMessage=res.body}return Promise.reject(errorMessage)};util.getP=function(t){return new Promise(function(resolve,reject){t.get(function(err,res,traversal){if(err){return reject(err)}return resolve([res,traversal])})})};util.getUrlP=function(t){return new Promise(function(resolve,reject){t.getUrl(function(err,res,traversal){if(err){return reject(err)}return resolve([res,traversal])})})};util.postP=function(t,body){return new Promise(function(resolve,reject){t.post(body,function(err,res,traversal){if(err){return reject(err)}return resolve([res,traversal])})})};util.putP=function(t,body){return new Promise(function(resolve,reject){t.put(body,function(err,res,traversal){if(err){return reject(err)}return resolve([res,traversal])})})};util.deleteP=function(t){return new Promise(function(resolve,reject){t.delete(function(err,res,traversal){if(err){return reject(err)}return resolve([res,traversal])})})};util.superagentEndP=function(r){return new Promise(function(resolve,reject){r.end(function(err,res){if(err){return reject(err)}return resolve(res)})})};util.errorHandler=function(err){if(util._dm.hasOwnProperty("errorHandler")&&util._dm.errorHandler){util._dm.errorHandler(err)}return Promise.reject(err)};module.exports=util},{}],8:[function(require,module,exports){"use strict";module.exports=function(val){if(val===null||val===undefined){return[]}return Array.isArray(val)?val:[val]}},{}],9:[function(require,module,exports){},{}],10:[function(require,module,exports){if(typeof module!=="undefined"){module.exports=Emitter}function Emitter(obj){if(obj)return mixin(obj)}function mixin(obj){for(var key in Emitter.prototype){obj[key]=Emitter.prototype[key]}return obj}Emitter.prototype.on=Emitter.prototype.addEventListener=function(event,fn){this._callbacks=this._callbacks||{};(this._callbacks["$"+event]=this._callbacks["$"+event]||[]).push(fn);return this};Emitter.prototype.once=function(event,fn){function on(){this.off(event,on);fn.apply(this,arguments)}on.fn=fn;this.on(event,on);return this};Emitter.prototype.off=Emitter.prototype.removeListener=Emitter.prototype.removeAllListeners=Emitter.prototype.removeEventListener=function(event,fn){this._callbacks=this._callbacks||{};if(0==arguments.length){this._callbacks={};return this}var callbacks=this._callbacks["$"+event];if(!callbacks)return this;if(1==arguments.length){delete this._callbacks["$"+event];return this}var cb;for(var i=0;i<callbacks.length;i++){cb=callbacks[i];if(cb===fn||cb.fn===fn){callbacks.splice(i,1);break}}return this};Emitter.prototype.emit=function(event){this._callbacks=this._callbacks||{};var args=[].slice.call(arguments,1),callbacks=this._callbacks["$"+event];if(callbacks){callbacks=callbacks.slice(0);for(var i=0,len=callbacks.length;i<len;++i){callbacks[i].apply(this,args)}}return this};Emitter.prototype.listeners=function(event){this._callbacks=this._callbacks||{};return this._callbacks["$"+event]||[]};Emitter.prototype.hasListeners=function(event){return!!this.listeners(event).length}},{}],11:[function(require,module,exports){"use strict";var onetime=require("onetime");var setImmediateShim=require("set-immediate-shim");module.exports=function(arr,next,cb){var failed=false;var count=0;cb=cb||function(){};if(!Array.isArray(arr)){throw new TypeError("First argument must be an array")}if(typeof next!=="function"){throw new TypeError("Second argument must be a function")}var len=arr.length;if(!len){cb();return}function callback(err){if(failed){return}if(err!==undefined&&err!==null){failed=true;cb(err);return}if(++count===len){cb();return}}for(var i=0;i<len;i++){setImmediateShim(next,arr[i],i,onetime(callback,true))}}},{onetime:23,"set-immediate-shim":26}],12:[function(require,module,exports){(function(process,global){(function(global,factory){typeof exports==="object"&&typeof module!=="undefined"?module.exports=factory():typeof define==="function"&&define.amd?define(factory):global.ES6Promise=factory()})(this,function(){"use strict";function objectOrFunction(x){var type=typeof x;return x!==null&&(type==="object"||type==="function")}function isFunction(x){return typeof x==="function"}var _isArray=undefined;if(Array.isArray){_isArray=Array.isArray}else{_isArray=function(x){return Object.prototype.toString.call(x)==="[object Array]"}}var isArray=_isArray;var len=0;var vertxNext=undefined;var customSchedulerFn=undefined;var asap=function asap(callback,arg){queue[len]=callback;queue[len+1]=arg;len+=2;if(len===2){if(customSchedulerFn){customSchedulerFn(flush)}else{scheduleFlush()}}};function setScheduler(scheduleFn){customSchedulerFn=scheduleFn}function setAsap(asapFn){asap=asapFn}var browserWindow=typeof window!=="undefined"?window:undefined;var browserGlobal=browserWindow||{};var BrowserMutationObserver=browserGlobal.MutationObserver||browserGlobal.WebKitMutationObserver;var isNode=typeof self==="undefined"&&typeof process!=="undefined"&&{}.toString.call(process)==="[object process]";var isWorker=typeof Uint8ClampedArray!=="undefined"&&typeof importScripts!=="undefined"&&typeof MessageChannel!=="undefined";function useNextTick(){return function(){return process.nextTick(flush)}}function useVertxTimer(){if(typeof vertxNext!=="undefined"){return function(){vertxNext(flush)}}return useSetTimeout()}function useMutationObserver(){var iterations=0;var observer=new BrowserMutationObserver(flush);var node=document.createTextNode("");observer.observe(node,{characterData:true});return function(){node.data=iterations=++iterations%2}}function useMessageChannel(){var channel=new MessageChannel;channel.port1.onmessage=flush;return function(){return channel.port2.postMessage(0)}}function useSetTimeout(){var globalSetTimeout=setTimeout;return function(){return globalSetTimeout(flush,1)}}var queue=new Array(1e3);function flush(){for(var i=0;i<len;i+=2){var callback=queue[i];var arg=queue[i+1];callback(arg);queue[i]=undefined;queue[i+1]=undefined}len=0}function attemptVertx(){try{var r=require;var vertx=r("vertx");vertxNext=vertx.runOnLoop||vertx.runOnContext;return useVertxTimer()}catch(e){return useSetTimeout()}}var scheduleFlush=undefined;if(isNode){scheduleFlush=useNextTick()}else if(BrowserMutationObserver){scheduleFlush=useMutationObserver()}else if(isWorker){scheduleFlush=useMessageChannel()}else if(browserWindow===undefined&&typeof require==="function"){scheduleFlush=attemptVertx()}else{scheduleFlush=useSetTimeout()}function then(onFulfillment,onRejection){var _arguments=arguments;var parent=this;var child=new this.constructor(noop);if(child[PROMISE_ID]===undefined){makePromise(child)}var _state=parent._state;if(_state){(function(){var callback=_arguments[_state-1];asap(function(){return invokeCallback(_state,child,callback,parent._result)})})()}else{subscribe(parent,child,onFulfillment,onRejection)}return child}function resolve$1(object){var Constructor=this;if(object&&typeof object==="object"&&object.constructor===Constructor){return object}var promise=new Constructor(noop);resolve(promise,object);return promise}var PROMISE_ID=Math.random().toString(36).substring(16);function noop(){}var PENDING=void 0;var FULFILLED=1;var REJECTED=2;var GET_THEN_ERROR=new ErrorObject;function selfFulfillment(){return new TypeError("You cannot resolve a promise with itself")}function cannotReturnOwn(){return new TypeError("A promises callback cannot return that same promise.")}function getThen(promise){try{return promise.then}catch(error){GET_THEN_ERROR.error=error;return GET_THEN_ERROR}}function tryThen(then$$1,value,fulfillmentHandler,rejectionHandler){try{then$$1.call(value,fulfillmentHandler,rejectionHandler)}catch(e){return e}}function handleForeignThenable(promise,thenable,then$$1){asap(function(promise){var sealed=false;var error=tryThen(then$$1,thenable,function(value){if(sealed){return}sealed=true;if(thenable!==value){resolve(promise,value)}else{fulfill(promise,value)}},function(reason){if(sealed){return}sealed=true;reject(promise,reason)},"Settle: "+(promise._label||" unknown promise"));if(!sealed&&error){sealed=true;reject(promise,error)}},promise)}function handleOwnThenable(promise,thenable){if(thenable._state===FULFILLED){fulfill(promise,thenable._result)}else if(thenable._state===REJECTED){reject(promise,thenable._result)}else{subscribe(thenable,undefined,function(value){return resolve(promise,value)},function(reason){return reject(promise,reason)})}}function handleMaybeThenable(promise,maybeThenable,then$$1){if(maybeThenable.constructor===promise.constructor&&then$$1===then&&maybeThenable.constructor.resolve===resolve$1){handleOwnThenable(promise,maybeThenable)}else{if(then$$1===GET_THEN_ERROR){reject(promise,GET_THEN_ERROR.error);GET_THEN_ERROR.error=null}else if(then$$1===undefined){fulfill(promise,maybeThenable)}else if(isFunction(then$$1)){handleForeignThenable(promise,maybeThenable,then$$1)}else{fulfill(promise,maybeThenable)}}}function resolve(promise,value){if(promise===value){reject(promise,selfFulfillment())}else if(objectOrFunction(value)){handleMaybeThenable(promise,value,getThen(value))}else{fulfill(promise,value)}}function publishRejection(promise){if(promise._onerror){promise._onerror(promise._result)}publish(promise)}function fulfill(promise,value){if(promise._state!==PENDING){return}promise._result=value;promise._state=FULFILLED;if(promise._subscribers.length!==0){asap(publish,promise)}}function reject(promise,reason){if(promise._state!==PENDING){return}promise._state=REJECTED;promise._result=reason;asap(publishRejection,promise)}function subscribe(parent,child,onFulfillment,onRejection){var _subscribers=parent._subscribers;var length=_subscribers.length;parent._onerror=null;_subscribers[length]=child;_subscribers[length+FULFILLED]=onFulfillment;_subscribers[length+REJECTED]=onRejection;if(length===0&&parent._state){asap(publish,parent)}}function publish(promise){var subscribers=promise._subscribers;var settled=promise._state;if(subscribers.length===0){return}var child=undefined,callback=undefined,detail=promise._result;for(var i=0;i<subscribers.length;i+=3){child=subscribers[i];callback=subscribers[i+settled];if(child){invokeCallback(settled,child,callback,detail)}else{callback(detail)}}promise._subscribers.length=0}function ErrorObject(){this.error=null}var TRY_CATCH_ERROR=new ErrorObject;function tryCatch(callback,detail){try{return callback(detail)}catch(e){TRY_CATCH_ERROR.error=e;return TRY_CATCH_ERROR}}function invokeCallback(settled,promise,callback,detail){var hasCallback=isFunction(callback),value=undefined,error=undefined,succeeded=undefined,failed=undefined;if(hasCallback){value=tryCatch(callback,detail);if(value===TRY_CATCH_ERROR){failed=true;error=value.error;value.error=null}else{succeeded=true}if(promise===value){reject(promise,cannotReturnOwn());return}}else{value=detail;succeeded=true}if(promise._state!==PENDING){}else if(hasCallback&&succeeded){resolve(promise,value)}else if(failed){reject(promise,error)}else if(settled===FULFILLED){fulfill(promise,value)}else if(settled===REJECTED){reject(promise,value)}}function initializePromise(promise,resolver){try{resolver(function resolvePromise(value){resolve(promise,value)},function rejectPromise(reason){reject(promise,reason)})}catch(e){reject(promise,e)}}var id=0;function nextId(){return id++}function makePromise(promise){promise[PROMISE_ID]=id++;promise._state=undefined;promise._result=undefined;promise._subscribers=[]}function Enumerator$1(Constructor,input){this._instanceConstructor=Constructor;this.promise=new Constructor(noop);if(!this.promise[PROMISE_ID]){makePromise(this.promise)}if(isArray(input)){this.length=input.length;this._remaining=input.length;this._result=new Array(this.length);if(this.length===0){fulfill(this.promise,this._result)}else{this.length=this.length||0;this._enumerate(input);if(this._remaining===0){fulfill(this.promise,this._result)}}}else{reject(this.promise,validationError())}}function validationError(){return new Error("Array Methods must be provided an Array")}Enumerator$1.prototype._enumerate=function(input){for(var i=0;this._state===PENDING&&i<input.length;i++){this._eachEntry(input[i],i)}};Enumerator$1.prototype._eachEntry=function(entry,i){var c=this._instanceConstructor;var resolve$$1=c.resolve;if(resolve$$1===resolve$1){var _then=getThen(entry);if(_then===then&&entry._state!==PENDING){this._settledAt(entry._state,i,entry._result)}else if(typeof _then!=="function"){this._remaining--;this._result[i]=entry}else if(c===Promise$2){var promise=new c(noop);handleMaybeThenable(promise,entry,_then);this._willSettleAt(promise,i)}else{this._willSettleAt(new c(function(resolve$$1){return resolve$$1(entry)}),i)}}else{this._willSettleAt(resolve$$1(entry),i)}};Enumerator$1.prototype._settledAt=function(state,i,value){var promise=this.promise;if(promise._state===PENDING){this._remaining--;if(state===REJECTED){reject(promise,value)}else{this._result[i]=value}}if(this._remaining===0){fulfill(promise,this._result)}};Enumerator$1.prototype._willSettleAt=function(promise,i){var enumerator=this;subscribe(promise,undefined,function(value){return enumerator._settledAt(FULFILLED,i,value)},function(reason){return enumerator._settledAt(REJECTED,i,reason)})};function all$1(entries){return new Enumerator$1(this,entries).promise}function race$1(entries){var Constructor=this;if(!isArray(entries)){return new Constructor(function(_,reject){return reject(new TypeError("You must pass an array to race."))})}else{return new Constructor(function(resolve,reject){var length=entries.length;for(var i=0;i<length;i++){Constructor.resolve(entries[i]).then(resolve,reject)}})}}function reject$1(reason){var Constructor=this;var promise=new Constructor(noop);reject(promise,reason);return promise}function needsResolver(){throw new TypeError("You must pass a resolver function as the first argument to the promise constructor")}function needsNew(){throw new TypeError("Failed to construct 'Promise': Please use the 'new' operator, this object constructor cannot be called as a function.")}function Promise$2(resolver){this[PROMISE_ID]=nextId();this._result=this._state=undefined;this._subscribers=[];if(noop!==resolver){typeof resolver!=="function"&&needsResolver();this instanceof Promise$2?initializePromise(this,resolver):needsNew()}}Promise$2.all=all$1;Promise$2.race=race$1;Promise$2.resolve=resolve$1;Promise$2.reject=reject$1;Promise$2._setScheduler=setScheduler;Promise$2._setAsap=setAsap;Promise$2._asap=asap;Promise$2.prototype={constructor:Promise$2,then:then,catch:function _catch(onRejection){return this.then(null,onRejection)}};function polyfill$1(){var local=undefined;if(typeof global!=="undefined"){local=global}else if(typeof self!=="undefined"){local=self}else{try{local=Function("return this")()}catch(e){throw new Error("polyfill failed because global object is unavailable in this environment")}}var P=local.Promise;if(P){var promiseToString=null;try{promiseToString=Object.prototype.toString.call(P.resolve())}catch(e){}if(promiseToString==="[object Promise]"&&!P.cast){return}}local.Promise=Promise$2}Promise$2.polyfill=polyfill$1;Promise$2.Promise=Promise$2;return Promise$2})}).call(this,require("_process"),typeof global!=="undefined"?global:typeof self!=="undefined"?self:typeof window!=="undefined"?window:{})},{_process:24}],13:[function(require,module,exports){var Parser=require("./lib/parser"),Resource=require("./lib/resource"),validationFlag=false;module.exports={parse:function(unparsed){return(new Parser).parse(unparsed,validationFlag)},enableValidation:function(flag){validationFlag=flag!=null?flag:true},disableValidation:function(){validationFlag=false},Resource:Resource}},{"./lib/parser":15,"./lib/resource":16}],14:[function(require,module,exports){"use strict";function ImmutableStack(){if(arguments.length>=1){this._array=arguments[0]}else{this._array=[]}}ImmutableStack.prototype.array=function(){return this._array};ImmutableStack.prototype.isEmpty=function(array){return this._array.length===0};ImmutableStack.prototype.push=function(element){var array=this._array.slice(0);array.push(element);return new ImmutableStack(array)};ImmutableStack.prototype.pop=function(){var array=this._array.slice(0,this._array.length-1);return new ImmutableStack(array)};ImmutableStack.prototype.peek=function(){if(this.isEmpty()){throw new Error("can't peek on empty stack")}return this._array[this._array.length-1]};module.exports=ImmutableStack},{}],15:[function(require,module,exports){"use strict";var Resource=require("./resource"),Stack=require("./immutable_stack");var linkSpec={href:{required:true,defaultValue:null},templated:{required:false,defaultValue:false},type:{required:false,defaultValue:null},deprecation:{required:false,defaultValue:null},name:{required:false,defaultValue:null},profile:{required:false,defaultValue:null},title:{required:false,defaultValue:null},hreflang:{required:false,defaultValue:null}};function Parser(){}Parser.prototype.parse=function parse(unparsed,validationFlag){var validation=validationFlag?[]:null;return _parse(unparsed,validation,new Stack)};function _parse(unparsed,validation,path){if(unparsed==null){return unparsed}var allLinkArrays=parseLinks(unparsed._links,validation,path.push("_links"));var curies=parseCuries(allLinkArrays);var allEmbeddedArrays=parseEmbeddedResourcess(unparsed._embedded,validation,path.push("_embedded"));var resource=new Resource(allLinkArrays,curies,allEmbeddedArrays,validation);copyNonHalProperties(unparsed,resource);resource._original=unparsed;return resource}function parseLinks(links,validation,path){links=parseHalProperty(links,parseLink,validation,path);if(links==null||links.self==null){reportValidationIssue("Resource does not have a self link",validation,path)}return links}function parseCuries(linkArrays){if(linkArrays){return linkArrays.curies}else{return[]}}function parseEmbeddedResourcess(original,parentValidation,path){var embedded=parseHalProperty(original,identity,parentValidation,path);if(embedded==null){return embedded}Object.keys(embedded).forEach(function(key){embedded[key]=embedded[key].map(function(embeddedElement){var childValidation=parentValidation!=null?[]:null;var embeddedResource=_parse(embeddedElement,childValidation,path.push(key));embeddedResource._original=embeddedElement;return embeddedResource})});return embedded}function copyNonHalProperties(unparsed,resource){Object.keys(unparsed).forEach(function(key){if(key!=="_links"&&key!=="_embedded"){resource[key]=unparsed[key]}})}function parseHalProperty(property,processingFunction,validation,path){if(property==null){return property}var copy={};Object.keys(property).forEach(function(key){copy[key]=arrayfy(key,property[key],processingFunction,validation,path)});return copy}function arrayfy(key,object,fn,validation,path){if(isArray(object)){return object.map(function(element){return fn(key,element,validation,path)})}else{return[fn(key,object,validation,path)]}}function parseLink(linkKey,link,validation,path){if(!isObject(link)){throw new Error("Link object is not an actual object: "+link+" ["+typeof link+"]")}var copy=shallowCopy(link);Object.keys(linkSpec).forEach(function(key){if(copy[key]==null){if(linkSpec[key].required){reportValidationIssue("Link misses required property "+key+".",validation,path.push(linkKey))}if(linkSpec[key].defaultValue!=null){copy[key]=linkSpec[key].defaultValue}}});if(copy.deprecation){log("Warning: Link "+pathToString(path.push(linkKey))+" is deprecated, see "+copy.deprecation)}if(copy.templated!==true&&copy.templated!==false){copy.templated=false}if(!validation){return copy}if(copy.href&&copy.href.indexOf("{")>=0&&!copy.templated){reportValidationIssue("Link seems to be an URI template "+'but its "templated" property is not set to true.',validation,path.push(linkKey))}return copy}function isArray(o){return Object.prototype.toString.call(o)==="[object Array]"}function isObject(o){return typeof o==="object"}
function identity(key,object){return object}function reportValidationIssue(message,validation,path){if(validation){validation.push({path:pathToString(path),message:message})}}function log(message){if(typeof console!=="undefined"&&typeof console.log==="function"){console.log(message)}}function shallowCopy(source){var copy={};Object.keys(source).forEach(function(key){copy[key]=source[key]});return copy}function pathToString(path){var s="$.";for(var i=0;i<path.array().length;i++){s+=path.array()[i]+"."}s=s.substring(0,s.length-1);return s}module.exports=Parser},{"./immutable_stack":14,"./resource":16}],16:[function(require,module,exports){"use strict";function Resource(links,curies,embedded,validationIssues){var self=this;this._links=links||{};this._initCuries(curies);this._embedded=embedded||{};this._validation=validationIssues||[]}Resource.prototype._initCuries=function(curies){this._curiesMap={};if(!curies){this._curies=[]}else{this._curies=curies;for(var i=0;i<this._curies.length;i++){var curie=this._curies[i];this._curiesMap[curie.name]=curie}}this._preResolveCuries()};Resource.prototype._preResolveCuries=function(){this._resolvedCuriesMap={};for(var i=0;i<this._curies.length;i++){var curie=this._curies[i];if(!curie.name){continue}for(var rel in this._links){if(rel!=="curies"){this._preResolveCurie(curie,rel)}}}};Resource.prototype._preResolveCurie=function(curie,rel){var link=this._links[rel];var prefixAndReference=rel.split(/:(.+)/);var candidate=prefixAndReference[0];if(curie.name===candidate){if(curie.templated&&prefixAndReference.length>=1){var href=curie.href.replace(/(.*){(.*)}(.*)/,"$1"+prefixAndReference[1]+"$3");this._resolvedCuriesMap[href]=rel}else{this._resolvedCuriesMap[curie.href]=rel}}};Resource.prototype.allLinkArrays=function(){return this._links};Resource.prototype.linkArray=function(key){return propertyArray(this._links,key)};Resource.prototype.link=function(key,index){return elementOfPropertyArray(this._links,key,index)};Resource.prototype.hasCuries=function(key){return this._curies.length>0};Resource.prototype.curieArray=function(key){return this._curies};Resource.prototype.curie=function(name){return this._curiesMap[name]};Resource.prototype.reverseResolveCurie=function(fullUrl){return this._resolvedCuriesMap[fullUrl]};Resource.prototype.allEmbeddedResourceArrays=function(){return this._embedded};Resource.prototype.embeddedResourceArray=function(key){return propertyArray(this._embedded,key)};Resource.prototype.embeddedResource=function(key,index){return elementOfPropertyArray(this._embedded,key,index)};Resource.prototype.original=function(){return this._original};function propertyArray(object,key){return object!=null?object[key]:null}function elementOfPropertyArray(object,key,index){index=index||0;var array=propertyArray(object,key);if(array!=null&&array.length>=1){return array[index]}return null}Resource.prototype.validationIssues=function(){return this._validation};Resource.prototype.allLinks=Resource.prototype.allLinkArrays;Resource.prototype.allEmbeddedArrays=Resource.prototype.allEmbeddedResources=Resource.prototype.allEmbeddedResourceArrays;Resource.prototype.embeddedArray=Resource.prototype.embeddedResourceArray;Resource.prototype.embedded=Resource.prototype.embeddedResource;Resource.prototype.validation=Resource.prototype.validationIssues;module.exports=Resource},{}],17:[function(require,module,exports){var indexOf=[].indexOf;module.exports=function(arr,obj){if(indexOf)return arr.indexOf(obj);for(var i=0;i<arr.length;++i){if(arr[i]===obj)return i}return-1}},{}],18:[function(require,module,exports){"use strict";var eachAsync=require("each-async");var onetime=require("onetime");var arrify=require("arrify");module.exports=function(hosts,cb){cb=onetime(cb);eachAsync(arrify(hosts),function(host,i,next){var img=new Image;img.onload=function(){cb(true);next(new Error)};img.onerror=function(){next()};img.src="//"+host+"/favicon.ico?"+Date.now()},function(){cb(false)})}},{arrify:8,"each-async":11,onetime:23}],19:[function(require,module,exports){var module;(function(glbl,require){"use strict";var isNode=module&&!!module.exports;var allowedResultTypes=["value","path","pointer","parent","parentProperty","all"];if(!Array.prototype.includes){Array.prototype.includes=function(item){return this.indexOf(item)>-1}}if(!String.prototype.includes){String.prototype.includes=function(item){return this.indexOf(item)>-1}}var moveToAnotherArray=function(source,target,conditionCb){for(var i=0,kl=source.length;i<kl;i++){var key=source[i];if(conditionCb(key)){target.push(source.splice(i--,1)[0])}}};var vm=isNode?require("vm"):{runInNewContext:function(expr,context){var keys=Object.keys(context);var funcs=[];moveToAnotherArray(keys,funcs,function(key){return typeof context[key]==="function"});var code=funcs.reduce(function(s,func){return"var "+func+"="+context[func].toString()+";"+s},"");code+=keys.reduce(function(s,vr){return"var "+vr+"="+JSON.stringify(context[vr]).replace(/\u2028|\u2029/g,function(m){return"\\u202"+(m==="\u2028"?"8":"9")})+";"+s},expr);return eval(code)}};function push(arr,elem){arr=arr.slice();arr.push(elem);return arr}function unshift(elem,arr){arr=arr.slice();arr.unshift(elem);return arr}function NewError(value){this.avoidNew=true;this.value=value;this.message='JSONPath should not be called with "new" (it prevents return of (unwrapped) scalar values)'}function JSONPath(opts,expr,obj,callback,otherTypeCallback){if(!(this instanceof JSONPath)){try{return new JSONPath(opts,expr,obj,callback,otherTypeCallback)}catch(e){if(!e.avoidNew){throw e}return e.value}}if(typeof opts==="string"){otherTypeCallback=callback;callback=obj;obj=expr;expr=opts;opts={}}opts=opts||{};var objArgs=opts.hasOwnProperty("json")&&opts.hasOwnProperty("path");this.json=opts.json||obj;this.path=opts.path||expr;this.resultType=opts.resultType&&opts.resultType.toLowerCase()||"value";this.flatten=opts.flatten||false;this.wrap=opts.hasOwnProperty("wrap")?opts.wrap:true;this.sandbox=opts.sandbox||{};this.preventEval=opts.preventEval||false;this.parent=opts.parent||null;this.parentProperty=opts.parentProperty||null;this.callback=opts.callback||callback||null;this.otherTypeCallback=opts.otherTypeCallback||otherTypeCallback||function(){throw new Error("You must supply an otherTypeCallback callback option with the @other() operator.")};if(opts.autostart!==false){var ret=this.evaluate({path:objArgs?opts.path:expr,json:objArgs?opts.json:obj});if(!ret||typeof ret!=="object"){throw new NewError(ret)}return ret}}JSONPath.prototype.evaluate=function(expr,json,callback,otherTypeCallback){var self=this,flatten=this.flatten,wrap=this.wrap,currParent=this.parent,currParentProperty=this.parentProperty;this.currResultType=this.resultType;this.currPreventEval=this.preventEval;this.currSandbox=this.sandbox;callback=callback||this.callback;this.currOtherTypeCallback=otherTypeCallback||this.otherTypeCallback;json=json||this.json;expr=expr||this.path;if(expr&&typeof expr==="object"){if(!expr.path){throw new Error('You must supply a "path" property when providing an object argument to JSONPath.evaluate().')}json=expr.hasOwnProperty("json")?expr.json:json;flatten=expr.hasOwnProperty("flatten")?expr.flatten:flatten;this.currResultType=expr.hasOwnProperty("resultType")?expr.resultType:this.currResultType;this.currSandbox=expr.hasOwnProperty("sandbox")?expr.sandbox:this.currSandbox;wrap=expr.hasOwnProperty("wrap")?expr.wrap:wrap;this.currPreventEval=expr.hasOwnProperty("preventEval")?expr.preventEval:this.currPreventEval;callback=expr.hasOwnProperty("callback")?expr.callback:callback;this.currOtherTypeCallback=expr.hasOwnProperty("otherTypeCallback")?expr.otherTypeCallback:this.currOtherTypeCallback;currParent=expr.hasOwnProperty("parent")?expr.parent:currParent;currParentProperty=expr.hasOwnProperty("parentProperty")?expr.parentProperty:currParentProperty;expr=expr.path}currParent=currParent||null;currParentProperty=currParentProperty||null;if(Array.isArray(expr)){expr=JSONPath.toPathString(expr)}if(!expr||!json||!allowedResultTypes.includes(this.currResultType)){return}this._obj=json;var exprList=JSONPath.toPathArray(expr);if(exprList[0]==="$"&&exprList.length>1){exprList.shift()}this._hasParentSelector=null;var result=this._trace(exprList,json,["$"],currParent,currParentProperty,callback);result=result.filter(function(ea){return ea&&!ea.isParentSelector});if(!result.length){return wrap?[]:undefined}if(result.length===1&&!wrap&&!Array.isArray(result[0].value)){return this._getPreferredOutput(result[0])}return result.reduce(function(result,ea){var valOrPath=self._getPreferredOutput(ea);if(flatten&&Array.isArray(valOrPath)){result=result.concat(valOrPath)}else{result.push(valOrPath)}return result},[])};JSONPath.prototype._getPreferredOutput=function(ea){var resultType=this.currResultType;switch(resultType){case"all":ea.path=typeof ea.path==="string"?ea.path:JSONPath.toPathString(ea.path);return ea;case"value":case"parent":case"parentProperty":return ea[resultType];case"path":return JSONPath.toPathString(ea[resultType]);case"pointer":return JSONPath.toPointer(ea.path)}};JSONPath.prototype._handleCallback=function(fullRetObj,callback,type){if(callback){var preferredOutput=this._getPreferredOutput(fullRetObj);fullRetObj.path=typeof fullRetObj.path==="string"?fullRetObj.path:JSONPath.toPathString(fullRetObj.path);callback(preferredOutput,type,fullRetObj)}};JSONPath.prototype._trace=function(expr,val,path,parent,parentPropName,callback,literalPriority){var retObj,self=this;if(!expr.length){retObj={path:path,value:val,parent:parent,parentProperty:parentPropName};this._handleCallback(retObj,callback,"value");return retObj}var loc=expr[0],x=expr.slice(1);var ret=[];function retPush(elem){ret.push(elem)}function addRet(elems){if(Array.isArray(elems)){elems.forEach(retPush)}else{ret.push(elems)}}if((typeof loc!=="string"||literalPriority)&&val&&Object.prototype.hasOwnProperty.call(val,loc)){addRet(this._trace(x,val[loc],push(path,loc),val,loc,callback))}else if(loc==="*"){this._walk(loc,x,val,path,parent,parentPropName,callback,function(m,l,x,v,p,par,pr,cb){addRet(self._trace(unshift(m,x),v,p,par,pr,cb,true))})}else if(loc===".."){addRet(this._trace(x,val,path,parent,parentPropName,callback));this._walk(loc,x,val,path,parent,parentPropName,callback,function(m,l,x,v,p,par,pr,cb){if(typeof v[m]==="object"){addRet(self._trace(unshift(l,x),v[m],push(p,m),v,m,cb))}})}else if(loc==="^"){this._hasParentSelector=true;return path.length?{path:path.slice(0,-1),expr:x,isParentSelector:true}:[]}else if(loc==="~"){retObj={path:push(path,loc),value:parentPropName,parent:parent,parentProperty:null};this._handleCallback(retObj,callback,"property");return retObj}else if(loc==="$"){addRet(this._trace(x,val,path,null,null,callback))}else if(/^(-?[0-9]*):(-?[0-9]*):?([0-9]*)$/.test(loc)){addRet(this._slice(loc,x,val,path,parent,parentPropName,callback))}else if(loc.indexOf("?(")===0){if(this.currPreventEval){throw new Error("Eval [?(expr)] prevented in JSONPath expression.")}this._walk(loc,x,val,path,parent,parentPropName,callback,function(m,l,x,v,p,par,pr,cb){if(self._eval(l.replace(/^\?\((.*?)\)$/,"$1"),v[m],m,p,par,pr)){addRet(self._trace(unshift(m,x),v,p,par,pr,cb))}})}else if(loc[0]==="("){if(this.currPreventEval){throw new Error("Eval [(expr)] prevented in JSONPath expression.")}addRet(this._trace(unshift(this._eval(loc,val,path[path.length-1],path.slice(0,-1),parent,parentPropName),x),val,path,parent,parentPropName,callback))}else if(loc[0]==="@"){var addType=false;var valueType=loc.slice(1,-2);switch(valueType){case"scalar":if(!val||!["object","function"].includes(typeof val)){addType=true}break;case"boolean":case"string":case"undefined":case"function":if(typeof val===valueType){addType=true}break;case"number":if(typeof val===valueType&&isFinite(val)){addType=true}break;case"nonFinite":if(typeof val==="number"&&!isFinite(val)){addType=true}break;case"object":if(val&&typeof val===valueType){addType=true}break;case"array":if(Array.isArray(val)){addType=true}break;case"other":addType=this.currOtherTypeCallback(val,path,parent,parentPropName);break;case"integer":if(val===+val&&isFinite(val)&&!(val%1)){addType=true}break;case"null":if(val===null){addType=true}break}if(addType){retObj={path:path,value:val,parent:parent,parentProperty:parentPropName};this._handleCallback(retObj,callback,"value");return retObj}}else if(loc[0]==="`"&&val&&Object.prototype.hasOwnProperty.call(val,loc.slice(1))){var locProp=loc.slice(1);addRet(this._trace(x,val[locProp],push(path,locProp),val,locProp,callback,true))}else if(loc.includes(",")){var parts,i;for(parts=loc.split(","),i=0;i<parts.length;i++){addRet(this._trace(unshift(parts[i],x),val,path,parent,parentPropName,callback))}}else if(!literalPriority&&val&&Object.prototype.hasOwnProperty.call(val,loc)){addRet(this._trace(x,val[loc],push(path,loc),val,loc,callback,true))}if(this._hasParentSelector){for(var t=0;t<ret.length;t++){var rett=ret[t];if(rett.isParentSelector){var tmp=self._trace(rett.expr,val,rett.path,parent,parentPropName,callback);if(Array.isArray(tmp)){ret[t]=tmp[0];for(var tt=1,tl=tmp.length;tt<tl;tt++){t++;ret.splice(t,0,tmp[tt])}}else{ret[t]=tmp}}}}return ret};JSONPath.prototype._walk=function(loc,expr,val,path,parent,parentPropName,callback,f){var i,n,m;if(Array.isArray(val)){for(i=0,n=val.length;i<n;i++){f(i,loc,expr,val,path,parent,parentPropName,callback)}}else if(typeof val==="object"){for(m in val){if(Object.prototype.hasOwnProperty.call(val,m)){f(m,loc,expr,val,path,parent,parentPropName,callback)}}}};JSONPath.prototype._slice=function(loc,expr,val,path,parent,parentPropName,callback){if(!Array.isArray(val)){return}var i,len=val.length,parts=loc.split(":"),start=parts[0]&&parseInt(parts[0],10)||0,end=parts[1]&&parseInt(parts[1],10)||len,step=parts[2]&&parseInt(parts[2],10)||1;start=start<0?Math.max(0,start+len):Math.min(len,start);end=end<0?Math.max(0,end+len):Math.min(len,end);var ret=[];for(i=start;i<end;i+=step){var tmp=this._trace(unshift(i,expr),val,path,parent,parentPropName,callback);if(Array.isArray(tmp)){tmp.forEach(function(t){ret.push(t)})}else{ret.push(tmp)}}return ret};JSONPath.prototype._eval=function(code,_v,_vname,path,parent,parentPropName){if(!this._obj||!_v){return false}if(code.includes("@parentProperty")){this.currSandbox._$_parentProperty=parentPropName;code=code.replace(/@parentProperty/g,"_$_parentProperty")}if(code.includes("@parent")){this.currSandbox._$_parent=parent;code=code.replace(/@parent/g,"_$_parent")}if(code.includes("@property")){this.currSandbox._$_property=_vname;code=code.replace(/@property/g,"_$_property")}if(code.includes("@path")){this.currSandbox._$_path=JSONPath.toPathString(path.concat([_vname]));code=code.replace(/@path/g,"_$_path")}if(code.match(/@([\.\s\)\[])/)){this.currSandbox._$_v=_v;code=code.replace(/@([\.\s\)\[])/g,"_$_v$1")}try{return vm.runInNewContext(code,this.currSandbox)}catch(e){console.log(e);throw new Error("jsonPath: "+e.message+": "+code)}};JSONPath.cache={};JSONPath.toPathString=function(pathArr){var i,n,x=pathArr,p="$";for(i=1,n=x.length;i<n;i++){if(!/^(~|\^|@.*?\(\))$/.test(x[i])){p+=/^[0-9*]+$/.test(x[i])?"["+x[i]+"]":"['"+x[i]+"']"}}return p};JSONPath.toPointer=function(pointer){var i,n,x=pointer,p="";for(i=1,n=x.length;i<n;i++){if(!/^(~|\^|@.*?\(\))$/.test(x[i])){p+="/"+x[i].toString().replace(/\~/g,"~0").replace(/\//g,"~1")}}return p};JSONPath.toPathArray=function(expr){var cache=JSONPath.cache;if(cache[expr]){return cache[expr].concat()}var subx=[];var normalized=expr.replace(/@(?:null|boolean|number|string|integer|undefined|nonFinite|scalar|array|object|function|other)\(\)/g,";$&;").replace(/[\['](\??\(.*?\))[\]']/g,function($0,$1){return"[#"+(subx.push($1)-1)+"]"}).replace(/\['([^'\]]*)'\]/g,function($0,prop){return"['"+prop.replace(/\./g,"%@%").replace(/~/g,"%%@@%%")+"']"}).replace(/~/g,";~;").replace(/'?\.'?(?![^\[]*\])|\['?/g,";").replace(/%@%/g,".").replace(/%%@@%%/g,"~").replace(/(?:;)?(\^+)(?:;)?/g,function($0,ups){return";"+ups.split("").join(";")+";"}).replace(/;;;|;;/g,";..;").replace(/;$|'?\]|'$/g,"");var exprList=normalized.split(";").map(function(expr){var match=expr.match(/#([0-9]+)/);return!match||!match[1]?expr:subx[match[1]]});cache[expr]=exprList;return cache[expr]};JSONPath.eval=function(obj,expr,opts){return JSONPath(opts,expr,obj)};if(typeof define==="function"&&define.amd){define(function(){return JSONPath})}else if(isNode){module.exports=JSONPath}else{glbl.jsonPath={eval:JSONPath.eval};glbl.JSONPath=JSONPath}})(this||self,typeof require==="undefined"?null:require)},{vm:76}],20:[function(require,module,exports){(function(process){(function(){var Locale,Locales,app,_ref,__slice=[].slice;app=function(supported,def){if(!(supported instanceof Locales)){supported=new Locales(supported,def);supported.index()}return function(req,res,next){var bestLocale,locales;locales=new Locales(req.headers["accept-language"]);bestLocale=locales.best(supported);req.locale=String(bestLocale);req.rawLocale=bestLocale;return next()}};app.Locale=function(){var serialize;Locale["default"]=new Locale(process.env.LANG||"en_US");function Locale(str){var country,language,match,normalized;if(!(match=str!=null?str.match(/[a-z]+/gi):void 0)){return}language=match[0],country=match[1];this.code=str;this.language=language.toLowerCase();if(country){this.country=country.toUpperCase()}normalized=[this.language];if(this.country){normalized.push(this.country)}this.normalized=normalized.join("_")}serialize=function(){if(this.language){return this.code}else{return null}};Locale.prototype.toString=serialize;Locale.prototype.toJSON=serialize;return Locale}();app.Locales=function(){var serialize;Locales.prototype.length=0;Locales.prototype._index=null;Locales.prototype.sort=Array.prototype.sort;Locales.prototype.push=Array.prototype.push;function Locales(str,def){var item,locale,q,_i,_len,_ref,_ref1;if(def){this["default"]=new Locale(def)}if(!str){return}_ref=String(str).split(",");for(_i=0,_len=_ref.length;_i<_len;_i++){item=_ref[_i];_ref1=item.split(";"),locale=_ref1[0],q=_ref1[1];locale=new Locale(locale.trim());locale.score=q?+q.slice(2)||0:1;this.push(locale)}this.sort(function(a,b){return b.score-a.score})}Locales.prototype.index=function(){var idx,locale,_i,_len;if(!this._index){this._index={};for(idx=_i=0,_len=this.length;_i<_len;idx=++_i){locale=this[idx];this._index[locale.normalized]=idx}}return this._index};Locales.prototype.best=function(locales){var index,item,l,languageIndex,locale,normalizedIndex,setLocale,_i,_j,_len,_len1;setLocale=function(l){var r;r=l;r.defaulted=false;return r};locale=Locale["default"];if(locales&&locales["default"]){locale=locales["default"]}locale.defaulted=true;if(!locales){if(this[0]){locale=this[0];locale.defaulted=true}return locale}index=locales.index();for(_i=0,_len=this.length;_i<_len;_i++){item=this[_i];normalizedIndex=index[item.normalized];languageIndex=index[item.language];if(normalizedIndex!=null){return setLocale(locales[normalizedIndex])}else if(languageIndex!=null){return setLocale(locales[languageIndex])}else{for(_j=0,_len1=locales.length;_j<_len1;_j++){l=locales[_j];if(l.language===item.language){return setLocale(l)}}}}return locale};serialize=function(){return __slice.call(this)};Locales.prototype.toJSON=serialize;Locales.prototype.toString=function(){return String(this.toJSON())};return Locales}();_ref=module.exports=app,Locale=_ref.Locale,Locales=_ref.Locales}).call(this)}).call(this,require("_process"))},{_process:24}],21:[function(require,module,exports){(function(root,factory){if(typeof define==="function"&&define.amd){define([],factory)}else if(typeof exports==="object"){module.exports=factory()}else{root.LokiIndexedAdapter=factory()}})(this,function(){return function(){function LokiIndexedAdapter(appname){this.app="loki";if(typeof appname!=="undefined"){this.app=appname}this.catalog=null;if(!this.checkAvailability()){throw new Error("indexedDB does not seem to be supported for your environment")}}LokiIndexedAdapter.prototype.checkAvailability=function(){if(typeof indexedDB!=="undefined"&&indexedDB)return true;return false};LokiIndexedAdapter.prototype.loadDatabase=function(dbname,callback){var appName=this.app;var adapter=this;if(this.catalog===null||this.catalog.db===null){this.catalog=new LokiCatalog(function(cat){adapter.catalog=cat;adapter.loadDatabase(dbname,callback)});return}this.catalog.getAppKey(appName,dbname,function(result){if(typeof callback==="function"){if(result.id===0){callback(null);return}callback(result.val)}else{console.log(result.val)}})};LokiIndexedAdapter.prototype.loadKey=LokiIndexedAdapter.prototype.loadDatabase;LokiIndexedAdapter.prototype.saveDatabase=function(dbname,dbstring,callback){var appName=this.app;var adapter=this;function saveCallback(result){if(result&&result.success===true){callback(null)}else{callback(new Error("Error saving database"))}}if(this.catalog===null||this.catalog.db===null){this.catalog=new LokiCatalog(function(cat){adapter.catalog=cat;cat.setAppKey(appName,dbname,dbstring,saveCallback)});return}this.catalog.setAppKey(appName,dbname,dbstring,saveCallback)};LokiIndexedAdapter.prototype.saveKey=LokiIndexedAdapter.prototype.saveDatabase;LokiIndexedAdapter.prototype.deleteDatabase=function(dbname,callback){var appName=this.app;var adapter=this;if(this.catalog===null||this.catalog.db===null){this.catalog=new LokiCatalog(function(cat){adapter.catalog=cat;adapter.deleteDatabase(dbname,callback)});return}this.catalog.getAppKey(appName,dbname,function(result){var id=result.id;if(id!==0){adapter.catalog.deleteAppKey(id,callback)}else if(typeof callback==="function"){callback({success:true})}})};LokiIndexedAdapter.prototype.deleteKey=LokiIndexedAdapter.prototype.deleteDatabase;LokiIndexedAdapter.prototype.deleteDatabasePartitions=function(dbname){var self=this;this.getDatabaseList(function(result){result.forEach(function(str){if(str.startsWith(dbname)){self.deleteDatabase(str)}})})};LokiIndexedAdapter.prototype.getDatabaseList=function(callback){var appName=this.app;var adapter=this;if(this.catalog===null||this.catalog.db===null){this.catalog=new LokiCatalog(function(cat){adapter.catalog=cat;adapter.getDatabaseList(callback)});return}this.catalog.getAppKeys(appName,function(results){var names=[];for(var idx=0;idx<results.length;idx++){names.push(results[idx].key)}if(typeof callback==="function"){callback(names)}else{names.forEach(function(obj){console.log(obj)})}})};LokiIndexedAdapter.prototype.getKeyList=LokiIndexedAdapter.prototype.getDatabaseList;LokiIndexedAdapter.prototype.getCatalogSummary=function(callback){var appName=this.app;var adapter=this;if(this.catalog===null||this.catalog.db===null){this.catalog=new LokiCatalog(function(cat){adapter.catalog=cat;adapter.getCatalogSummary(callback)});return}this.catalog.getAllKeys(function(results){var entries=[];var obj,size,oapp,okey,oval;for(var idx=0;idx<results.length;idx++){obj=results[idx];oapp=obj.app||"";okey=obj.key||"";oval=obj.val||"";size=oapp.length*2+okey.length*2+oval.length+1;entries.push({app:obj.app,key:obj.key,size:size})}if(typeof callback==="function"){callback(entries)}else{entries.forEach(function(obj){console.log(obj)})}})};function LokiCatalog(callback){this.db=null;this.initializeLokiCatalog(callback)}LokiCatalog.prototype.initializeLokiCatalog=function(callback){var openRequest=indexedDB.open("LokiCatalog",1);var cat=this;openRequest.onupgradeneeded=function(e){var thisDB=e.target.result;if(thisDB.objectStoreNames.contains("LokiAKV")){thisDB.deleteObjectStore("LokiAKV")}if(!thisDB.objectStoreNames.contains("LokiAKV")){var objectStore=thisDB.createObjectStore("LokiAKV",{keyPath:"id",autoIncrement:true});objectStore.createIndex("app","app",{unique:false});objectStore.createIndex("key","key",{unique:false});objectStore.createIndex("appkey","appkey",{unique:true})}};openRequest.onsuccess=function(e){cat.db=e.target.result;if(typeof callback==="function")callback(cat)};openRequest.onerror=function(e){throw e}};LokiCatalog.prototype.getAppKey=function(app,key,callback){var transaction=this.db.transaction(["LokiAKV"],"readonly");var store=transaction.objectStore("LokiAKV");var index=store.index("appkey");var appkey=app+","+key;var request=index.get(appkey);request.onsuccess=function(usercallback){return function(e){var lres=e.target.result;if(lres===null||typeof lres==="undefined"){lres={id:0,success:false}}if(typeof usercallback==="function"){usercallback(lres)}else{console.log(lres)}}}(callback);request.onerror=function(usercallback){return function(e){if(typeof usercallback==="function"){usercallback({id:0,success:false})}else{throw e}}}(callback)};LokiCatalog.prototype.getAppKeyById=function(id,callback,data){var transaction=this.db.transaction(["LokiAKV"],"readonly");var store=transaction.objectStore("LokiAKV");var request=store.get(id);request.onsuccess=function(data,usercallback){return function(e){if(typeof usercallback==="function"){usercallback(e.target.result,data)}else{console.log(e.target.result)}}}(data,callback)};LokiCatalog.prototype.setAppKey=function(app,key,val,callback){var transaction=this.db.transaction(["LokiAKV"],"readwrite");var store=transaction.objectStore("LokiAKV");var index=store.index("appkey");var appkey=app+","+key;var request=index.get(appkey);request.onsuccess=function(e){var res=e.target.result;if(res===null||res===undefined){res={app:app,key:key,appkey:app+","+key,val:val}}else{res.val=val}var requestPut=store.put(res);requestPut.onerror=function(usercallback){return function(e){if(typeof usercallback==="function"){usercallback({success:false})}else{console.error("LokiCatalog.setAppKey (set) onerror");console.error(request.error)}}}(callback);requestPut.onsuccess=function(usercallback){return function(e){if(typeof usercallback==="function"){usercallback({success:true})}}}(callback)};request.onerror=function(usercallback){return function(e){if(typeof usercallback==="function"){usercallback({success:false})}else{console.error("LokiCatalog.setAppKey (get) onerror");console.error(request.error)}}}(callback)};LokiCatalog.prototype.deleteAppKey=function(id,callback){var transaction=this.db.transaction(["LokiAKV"],"readwrite");var store=transaction.objectStore("LokiAKV");var request=store.delete(id);request.onsuccess=function(usercallback){return function(evt){if(typeof usercallback==="function")usercallback({success:true})}}(callback);request.onerror=function(usercallback){return function(evt){if(typeof usercallback==="function"){usercallback({success:false})}else{console.error("LokiCatalog.deleteAppKey raised onerror");console.error(request.error)}}}(callback)};LokiCatalog.prototype.getAppKeys=function(app,callback){var transaction=this.db.transaction(["LokiAKV"],"readonly");var store=transaction.objectStore("LokiAKV");var index=store.index("app");var singleKeyRange=IDBKeyRange.only(app);var cursor=index.openCursor(singleKeyRange);var localdata=[];cursor.onsuccess=function(data,callback){return function(e){var cursor=e.target.result;if(cursor){var currObject=cursor.value;data.push(currObject);cursor.continue()}else{if(typeof callback==="function"){callback(data)}else{console.log(data)}}}}(localdata,callback);cursor.onerror=function(usercallback){return function(e){if(typeof usercallback==="function"){usercallback(null)}else{console.error("LokiCatalog.getAppKeys raised onerror");console.error(e)}}}(callback)};LokiCatalog.prototype.getAllKeys=function(callback){var transaction=this.db.transaction(["LokiAKV"],"readonly");var store=transaction.objectStore("LokiAKV");var cursor=store.openCursor();var localdata=[];cursor.onsuccess=function(data,callback){return function(e){var cursor=e.target.result;if(cursor){var currObject=cursor.value;data.push(currObject);cursor.continue()}else{if(typeof callback==="function"){callback(data)}else{console.log(data)}}}}(localdata,callback);cursor.onerror=function(usercallback){return function(e){if(typeof usercallback==="function")usercallback(null)}}(callback)};return LokiIndexedAdapter}()})},{}],22:[function(require,module,exports){(function(global){(function(root,factory){if(typeof define==="function"&&define.amd){define([],factory)}else if(typeof exports==="object"){module.exports=factory()}else{root.loki=factory()}})(this,function(){return function(){"use strict";var hasOwnProperty=Object.prototype.hasOwnProperty;var Utils={copyProperties:function(src,dest){var prop;for(prop in src){dest[prop]=src[prop]}},resolveTransformObject:function(subObj,params,depth){var prop,pname;if(typeof depth!=="number"){depth=0}if(++depth>=10)return subObj;for(prop in subObj){if(typeof subObj[prop]==="string"&&subObj[prop].indexOf("[%lktxp]")===0){pname=subObj[prop].substring(8);if(params.hasOwnProperty(pname)){subObj[prop]=params[pname]}}else if(typeof subObj[prop]==="object"){subObj[prop]=Utils.resolveTransformObject(subObj[prop],params,depth)}}return subObj},resolveTransformParams:function(transform,params){var idx,clonedStep,resolvedTransform=[];if(typeof params==="undefined")return transform;for(idx=0;idx<transform.length;idx++){clonedStep=JSON.parse(JSON.stringify(transform[idx]));resolvedTransform.push(Utils.resolveTransformObject(clonedStep,params))}return resolvedTransform}};function aeqHelper(prop1,prop2){var cv1,cv2,t1,t2;if(prop1===prop2)return true;if(!prop1||!prop2||prop1===true||prop2===true||prop1!==prop1||prop2!==prop2){switch(prop1){case undefined:t1=1;break;case null:t1=1;break;case false:t1=3;break;case true:t1=4;break;case"":t1=5;break;default:t1=prop1===prop1?9:0;break}switch(prop2){case undefined:t2=1;break;case null:t2=1;break;case false:t2=3;break;case true:t2=4;break;case"":t2=5;break;default:t2=prop2===prop2?9:0;break}if(t1!==9||t2!==9){return t1===t2}}cv1=Number(prop1);cv2=Number(prop2);if(cv1===cv1||cv2===cv2){return cv1===cv2}cv1=prop1.toString();cv2=prop2.toString();return cv1==cv2}function ltHelper(prop1,prop2,equal){var cv1,cv2,t1,t2;if(!prop1||!prop2||prop1===true||prop2===true||prop1!==prop1||prop2!==prop2){switch(prop1){case undefined:t1=1;break;case null:t1=1;break;case false:t1=3;break;case true:t1=4;break;case"":t1=5;break;default:t1=prop1===prop1?9:0;break}switch(prop2){case undefined:t2=1;break;case null:t2=1;break;case false:t2=3;break;case true:t2=4;break;case"":t2=5;break;default:t2=prop2===prop2?9:0;break}if(t1!==9||t2!==9){return t1===t2?equal:t1<t2}}cv1=Number(prop1);cv2=Number(prop2);if(cv1===cv1&&cv2===cv2){if(cv1<cv2)return true;if(cv1>cv2)return false;return equal}if(cv1===cv1&&cv2!==cv2){return true}if(cv2===cv2&&cv1!==cv1){return false}if(prop1<prop2)return true;if(prop1>prop2)return false;if(prop1==prop2)return equal;cv1=prop1.toString();cv2=prop2.toString();if(cv1<cv2){return true}if(cv1==cv2){return equal}return false}function gtHelper(prop1,prop2,equal){var cv1,cv2,t1,t2;if(!prop1||!prop2||prop1===true||prop2===true||prop1!==prop1||prop2!==prop2){switch(prop1){case undefined:t1=1;break;case null:t1=1;break;case false:t1=3;break;case true:t1=4;break;case"":t1=5;break;default:t1=prop1===prop1?9:0;break}switch(prop2){case undefined:t2=1;break;case null:t2=1;break;case false:t2=3;break;case true:t2=4;break;case"":t2=5;break;default:t2=prop2===prop2?9:0;break}if(t1!==9||t2!==9){return t1===t2?equal:t1>t2}}cv1=Number(prop1);cv2=Number(prop2);if(cv1===cv1&&cv2===cv2){if(cv1>cv2)return true;if(cv1<cv2)return false;return equal}if(cv1===cv1&&cv2!==cv2){return false}if(cv2===cv2&&cv1!==cv1){return true}if(prop1>prop2)return true;if(prop1<prop2)return false;if(prop1==prop2)return equal;cv1=prop1.toString();cv2=prop2.toString();if(cv1>cv2){return true}if(cv1==cv2){return equal}return false}function sortHelper(prop1,prop2,desc){if(aeqHelper(prop1,prop2))return 0;if(ltHelper(prop1,prop2,false)){return desc?1:-1}if(gtHelper(prop1,prop2,false)){return desc?-1:1}return 0}function compoundeval(properties,obj1,obj2){var res=0;var prop,field,val1,val2,arr;for(var i=0,len=properties.length;i<len;i++){prop=properties[i];field=prop[0];if(~field.indexOf(".")){arr=field.split(".")
;val1=arr.reduce(function(obj,i){return obj&&obj[i]||undefined},obj1);val2=arr.reduce(function(obj,i){return obj&&obj[i]||undefined},obj2)}else{val1=obj1[field];val2=obj2[field]}res=sortHelper(val1,val2,prop[1]);if(res!==0){return res}}return 0}function dotSubScan(root,paths,fun,value,poffset){var pathOffset=poffset||0;var path=paths[pathOffset];if(root===undefined||root===null||!hasOwnProperty.call(root,path)){return false}var valueFound=false;var element=root[path];if(pathOffset+1>=paths.length){valueFound=fun(element,value)}else if(Array.isArray(element)){for(var index=0,len=element.length;index<len;index+=1){valueFound=dotSubScan(element[index],paths,fun,value,pathOffset+1);if(valueFound===true){break}}}else{valueFound=dotSubScan(element,paths,fun,value,pathOffset+1)}return valueFound}function containsCheckFn(a){if(typeof a==="string"||Array.isArray(a)){return function(b){return a.indexOf(b)!==-1}}else if(typeof a==="object"&&a!==null){return function(b){return hasOwnProperty.call(a,b)}}return null}function doQueryOp(val,op){for(var p in op){if(hasOwnProperty.call(op,p)){return LokiOps[p](val,op[p])}}return false}var LokiOps={$eq:function(a,b){return a===b},$aeq:function(a,b){return a==b},$ne:function(a,b){if(b!==b){return a===a}return a!==b},$dteq:function(a,b){return aeqHelper(a,b)},$gt:function(a,b){return gtHelper(a,b,false)},$gte:function(a,b){return gtHelper(a,b,true)},$lt:function(a,b){return ltHelper(a,b,false)},$lte:function(a,b){return ltHelper(a,b,true)},$between:function(a,vals){if(a===undefined||a===null)return false;return gtHelper(a,vals[0],true)&&ltHelper(a,vals[1],true)},$in:function(a,b){return b.indexOf(a)!==-1},$nin:function(a,b){return b.indexOf(a)===-1},$keyin:function(a,b){return a in b},$nkeyin:function(a,b){return!(a in b)},$definedin:function(a,b){return b[a]!==undefined},$undefinedin:function(a,b){return b[a]===undefined},$regex:function(a,b){return b.test(a)},$containsString:function(a,b){return typeof a==="string"&&a.indexOf(b)!==-1},$containsNone:function(a,b){return!LokiOps.$containsAny(a,b)},$containsAny:function(a,b){var checkFn=containsCheckFn(a);if(checkFn!==null){return Array.isArray(b)?b.some(checkFn):checkFn(b)}return false},$contains:function(a,b){var checkFn=containsCheckFn(a);if(checkFn!==null){return Array.isArray(b)?b.every(checkFn):checkFn(b)}return false},$type:function(a,b){var type=typeof a;if(type==="object"){if(Array.isArray(a)){type="array"}else if(a instanceof Date){type="date"}}return typeof b!=="object"?type===b:doQueryOp(type,b)},$finite:function(a,b){return b===isFinite(a)},$size:function(a,b){if(Array.isArray(a)){return typeof b!=="object"?a.length===b:doQueryOp(a.length,b)}return false},$len:function(a,b){if(typeof a==="string"){return typeof b!=="object"?a.length===b:doQueryOp(a.length,b)}return false},$where:function(a,b){return b(a)===true},$not:function(a,b){return!doQueryOp(a,b)},$and:function(a,b){for(var idx=0,len=b.length;idx<len;idx+=1){if(!doQueryOp(a,b[idx])){return false}}return true},$or:function(a,b){for(var idx=0,len=b.length;idx<len;idx+=1){if(doQueryOp(a,b[idx])){return true}}return false}};var indexedOps={$eq:LokiOps.$eq,$aeq:true,$dteq:true,$gt:true,$gte:true,$lt:true,$lte:true,$in:true,$between:true};function clone(data,method){if(data===null||data===undefined){return null}var cloneMethod=method||"parse-stringify",cloned;switch(cloneMethod){case"parse-stringify":cloned=JSON.parse(JSON.stringify(data));break;case"jquery-extend-deep":cloned=jQuery.extend(true,{},data);break;case"shallow":cloned=Object.create(data.constructor.prototype);Object.keys(data).map(function(i){cloned[i]=data[i]});break;case"shallow-assign":cloned=Object.create(data.constructor.prototype);Object.assign(cloned,data);break;default:break}return cloned}function cloneObjectArray(objarray,method){var i,result=[];if(method=="parse-stringify"){return clone(objarray,method)}i=objarray.length-1;for(;i<=0;i--){result.push(clone(objarray[i],method))}return result}function localStorageAvailable(){try{return window&&window.localStorage!==undefined&&window.localStorage!==null}catch(e){return false}}function LokiEventEmitter(){}LokiEventEmitter.prototype.events={};LokiEventEmitter.prototype.asyncListeners=false;LokiEventEmitter.prototype.on=function(eventName,listener){var event;var self=this;if(Array.isArray(eventName)){eventName.forEach(function(currentEventName){self.on(currentEventName,listener)});return listener}event=this.events[eventName];if(!event){event=this.events[eventName]=[]}event.push(listener);return listener};LokiEventEmitter.prototype.emit=function(eventName){var self=this;var selfArgs=Array.prototype.slice.call(arguments,1);if(eventName&&this.events[eventName]){this.events[eventName].forEach(function(listener){if(self.asyncListeners){setTimeout(function(){listener.apply(self,selfArgs)},1)}else{listener.apply(self,selfArgs)}})}else{throw new Error("No event "+eventName+" defined")}};LokiEventEmitter.prototype.addListener=LokiEventEmitter.prototype.on;LokiEventEmitter.prototype.removeListener=function(eventName,listener){var self=this;if(Array.isArray(eventName)){eventName.forEach(function(currentEventName){self.removeListener(currentEventName,listener)});return}if(this.events[eventName]){var listeners=this.events[eventName];listeners.splice(listeners.indexOf(listener),1)}};function Loki(filename,options){this.filename=filename||"loki.db";this.collections=[];this.databaseVersion=1.5;this.engineVersion=1.5;this.autosave=false;this.autosaveInterval=5e3;this.autosaveHandle=null;this.throttledSaves=true;this.options={};this.persistenceMethod=null;this.persistenceAdapter=null;this.throttledSavePending=false;this.throttledCallbacks=[];this.verbose=options&&options.hasOwnProperty("verbose")?options.verbose:false;this.events={init:[],loaded:[],flushChanges:[],close:[],changes:[],warning:[]};var getENV=function(){if(typeof global!=="undefined"&&(global.android||global.NSObject)){return"NATIVESCRIPT"}if(typeof window==="undefined"){return"NODEJS"}if(typeof global!=="undefined"&&global.window){return"NODEJS"}if(typeof document!=="undefined"){if(document.URL.indexOf("http://")===-1&&document.URL.indexOf("https://")===-1){return"CORDOVA"}return"BROWSER"}return"CORDOVA"};if(options&&options.hasOwnProperty("env")){this.ENV=options.env}else{this.ENV=getENV()}if(this.ENV==="undefined"){this.ENV="NODEJS"}this.configureOptions(options,true);this.on("init",this.clearChanges)}Loki.prototype=new LokiEventEmitter;Loki.prototype.constructor=Loki;Loki.prototype.getIndexedAdapter=function(){var adapter;if(typeof require==="function"){adapter=require("./loki-indexed-adapter.js")}return adapter};Loki.prototype.configureOptions=function(options,initialConfig){var defaultPersistence={NODEJS:"fs",BROWSER:"localStorage",CORDOVA:"localStorage",MEMORY:"memory"},persistenceMethods={fs:LokiFsAdapter,localStorage:LokiLocalStorageAdapter,memory:LokiMemoryAdapter};this.options={};this.persistenceMethod=null;this.persistenceAdapter=null;if(typeof options!=="undefined"){this.options=options;if(this.options.hasOwnProperty("persistenceMethod")){if(typeof persistenceMethods[options.persistenceMethod]=="function"){this.persistenceMethod=options.persistenceMethod;this.persistenceAdapter=new persistenceMethods[options.persistenceMethod]}}if(this.options.hasOwnProperty("adapter")){this.persistenceMethod="adapter";this.persistenceAdapter=options.adapter;this.options.adapter=null}if(options.autoload&&initialConfig){var self=this;setTimeout(function(){self.loadDatabase(options,options.autoloadCallback)},1)}if(this.options.hasOwnProperty("autosaveInterval")){this.autosaveDisable();this.autosaveInterval=parseInt(this.options.autosaveInterval,10)}if(this.options.hasOwnProperty("autosave")&&this.options.autosave){this.autosaveDisable();this.autosave=true;if(this.options.hasOwnProperty("autosaveCallback")){this.autosaveEnable(options,options.autosaveCallback)}else{this.autosaveEnable()}}if(this.options.hasOwnProperty("throttledSaves")){this.throttledSaves=this.options.throttledSaves}}if(!this.options.hasOwnProperty("serializationMethod")){this.options.serializationMethod="normal"}if(!this.options.hasOwnProperty("destructureDelimiter")){this.options.destructureDelimiter="$<\n"}if(this.persistenceAdapter===null){this.persistenceMethod=defaultPersistence[this.ENV];if(this.persistenceMethod){this.persistenceAdapter=new persistenceMethods[this.persistenceMethod]}}};Loki.prototype.copy=function(options){var databaseCopy=new Loki(this.filename,{env:"NA"});var clen,idx;options=options||{};databaseCopy.loadJSONObject(this,{retainDirtyFlags:true});if(options.hasOwnProperty("removeNonSerializable")&&options.removeNonSerializable===true){databaseCopy.autosaveHandle=null;databaseCopy.persistenceAdapter=null;clen=databaseCopy.collections.length;for(idx=0;idx<clen;idx++){databaseCopy.collections[idx].constraints=null;databaseCopy.collections[idx].ttl=null}}return databaseCopy};Loki.prototype.addCollection=function(name,options){var collection=new Collection(name,options);this.collections.push(collection);if(this.verbose)collection.console=console;return collection};Loki.prototype.loadCollection=function(collection){if(!collection.name){throw new Error("Collection must have a name property to be loaded")}this.collections.push(collection)};Loki.prototype.getCollection=function(collectionName){var i,len=this.collections.length;for(i=0;i<len;i+=1){if(this.collections[i].name===collectionName){return this.collections[i]}}this.emit("warning","collection "+collectionName+" not found");return null};Loki.prototype.renameCollection=function(oldName,newName){var c=this.getCollection(oldName);if(c){c.name=newName}return c};Loki.prototype.listCollections=function(){var i=this.collections.length,colls=[];while(i--){colls.push({name:this.collections[i].name,type:this.collections[i].objType,count:this.collections[i].data.length})}return colls};Loki.prototype.removeCollection=function(collectionName){var i,len=this.collections.length;for(i=0;i<len;i+=1){if(this.collections[i].name===collectionName){var tmpcol=new Collection(collectionName,{});var curcol=this.collections[i];for(var prop in curcol){if(curcol.hasOwnProperty(prop)&&tmpcol.hasOwnProperty(prop)){curcol[prop]=tmpcol[prop]}}this.collections.splice(i,1);return}}};Loki.prototype.getName=function(){return this.name};Loki.prototype.serializeReplacer=function(key,value){switch(key){case"autosaveHandle":case"persistenceAdapter":case"constraints":case"ttl":return null;case"throttledSavePending":case"throttledCallbacks":return undefined;default:return value}};Loki.prototype.serialize=function(options){options=options||{};if(!options.hasOwnProperty("serializationMethod")){options.serializationMethod=this.options.serializationMethod}switch(options.serializationMethod){case"normal":return JSON.stringify(this,this.serializeReplacer);case"pretty":return JSON.stringify(this,this.serializeReplacer,2);case"destructured":return this.serializeDestructured();default:return JSON.stringify(this,this.serializeReplacer)}};Loki.prototype.toJson=Loki.prototype.serialize;Loki.prototype.serializeDestructured=function(options){var idx,sidx,result,resultlen;var reconstruct=[];var dbcopy;options=options||{};if(!options.hasOwnProperty("partitioned")){options.partitioned=false}if(!options.hasOwnProperty("delimited")){options.delimited=true}if(!options.hasOwnProperty("delimiter")){options.delimiter=this.options.destructureDelimiter}if(options.partitioned===true&&options.hasOwnProperty("partition")&&options.partition>=0){return this.serializeCollection({delimited:options.delimited,delimiter:options.delimiter,collectionIndex:options.partition})}dbcopy=new Loki(this.filename);dbcopy.loadJSONObject(this);for(idx=0;idx<dbcopy.collections.length;idx++){dbcopy.collections[idx].data=[]}if(options.partitioned===true&&options.partition===-1){return dbcopy.serialize({serializationMethod:"normal"})}reconstruct.push(dbcopy.serialize({serializationMethod:"normal"}));dbcopy=null;for(idx=0;idx<this.collections.length;idx++){result=this.serializeCollection({delimited:options.delimited,delimiter:options.delimiter,collectionIndex:idx});if(options.partitioned===false&&options.delimited===false){if(!Array.isArray(result)){throw new Error("a nondelimited, non partitioned collection serialization did not return an expected array")}resultlen=result.length;for(sidx=0;sidx<resultlen;sidx++){reconstruct.push(result[sidx]);result[sidx]=null}reconstruct.push("")}else{reconstruct.push(result)}}if(options.partitioned){if(options.delimited){return reconstruct}else{return reconstruct}}else{if(options.delimited){reconstruct.push("");return reconstruct.join(options.delimiter)}else{reconstruct.push("");return reconstruct}}reconstruct.push("");return reconstruct.join(delim)};Loki.prototype.serializeCollection=function(options){var doccount,docidx,resultlines=[];options=options||{};if(!options.hasOwnProperty("delimited")){options.delimited=true}if(!options.hasOwnProperty("collectionIndex")){throw new Error("serializeCollection called without 'collectionIndex' option")}doccount=this.collections[options.collectionIndex].data.length;resultlines=[];for(docidx=0;docidx<doccount;docidx++){resultlines.push(JSON.stringify(this.collections[options.collectionIndex].data[docidx]))}if(options.delimited){resultlines.push("");return resultlines.join(options.delimiter)}else{return resultlines}};Loki.prototype.deserializeDestructured=function(destructuredSource,options){var workarray=[];var len,cdb;var idx,collIndex=0,collCount,lineIndex=1,done=false;var currLine,currObject;options=options||{};if(!options.hasOwnProperty("partitioned")){options.partitioned=false}if(!options.hasOwnProperty("delimited")){options.delimited=true}if(!options.hasOwnProperty("delimiter")){options.delimiter=this.options.destructureDelimiter}if(options.partitioned){if(options.hasOwnProperty("partition")){if(options.partition===-1){cdb=JSON.parse(destructuredSource[0]);return cdb}return this.deserializeCollection(destructuredSource[options.partition+1],options)}cdb=JSON.parse(destructuredSource[0]);collCount=cdb.collections.length;for(collIndex=0;collIndex<collCount;collIndex++){cdb.collections[collIndex].data=this.deserializeCollection(destructuredSource[collIndex+1],options)}return cdb}if(options.delimited){workarray=destructuredSource.split(options.delimiter);destructuredSource=null;len=workarray.length;if(len===0){return null}}else{workarray=destructuredSource}cdb=JSON.parse(workarray[0]);collCount=cdb.collections.length;workarray[0]=null;while(!done){currLine=workarray[lineIndex];if(workarray[lineIndex]===""){if(++collIndex>collCount){done=true}}else{currObject=JSON.parse(workarray[lineIndex]);cdb.collections[collIndex].data.push(currObject)}workarray[lineIndex++]=null}return cdb};Loki.prototype.deserializeCollection=function(destructuredSource,options){var workarray=[];var idx,len;options=options||{};if(!options.hasOwnProperty("partitioned")){options.partitioned=false}if(!options.hasOwnProperty("delimited")){options.delimited=true}if(!options.hasOwnProperty("delimiter")){options.delimiter=this.options.destructureDelimiter}if(options.delimited){workarray=destructuredSource.split(options.delimiter);workarray.pop()}else{workarray=destructuredSource}len=workarray.length;for(idx=0;idx<len;idx++){workarray[idx]=JSON.parse(workarray[idx])}return workarray};Loki.prototype.loadJSON=function(serializedDb,options){var dbObject;if(serializedDb.length===0){dbObject={}}else{switch(this.options.serializationMethod){case"normal":case"pretty":dbObject=JSON.parse(serializedDb);break;case"destructured":dbObject=this.deserializeDestructured(serializedDb);break;default:dbObject=JSON.parse(serializedDb);break}}this.loadJSONObject(dbObject,options)};Loki.prototype.loadJSONObject=function(dbObject,options){var i=0,len=dbObject.collections?dbObject.collections.length:0,coll,copyColl,clen,j,loader,collObj;this.name=dbObject.name;if(dbObject.hasOwnProperty("throttledSaves")&&options&&!options.hasOwnProperty("throttledSaves")){this.throttledSaves=dbObject.throttledSaves}this.collections=[];function makeLoader(coll){var collOptions=options[coll.name];var inflater;if(collOptions.proto){inflater=collOptions.inflate||Utils.copyProperties;return function(data){var collObj=new collOptions.proto;inflater(data,collObj);return collObj}}return collOptions.inflate}for(i;i<len;i+=1){coll=dbObject.collections[i];copyColl=this.addCollection(coll.name,{disableChangesApi:coll.disableChangesApi,disableDeltaChangesApi:coll.disableDeltaChangesApi});copyColl.adaptiveBinaryIndices=coll.hasOwnProperty("adaptiveBinaryIndices")?coll.adaptiveBinaryIndices===true:false;copyColl.transactional=coll.transactional;copyColl.asyncListeners=coll.asyncListeners;copyColl.cloneObjects=coll.cloneObjects;copyColl.cloneMethod=coll.cloneMethod||"parse-stringify";copyColl.autoupdate=coll.autoupdate;copyColl.changes=coll.changes;if(options&&options.retainDirtyFlags===true){copyColl.dirty=coll.dirty}else{copyColl.dirty=false}clen=coll.data.length;j=0;if(options&&options.hasOwnProperty(coll.name)){loader=makeLoader(coll);for(j;j<clen;j++){collObj=loader(coll.data[j]);copyColl.data[j]=collObj;copyColl.addAutoUpdateObserver(collObj)}}else{for(j;j<clen;j++){copyColl.data[j]=coll.data[j];copyColl.addAutoUpdateObserver(copyColl.data[j])}}copyColl.maxId=typeof coll.maxId==="undefined"?0:coll.maxId;copyColl.idIndex=coll.idIndex;if(typeof coll.binaryIndices!=="undefined"){copyColl.binaryIndices=coll.binaryIndices}if(typeof coll.transforms!=="undefined"){copyColl.transforms=coll.transforms}copyColl.ensureId();copyColl.uniqueNames=[];if(coll.hasOwnProperty("uniqueNames")){copyColl.uniqueNames=coll.uniqueNames;for(j=0;j<copyColl.uniqueNames.length;j++){copyColl.ensureUniqueIndex(copyColl.uniqueNames[j])}}if(typeof coll.DynamicViews==="undefined")continue;for(var idx=0;idx<coll.DynamicViews.length;idx++){var colldv=coll.DynamicViews[idx];var dv=copyColl.addDynamicView(colldv.name,colldv.options);dv.resultdata=colldv.resultdata;dv.resultsdirty=colldv.resultsdirty;dv.filterPipeline=colldv.filterPipeline;dv.sortCriteria=colldv.sortCriteria;dv.sortFunction=null;dv.sortDirty=colldv.sortDirty;dv.resultset.filteredrows=colldv.resultset.filteredrows;dv.resultset.filterInitialized=colldv.resultset.filterInitialized;dv.rematerialize({removeWhereFilters:true})}if(dbObject.databaseVersion<1.5){copyColl.ensureAllIndexes(true);copyColl.dirty=true}}};Loki.prototype.close=function(callback){if(this.autosave){this.autosaveDisable();if(this.autosaveDirty()){this.saveDatabase(callback);callback=undefined}}if(callback){this.on("close",callback)}this.emit("close")};Loki.prototype.generateChangesNotification=function(arrayOfCollectionNames){function getCollName(coll){return coll.name}var changes=[],selectedCollections=arrayOfCollectionNames||this.collections.map(getCollName);this.collections.forEach(function(coll){if(selectedCollections.indexOf(getCollName(coll))!==-1){changes=changes.concat(coll.getChanges())}});return changes};Loki.prototype.serializeChanges=function(collectionNamesArray){return JSON.stringify(this.generateChangesNotification(collectionNamesArray))};Loki.prototype.clearChanges=function(){this.collections.forEach(function(coll){if(coll.flushChanges){coll.flushChanges()}})};function LokiMemoryAdapter(options){this.hashStore={};this.options=options||{};if(!this.options.hasOwnProperty("asyncResponses")){this.options.asyncResponses=false}if(!this.options.hasOwnProperty("asyncTimeout")){this.options.asyncTimeout=50}}LokiMemoryAdapter.prototype.loadDatabase=function(dbname,callback){var self=this;if(this.options.asyncResponses){setTimeout(function(){if(self.hashStore.hasOwnProperty(dbname)){callback(self.hashStore[dbname].value)}else{callback(null)}},this.options.asyncTimeout)}else{if(this.hashStore.hasOwnProperty(dbname)){callback(this.hashStore[dbname].value)}else{callback(null)}}};LokiMemoryAdapter.prototype.saveDatabase=function(dbname,dbstring,callback){var self=this;var saveCount;if(this.options.asyncResponses){setTimeout(function(){saveCount=self.hashStore.hasOwnProperty(dbname)?self.hashStore[dbname].savecount:0;self.hashStore[dbname]={savecount:saveCount+1,lastsave:new Date,value:dbstring};callback()},this.options.asyncTimeout)}else{saveCount=this.hashStore.hasOwnProperty(dbname)?this.hashStore[dbname].savecount:0;this.hashStore[dbname]={savecount:saveCount+1,lastsave:new Date,value:dbstring};callback()}};LokiMemoryAdapter.prototype.deleteDatabase=function(dbname,callback){if(this.hashStore.hasOwnProperty(dbname)){delete this.hashStore[dbname]}if(typeof callback==="function"){callback()}};function LokiPartitioningAdapter(adapter,options){this.mode="reference";this.adapter=null;this.options=options||{};this.dbref=null;this.dbname="";this.pageIterator={};if(adapter){if(adapter.mode==="reference"){throw new Error("LokiPartitioningAdapter cannot be instantiated with a reference mode adapter")}else{this.adapter=adapter}}else{throw new Error("LokiPartitioningAdapter requires a (non-reference mode) adapter on construction")}if(!this.options.hasOwnProperty("paging")){this.options.paging=false}if(!this.options.hasOwnProperty("pageSize")){this.options.pageSize=25*1024*1024}if(!this.options.hasOwnProperty("delimiter")){this.options.delimiter="$<\n"}}LokiPartitioningAdapter.prototype.loadDatabase=function(dbname,callback){var self=this;this.dbname=dbname;this.dbref=new Loki(dbname);this.adapter.loadDatabase(dbname,function(result){if(!result){callback(result);return}if(typeof result!=="string"){callback(new Error("LokiPartitioningAdapter received an unexpected response from inner adapter loadDatabase()"))}var db=JSON.parse(result);self.dbref.loadJSONObject(db);db=null;var clen=self.dbref.collections.length;if(self.dbref.collections.length===0){callback(self.dbref);return}self.pageIterator={collection:0,pageIndex:0};self.loadNextPartition(0,function(){callback(self.dbref)})})};LokiPartitioningAdapter.prototype.loadNextPartition=function(partition,callback){var keyname=this.dbname+"."+partition;var self=this;if(this.options.paging===true){this.pageIterator.pageIndex=0;this.loadNextPage(callback);return}this.adapter.loadDatabase(keyname,function(result){var data=self.dbref.deserializeCollection(result,{delimited:true,collectionIndex:partition});self.dbref.collections[partition].data=data;if(++partition<self.dbref.collections.length){self.loadNextPartition(partition,callback)}else{callback()}})};LokiPartitioningAdapter.prototype.loadNextPage=function(callback){var keyname=this.dbname+"."+this.pageIterator.collection+"."+this.pageIterator.pageIndex;var self=this;this.adapter.loadDatabase(keyname,function(result){var data=result.split(self.options.delimiter);result="";var dlen=data.length;var idx;var isLastPage=data[dlen-1]==="";if(isLastPage){data.pop();dlen=data.length;if(data[dlen-1]===""&&dlen===1){data.pop();dlen=data.length}}for(idx=0;idx<dlen;idx++){self.dbref.collections[self.pageIterator.collection].data.push(JSON.parse(data[idx]));data[idx]=null}data=[];if(isLastPage){if(++self.pageIterator.collection<self.dbref.collections.length){self.loadNextPartition(self.pageIterator.collection,callback)}else{callback()}}else{self.pageIterator.pageIndex++;self.loadNextPage(callback)}})};LokiPartitioningAdapter.prototype.exportDatabase=function(dbname,dbref,callback){var self=this;var idx,clen=dbref.collections.length;this.dbref=dbref;this.dbname=dbname;this.dirtyPartitions=[-1];for(idx=0;idx<clen;idx++){if(dbref.collections[idx].dirty){this.dirtyPartitions.push(idx)}}this.saveNextPartition(function(err){callback(err)})};LokiPartitioningAdapter.prototype.saveNextPartition=function(callback){var self=this;var partition=this.dirtyPartitions.shift();var keyname=this.dbname+(partition===-1?"":"."+partition);if(this.options.paging&&partition!==-1){this.pageIterator={collection:partition,docIndex:0,pageIndex:0};this.saveNextPage(function(err){if(self.dirtyPartitions.length===0){callback(err)}else{self.saveNextPartition(callback)}});return}var result=this.dbref.serializeDestructured({partitioned:true,delimited:true,partition:partition});this.adapter.saveDatabase(keyname,result,function(err){if(err){callback(err);return}if(self.dirtyPartitions.length===0){callback(null)}else{self.saveNextPartition(callback)}})};LokiPartitioningAdapter.prototype.saveNextPage=function(callback){var self=this;var coll=this.dbref.collections[this.pageIterator.collection];var keyname=this.dbname+"."+this.pageIterator.collection+"."+this.pageIterator.pageIndex;var pageLen=0,cdlen=coll.data.length,delimlen=this.options.delimiter.length;var serializedObject="",pageBuilder="";var doneWithPartition=false,doneWithPage=false;var pageSaveCallback=function(err){pageBuilder="";if(err){callback(err)}if(doneWithPartition){callback(null)}else{self.pageIterator.pageIndex++;self.saveNextPage(callback)}};if(coll.data.length===0){doneWithPartition=true}while(true){if(!doneWithPartition){serializedObject=JSON.stringify(coll.data[this.pageIterator.docIndex]);pageBuilder+=serializedObject;pageLen+=serializedObject.length;if(++this.pageIterator.docIndex>=cdlen)doneWithPartition=true}if(pageLen>=this.options.pageSize)doneWithPage=true;if(!doneWithPage||doneWithPartition){pageBuilder+=this.options.delimiter;pageLen+=delimlen}if(doneWithPartition||doneWithPage){this.adapter.saveDatabase(keyname,pageBuilder,pageSaveCallback);return}}};function LokiFsAdapter(){this.fs=require("fs")}LokiFsAdapter.prototype.loadDatabase=function loadDatabase(dbname,callback){var self=this;this.fs.stat(dbname,function(err,stats){if(!err&&stats.isFile()){self.fs.readFile(dbname,{encoding:"utf8"},function readFileCallback(err,data){if(err){callback(new Error(err))}else{callback(data)}})}else{callback(null)}})};LokiFsAdapter.prototype.saveDatabase=function saveDatabase(dbname,dbstring,callback){var self=this;var tmpdbname=dbname+"~";this.fs.writeFile(tmpdbname,dbstring,function writeFileCallback(err){if(err){callback(new Error(err))}else{self.fs.rename(tmpdbname,dbname,callback)}})};LokiFsAdapter.prototype.deleteDatabase=function deleteDatabase(dbname,callback){this.fs.unlink(dbname,function deleteDatabaseCallback(err){if(err){callback(new Error(err))}else{callback()}})};function LokiLocalStorageAdapter(){}LokiLocalStorageAdapter.prototype.loadDatabase=function loadDatabase(dbname,callback){if(localStorageAvailable()){callback(localStorage.getItem(dbname))}else{callback(new Error("localStorage is not available"))}};LokiLocalStorageAdapter.prototype.saveDatabase=function saveDatabase(dbname,dbstring,callback){if(localStorageAvailable()){localStorage.setItem(dbname,dbstring);callback(null)}else{callback(new Error("localStorage is not available"))}};LokiLocalStorageAdapter.prototype.deleteDatabase=function deleteDatabase(dbname,callback){if(localStorageAvailable()){localStorage.removeItem(dbname);callback(null)}else{callback(new Error("localStorage is not available"))}};Loki.prototype.throttledSaveDrain=function(callback,options){var self=this;var now=(new Date).getTime();if(!this.throttledSaves){callback(true)}options=options||{};if(!options.hasOwnProperty("recursiveWait")){options.recursiveWait=true}if(!options.hasOwnProperty("recursiveWaitLimit")){options.recursiveWaitLimit=false}if(!options.hasOwnProperty("recursiveWaitLimitDuration")){options.recursiveWaitLimitDuration=2e3}if(!options.hasOwnProperty("started")){options.started=(new Date).getTime()}if(this.throttledSaves&&this.throttledSavePending){if(options.recursiveWait){this.throttledCallbacks.push(function(){if(self.throttledSavePending){if(options.recursiveWaitLimit&&now-options.started>options.recursiveWaitLimitDuration){callback(false);return}self.throttledSaveDrain(callback,options);return}else{callback(true);return}})}else{this.throttledCallbacks.push(callback);return}}else{callback(true)}};Loki.prototype.loadDatabaseInternal=function(options,callback){var cFun=callback||function(err,data){if(err){throw err}},self=this;if(this.persistenceAdapter!==null){this.persistenceAdapter.loadDatabase(this.filename,function loadDatabaseCallback(dbString){if(typeof dbString==="string"){var parseSuccess=false;try{self.loadJSON(dbString,options||{});parseSuccess=true}catch(err){cFun(err)}if(parseSuccess){cFun(null);self.emit("loaded","database "+self.filename+" loaded")}}else{if(!dbString){cFun(null);self.emit("loaded","empty database "+self.filename+" loaded");return}if(dbString instanceof Error){cFun(dbString);return}if(typeof dbString==="object"){self.loadJSONObject(dbString,options||{});cFun(null);self.emit("loaded","database "+self.filename+" loaded");return}cFun("unexpected adapter response : "+dbString)}})}else{cFun(new Error("persistenceAdapter not configured"))}};Loki.prototype.loadDatabase=function(options,callback){var self=this;if(!this.throttledSaves){this.loadDatabaseInternal(options,callback);return}this.throttledSaveDrain(function(success){if(success){self.throttledSavePending=true;self.loadDatabaseInternal(options,function(err){if(self.throttledCallbacks.length===0){self.throttledSavePending=false}else{self.saveDatabase()}if(typeof callback==="function"){callback(err)}});return}else{if(typeof callback==="function"){callback(new Error("Unable to pause save throttling long enough to read database"))}}},options)};Loki.prototype.saveDatabaseInternal=function(callback){var cFun=callback||function(err){if(err){throw err}return},self=this;if(this.persistenceAdapter!==null){if(this.persistenceAdapter.mode==="reference"&&typeof this.persistenceAdapter.exportDatabase==="function"){this.persistenceAdapter.exportDatabase(this.filename,this.copy({removeNonSerializable:true}),function exportDatabaseCallback(err){self.autosaveClearFlags();cFun(err)})}else{this.persistenceAdapter.saveDatabase(this.filename,self.serialize(),function saveDatabasecallback(err){self.autosaveClearFlags();cFun(err)})}}else{cFun(new Error("persistenceAdapter not configured"))}};Loki.prototype.saveDatabase=function(callback){if(!this.throttledSaves){this.saveDatabaseInternal(callback);return}if(this.throttledSavePending){this.throttledCallbacks.push(callback);return}var localCallbacks=this.throttledCallbacks;this.throttledCallbacks=[];localCallbacks.unshift(callback);this.throttledSavePending=true;var self=this;this.saveDatabaseInternal(function(err){self.throttledSavePending=false;localCallbacks.forEach(function(pcb){if(typeof pcb==="function"){setTimeout(function(){pcb(err)},1)}});if(self.throttledCallbacks.length>0){self.saveDatabase()}})};Loki.prototype.save=Loki.prototype.saveDatabase;Loki.prototype.deleteDatabase=function(options,callback){var cFun=callback||function(err,data){if(err){throw err}};if(typeof options==="function"&&!callback){cFun=options}if(this.persistenceAdapter!==null){this.persistenceAdapter.deleteDatabase(this.filename,function deleteDatabaseCallback(err){cFun(err)})}else{cFun(new Error("persistenceAdapter not configured"))}};Loki.prototype.autosaveDirty=function(){for(var idx=0;idx<this.collections.length;idx++){if(this.collections[idx].dirty){return true}}return false};Loki.prototype.autosaveClearFlags=function(){for(var idx=0;idx<this.collections.length;idx++){this.collections[idx].dirty=false}};Loki.prototype.autosaveEnable=function(options,callback){this.autosave=true;var delay=5e3,self=this;if(typeof this.autosaveInterval!=="undefined"&&this.autosaveInterval!==null){delay=this.autosaveInterval}this.autosaveHandle=setInterval(function autosaveHandleInterval(){if(self.autosaveDirty()){self.saveDatabase(callback)}},delay)};Loki.prototype.autosaveDisable=function(){if(typeof this.autosaveHandle!=="undefined"&&this.autosaveHandle!==null){clearInterval(this.autosaveHandle);this.autosaveHandle=null}};function Resultset(collection,options){options=options||{};this.collection=collection;this.filteredrows=[];this.filterInitialized=false;return this}Resultset.prototype.reset=function(){if(this.filteredrows.length>0){this.filteredrows=[]}this.filterInitialized=false;return this}
;Resultset.prototype.toJSON=function(){var copy=this.copy();copy.collection=null;return copy};Resultset.prototype.limit=function(qty){if(!this.filterInitialized&&this.filteredrows.length===0){this.filteredrows=this.collection.prepareFullDocIndex()}var rscopy=new Resultset(this.collection);rscopy.filteredrows=this.filteredrows.slice(0,qty);rscopy.filterInitialized=true;return rscopy};Resultset.prototype.offset=function(pos){if(!this.filterInitialized&&this.filteredrows.length===0){this.filteredrows=this.collection.prepareFullDocIndex()}var rscopy=new Resultset(this.collection);rscopy.filteredrows=this.filteredrows.slice(pos);rscopy.filterInitialized=true;return rscopy};Resultset.prototype.copy=function(){var result=new Resultset(this.collection);if(this.filteredrows.length>0){result.filteredrows=this.filteredrows.slice()}result.filterInitialized=this.filterInitialized;return result};Resultset.prototype.branch=Resultset.prototype.copy;Resultset.prototype.transform=function(transform,parameters){var idx,step,rs=this;if(typeof transform==="string"){if(this.collection.transforms.hasOwnProperty(transform)){transform=this.collection.transforms[transform]}}if(typeof transform!=="object"||!Array.isArray(transform)){throw new Error("Invalid transform")}if(typeof parameters!=="undefined"){transform=Utils.resolveTransformParams(transform,parameters)}for(idx=0;idx<transform.length;idx++){step=transform[idx];switch(step.type){case"find":rs.find(step.value);break;case"where":rs.where(step.value);break;case"simplesort":rs.simplesort(step.property,step.desc);break;case"compoundsort":rs.compoundsort(step.value);break;case"sort":rs.sort(step.value);break;case"limit":rs=rs.limit(step.value);break;case"offset":rs=rs.offset(step.value);break;case"map":rs=rs.map(step.value,step.dataOptions);break;case"eqJoin":rs=rs.eqJoin(step.joinData,step.leftJoinKey,step.rightJoinKey,step.mapFun,step.dataOptions);break;case"mapReduce":rs=rs.mapReduce(step.mapFunction,step.reduceFunction);break;case"update":rs.update(step.value);break;case"remove":rs.remove();break;default:break}}return rs};Resultset.prototype.sort=function(comparefun){if(!this.filterInitialized&&this.filteredrows.length===0){this.filteredrows=this.collection.prepareFullDocIndex()}var wrappedComparer=function(userComparer,data){return function(a,b){return userComparer(data[a],data[b])}}(comparefun,this.collection.data);this.filteredrows.sort(wrappedComparer);return this};Resultset.prototype.simplesort=function(propname,isdesc){if(typeof isdesc==="undefined"){isdesc=false}if(!this.filterInitialized&&this.filteredrows.length===0){if(this.collection.binaryIndices.hasOwnProperty(propname)){this.collection.ensureIndex(propname);this.filteredrows=this.collection.binaryIndices[propname].values.slice(0);if(isdesc){this.filteredrows.reverse()}return this}else{this.filteredrows=this.collection.prepareFullDocIndex()}}var wrappedComparer=function(prop,desc,data){var val1,val2,arr;return function(a,b){if(~prop.indexOf(".")){arr=prop.split(".");val1=arr.reduce(function(obj,i){return obj&&obj[i]||undefined},data[a]);val2=arr.reduce(function(obj,i){return obj&&obj[i]||undefined},data[b])}else{val1=data[a][prop];val2=data[b][prop]}return sortHelper(val1,val2,desc)}}(propname,isdesc,this.collection.data);this.filteredrows.sort(wrappedComparer);return this};Resultset.prototype.compoundsort=function(properties){if(properties.length===0){throw new Error("Invalid call to compoundsort, need at least one property")}var prop;if(properties.length===1){prop=properties[0];if(Array.isArray(prop)){return this.simplesort(prop[0],prop[1])}return this.simplesort(prop,false)}for(var i=0,len=properties.length;i<len;i+=1){prop=properties[i];if(!Array.isArray(prop)){properties[i]=[prop,false]}}if(!this.filterInitialized&&this.filteredrows.length===0){this.filteredrows=this.collection.prepareFullDocIndex()}var wrappedComparer=function(props,data){return function(a,b){return compoundeval(props,data[a],data[b])}}(properties,this.collection.data);this.filteredrows.sort(wrappedComparer);return this};Resultset.prototype.findOr=function(expressionArray){var fr=null,fri=0,frlen=0,docset=[],idxset=[],idx=0,origCount=this.count();for(var ei=0,elen=expressionArray.length;ei<elen;ei++){fr=this.branch().find(expressionArray[ei]).filteredrows;frlen=fr.length;if(frlen===origCount){return this}for(fri=0;fri<frlen;fri++){idx=fr[fri];if(idxset[idx]===undefined){idxset[idx]=true;docset.push(idx)}}}this.filteredrows=docset;this.filterInitialized=true;return this};Resultset.prototype.$or=Resultset.prototype.findOr;Resultset.prototype.findAnd=function(expressionArray){for(var i=0,len=expressionArray.length;i<len;i++){if(this.count()===0){return this}this.find(expressionArray[i])}return this};Resultset.prototype.$and=Resultset.prototype.findAnd;Resultset.prototype.find=function(query,firstOnly){if(this.collection.data.length===0){this.filteredrows=[];this.filterInitialized=true;return this}var queryObject=query||"getAll",p,property,queryObjectOp,obj,operator,value,key,searchByIndex=false,result=[],filters=[],index=null;firstOnly=firstOnly||false;if(typeof queryObject==="object"){for(p in queryObject){obj={};obj[p]=queryObject[p];filters.push(obj);if(hasOwnProperty.call(queryObject,p)){property=p;queryObjectOp=queryObject[p]}}if(filters.length>1){return this.find({$and:filters},firstOnly)}}if(!property||queryObject==="getAll"){if(firstOnly){this.filteredrows=this.collection.data.length>0?[0]:[];this.filterInitialized=true}return this}if(property==="$and"||property==="$or"){this[property](queryObjectOp);if(firstOnly&&this.filteredrows.length>1){this.filteredrows=this.filteredrows.slice(0,1)}return this}if(queryObjectOp===null||(typeof queryObjectOp!=="object"||queryObjectOp instanceof Date)){operator="$eq";value=queryObjectOp}else if(typeof queryObjectOp==="object"){for(key in queryObjectOp){if(hasOwnProperty.call(queryObjectOp,key)){operator=key;value=queryObjectOp[key];break}}}else{throw new Error("Do not know what you want to do.")}if(operator==="$regex"){if(Array.isArray(value)){value=new RegExp(value[0],value[1])}else if(!(value instanceof RegExp)){value=new RegExp(value)}}var usingDotNotation=property.indexOf(".")!==-1;var doIndexCheck=!usingDotNotation&&!this.filterInitialized;if(doIndexCheck&&this.collection.binaryIndices[property]&&indexedOps[operator]){if(this.collection.adaptiveBinaryIndices!==true){this.collection.ensureIndex(property)}searchByIndex=true;index=this.collection.binaryIndices[property]}var fun=LokiOps[operator];var t=this.collection.data;var i=0,len=0;var filter,rowIdx=0;if(this.filterInitialized){filter=this.filteredrows;len=filter.length;if(usingDotNotation){property=property.split(".");for(i=0;i<len;i++){rowIdx=filter[i];if(dotSubScan(t[rowIdx],property,fun,value)){result.push(rowIdx)}}}else{for(i=0;i<len;i++){rowIdx=filter[i];if(fun(t[rowIdx][property],value)){result.push(rowIdx)}}}}else{if(!searchByIndex){len=t.length;if(usingDotNotation){property=property.split(".");for(i=0;i<len;i++){if(dotSubScan(t[i],property,fun,value)){result.push(i);if(firstOnly){this.filteredrows=result;this.filterInitialized=true;return this}}}}else{for(i=0;i<len;i++){if(fun(t[i][property],value)){result.push(i);if(firstOnly){this.filteredrows=result;this.filterInitialized=true;return this}}}}}else{var segm=this.collection.calculateRange(operator,property,value);if(operator!=="$in"){for(i=segm[0];i<=segm[1];i++){if(indexedOps[operator]!==true){if(indexedOps[operator](t[index.values[i]][property],value)){result.push(index.values[i]);if(firstOnly){this.filteredrows=result;this.filterInitialized=true;return this}}}else{result.push(index.values[i]);if(firstOnly){this.filteredrows=result;this.filterInitialized=true;return this}}}}else{for(i=0,len=segm.length;i<len;i++){result.push(index.values[segm[i]]);if(firstOnly){this.filteredrows=result;this.filterInitialized=true;return this}}}}}this.filteredrows=result;this.filterInitialized=true;return this};Resultset.prototype.where=function(fun){var viewFunction,result=[];if("function"===typeof fun){viewFunction=fun}else{throw new TypeError("Argument is not a stored view or a function")}try{if(this.filterInitialized){var j=this.filteredrows.length;while(j--){if(viewFunction(this.collection.data[this.filteredrows[j]])===true){result.push(this.filteredrows[j])}}this.filteredrows=result;return this}else{var k=this.collection.data.length;while(k--){if(viewFunction(this.collection.data[k])===true){result.push(k)}}this.filteredrows=result;this.filterInitialized=true;return this}}catch(err){throw err}};Resultset.prototype.count=function(){if(this.filterInitialized){return this.filteredrows.length}return this.collection.count()};Resultset.prototype.data=function(options){var result=[],data=this.collection.data,obj,len,i,method;options=options||{};if(options.removeMeta&&!options.forceClones){options.forceClones=true;options.forceCloneMethod=options.forceCloneMethod||"shallow"}if(!this.collection.disableDeltaChangesApi){options.forceClones=true;options.forceCloneMethod="parse-stringify"}if(!this.filterInitialized){if(this.filteredrows.length===0){if(this.collection.cloneObjects||options.forceClones){len=data.length;method=options.forceCloneMethod||this.collection.cloneMethod;for(i=0;i<len;i++){obj=clone(data[i],method);if(options.removeMeta){delete obj.$loki;delete obj.meta}result.push(obj)}return result}else{return data.slice()}}else{this.filterInitialized=true}}var fr=this.filteredrows;len=fr.length;if(this.collection.cloneObjects||options.forceClones){method=options.forceCloneMethod||this.collection.cloneMethod;for(i=0;i<len;i++){obj=clone(data[fr[i]],method);if(options.removeMeta){delete obj.$loki;delete obj.meta}result.push(obj)}}else{for(i=0;i<len;i++){result.push(data[fr[i]])}}return result};Resultset.prototype.update=function(updateFunction){if(typeof updateFunction!=="function"){throw new TypeError("Argument is not a function")}if(!this.filterInitialized&&this.filteredrows.length===0){this.filteredrows=this.collection.prepareFullDocIndex()}var len=this.filteredrows.length,rcd=this.collection.data;for(var idx=0;idx<len;idx++){updateFunction(rcd[this.filteredrows[idx]]);this.collection.update(rcd[this.filteredrows[idx]])}return this};Resultset.prototype.remove=function(){if(!this.filterInitialized&&this.filteredrows.length===0){this.filteredrows=this.collection.prepareFullDocIndex()}this.collection.remove(this.data());this.filteredrows=[];return this};Resultset.prototype.mapReduce=function(mapFunction,reduceFunction){try{return reduceFunction(this.data().map(mapFunction))}catch(err){throw err}};Resultset.prototype.eqJoin=function(joinData,leftJoinKey,rightJoinKey,mapFun,dataOptions){var leftData=[],leftDataLength,rightData=[],rightDataLength,key,result=[],leftKeyisFunction=typeof leftJoinKey==="function",rightKeyisFunction=typeof rightJoinKey==="function",joinMap={};leftData=this.data(dataOptions);leftDataLength=leftData.length;if(joinData instanceof Collection){rightData=joinData.chain().data(dataOptions)}else if(joinData instanceof Resultset){rightData=joinData.data(dataOptions)}else if(Array.isArray(joinData)){rightData=joinData}else{throw new TypeError("joinData needs to be an array or result set")}rightDataLength=rightData.length;for(var i=0;i<rightDataLength;i++){key=rightKeyisFunction?rightJoinKey(rightData[i]):rightData[i][rightJoinKey];joinMap[key]=rightData[i]}if(!mapFun){mapFun=function(left,right){return{left:left,right:right}}}for(var j=0;j<leftDataLength;j++){key=leftKeyisFunction?leftJoinKey(leftData[j]):leftData[j][leftJoinKey];result.push(mapFun(leftData[j],joinMap[key]||{}))}this.collection=new Collection("joinData");this.collection.insert(result);this.filteredrows=[];this.filterInitialized=false;return this};Resultset.prototype.map=function(mapFun,dataOptions){var data=this.data(dataOptions).map(mapFun);this.collection=new Collection("mappedData");this.collection.insert(data);this.filteredrows=[];this.filterInitialized=false;return this};function DynamicView(collection,name,options){this.collection=collection;this.name=name;this.rebuildPending=false;this.options=options||{};if(!this.options.hasOwnProperty("persistent")){this.options.persistent=false}if(!this.options.hasOwnProperty("sortPriority")){this.options.sortPriority="passive"}if(!this.options.hasOwnProperty("minRebuildInterval")){this.options.minRebuildInterval=1}this.resultset=new Resultset(collection);this.resultdata=[];this.resultsdirty=false;this.cachedresultset=null;this.filterPipeline=[];this.sortFunction=null;this.sortCriteria=null;this.sortDirty=false;this.events={rebuild:[]}}DynamicView.prototype=new LokiEventEmitter;DynamicView.prototype.rematerialize=function(options){var fpl,fpi,idx;options=options||{};this.resultdata=[];this.resultsdirty=true;this.resultset=new Resultset(this.collection);if(this.sortFunction||this.sortCriteria){this.sortDirty=true}if(options.hasOwnProperty("removeWhereFilters")){fpl=this.filterPipeline.length;fpi=fpl;while(fpi--){if(this.filterPipeline[fpi].type==="where"){if(fpi!==this.filterPipeline.length-1){this.filterPipeline[fpi]=this.filterPipeline[this.filterPipeline.length-1]}this.filterPipeline.length--}}}var ofp=this.filterPipeline;this.filterPipeline=[];fpl=ofp.length;for(idx=0;idx<fpl;idx++){this.applyFind(ofp[idx].val)}this.data();this.emit("rebuild",this);return this};DynamicView.prototype.branchResultset=function(transform,parameters){var rs=this.resultset.branch();if(typeof transform==="undefined"){return rs}return rs.transform(transform,parameters)};DynamicView.prototype.toJSON=function(){var copy=new DynamicView(this.collection,this.name,this.options);copy.resultset=this.resultset;copy.resultdata=[];copy.resultsdirty=true;copy.filterPipeline=this.filterPipeline;copy.sortFunction=this.sortFunction;copy.sortCriteria=this.sortCriteria;copy.sortDirty=this.sortDirty;copy.collection=null;return copy};DynamicView.prototype.removeFilters=function(options){options=options||{};this.rebuildPending=false;this.resultset.reset();this.resultdata=[];this.resultsdirty=true;this.cachedresultset=null;this.filterPipeline=[];this.sortFunction=null;this.sortCriteria=null;this.sortDirty=false;if(options.queueSortPhase===true){this.queueSortPhase()}};DynamicView.prototype.applySort=function(comparefun){this.sortFunction=comparefun;this.sortCriteria=null;this.queueSortPhase();return this};DynamicView.prototype.applySimpleSort=function(propname,isdesc){this.sortCriteria=[[propname,isdesc||false]];this.sortFunction=null;this.queueSortPhase();return this};DynamicView.prototype.applySortCriteria=function(criteria){this.sortCriteria=criteria;this.sortFunction=null;this.queueSortPhase();return this};DynamicView.prototype.startTransaction=function(){this.cachedresultset=this.resultset.copy();return this};DynamicView.prototype.commit=function(){this.cachedresultset=null;return this};DynamicView.prototype.rollback=function(){this.resultset=this.cachedresultset;if(this.options.persistent){this.resultdata=this.resultset.data();this.emit("rebuild",this)}return this};DynamicView.prototype._indexOfFilterWithId=function(uid){if(typeof uid==="string"||typeof uid==="number"){for(var idx=0,len=this.filterPipeline.length;idx<len;idx+=1){if(uid===this.filterPipeline[idx].uid){return idx}}}return-1};DynamicView.prototype._addFilter=function(filter){this.filterPipeline.push(filter);this.resultset[filter.type](filter.val)};DynamicView.prototype.reapplyFilters=function(){this.resultset.reset();this.cachedresultset=null;if(this.options.persistent){this.resultdata=[];this.resultsdirty=true}var filters=this.filterPipeline;this.filterPipeline=[];for(var idx=0,len=filters.length;idx<len;idx+=1){this._addFilter(filters[idx])}if(this.sortFunction||this.sortCriteria){this.queueSortPhase()}else{this.queueRebuildEvent()}return this};DynamicView.prototype.applyFilter=function(filter){var idx=this._indexOfFilterWithId(filter.uid);if(idx>=0){this.filterPipeline[idx]=filter;return this.reapplyFilters()}this.cachedresultset=null;if(this.options.persistent){this.resultdata=[];this.resultsdirty=true}this._addFilter(filter);if(this.sortFunction||this.sortCriteria){this.queueSortPhase()}else{this.queueRebuildEvent()}return this};DynamicView.prototype.applyFind=function(query,uid){this.applyFilter({type:"find",val:query,uid:uid});return this};DynamicView.prototype.applyWhere=function(fun,uid){this.applyFilter({type:"where",val:fun,uid:uid});return this};DynamicView.prototype.removeFilter=function(uid){var idx=this._indexOfFilterWithId(uid);if(idx<0){throw new Error("Dynamic view does not contain a filter with ID: "+uid)}this.filterPipeline.splice(idx,1);this.reapplyFilters();return this};DynamicView.prototype.count=function(){if(this.resultsdirty){this.resultdata=this.resultset.data()}return this.resultset.count()};DynamicView.prototype.data=function(options){if(this.sortDirty||this.resultsdirty){this.performSortPhase({suppressRebuildEvent:true})}return this.options.persistent?this.resultdata:this.resultset.data(options)};DynamicView.prototype.queueRebuildEvent=function(){if(this.rebuildPending){return}this.rebuildPending=true;var self=this;setTimeout(function(){if(self.rebuildPending){self.rebuildPending=false;self.emit("rebuild",self)}},this.options.minRebuildInterval)};DynamicView.prototype.queueSortPhase=function(){if(this.sortDirty){return}this.sortDirty=true;var self=this;if(this.options.sortPriority==="active"){setTimeout(function(){self.performSortPhase()},this.options.minRebuildInterval)}else{this.queueRebuildEvent()}};DynamicView.prototype.performSortPhase=function(options){if(!this.sortDirty&&!this.resultsdirty){return}options=options||{};if(this.sortDirty){if(this.sortFunction){this.resultset.sort(this.sortFunction)}else if(this.sortCriteria){this.resultset.compoundsort(this.sortCriteria)}this.sortDirty=false}if(this.options.persistent){this.resultdata=this.resultset.data();this.resultsdirty=false}if(!options.suppressRebuildEvent){this.emit("rebuild",this)}};DynamicView.prototype.evaluateDocument=function(objIndex,isNew){if(!this.resultset.filterInitialized){if(this.options.persistent){this.resultdata=this.resultset.data()}if(this.sortFunction||this.sortCriteria){this.queueSortPhase()}else{this.queueRebuildEvent()}return}var ofr=this.resultset.filteredrows;var oldPos=isNew?-1:ofr.indexOf(+objIndex);var oldlen=ofr.length;var evalResultset=new Resultset(this.collection);evalResultset.filteredrows=[objIndex];evalResultset.filterInitialized=true;var filter;for(var idx=0,len=this.filterPipeline.length;idx<len;idx++){filter=this.filterPipeline[idx];evalResultset[filter.type](filter.val)}var newPos=evalResultset.filteredrows.length===0?-1:0;if(oldPos===-1&&newPos===-1)return;if(oldPos===-1&&newPos!==-1){ofr.push(objIndex);if(this.options.persistent){this.resultdata.push(this.collection.data[objIndex])}if(this.sortFunction||this.sortCriteria){this.queueSortPhase()}else{this.queueRebuildEvent()}return}if(oldPos!==-1&&newPos===-1){if(oldPos<oldlen-1){ofr.splice(oldPos,1);if(this.options.persistent){this.resultdata.splice(oldPos,1)}}else{ofr.length=oldlen-1;if(this.options.persistent){this.resultdata.length=oldlen-1}}if(this.sortFunction||this.sortCriteria){this.queueSortPhase()}else{this.queueRebuildEvent()}return}if(oldPos!==-1&&newPos!==-1){if(this.options.persistent){this.resultdata[oldPos]=this.collection.data[objIndex]}if(this.sortFunction||this.sortCriteria){this.queueSortPhase()}else{this.queueRebuildEvent()}return}};DynamicView.prototype.removeDocument=function(objIndex){if(!this.resultset.filterInitialized){if(this.options.persistent){this.resultdata=this.resultset.data()}if(this.sortFunction||this.sortCriteria){this.queueSortPhase()}else{this.queueRebuildEvent()}return}var ofr=this.resultset.filteredrows;var oldPos=ofr.indexOf(+objIndex);var oldlen=ofr.length;var idx;if(oldPos!==-1){if(oldPos<oldlen-1){ofr[oldPos]=ofr[oldlen-1];ofr.length=oldlen-1;if(this.options.persistent){this.resultdata[oldPos]=this.resultdata[oldlen-1];this.resultdata.length=oldlen-1}}else{ofr.length=oldlen-1;if(this.options.persistent){this.resultdata.length=oldlen-1}}if(this.sortFunction||this.sortCriteria){this.queueSortPhase()}else{this.queueRebuildEvent()}}oldlen=ofr.length;for(idx=0;idx<oldlen;idx++){if(ofr[idx]>objIndex){ofr[idx]--}}};DynamicView.prototype.mapReduce=function(mapFunction,reduceFunction){try{return reduceFunction(this.data().map(mapFunction))}catch(err){throw err}};function Collection(name,options){this.name=name;this.data=[];this.idIndex=[];this.binaryIndices={};this.constraints={unique:{},exact:{}};this.uniqueNames=[];this.transforms={};this.objType=name;this.dirty=true;this.cachedIndex=null;this.cachedBinaryIndex=null;this.cachedData=null;var self=this;options=options||{};if(options.hasOwnProperty("unique")){if(!Array.isArray(options.unique)){options.unique=[options.unique]}options.unique.forEach(function(prop){self.uniqueNames.push(prop);self.constraints.unique[prop]=new UniqueIndex(prop)})}if(options.hasOwnProperty("exact")){options.exact.forEach(function(prop){self.constraints.exact[prop]=new ExactIndex(prop)})}this.adaptiveBinaryIndices=options.hasOwnProperty("adaptiveBinaryIndices")?options.adaptiveBinaryIndices:true;this.transactional=options.hasOwnProperty("transactional")?options.transactional:false;this.cloneObjects=options.hasOwnProperty("clone")?options.clone:false;this.cloneMethod=options.hasOwnProperty("cloneMethod")?options.cloneMethod:"parse-stringify";this.asyncListeners=options.hasOwnProperty("asyncListeners")?options.asyncListeners:false;this.disableChangesApi=options.hasOwnProperty("disableChangesApi")?options.disableChangesApi:true;this.disableDeltaChangesApi=options.hasOwnProperty("disableDeltaChangesApi")?options.disableDeltaChangesApi:true;if(this.disableChangesApi){this.disableDeltaChangesApi=true}this.autoupdate=options.hasOwnProperty("autoupdate")?options.autoupdate:false;this.serializableIndices=options.hasOwnProperty("serializableIndices")?options.serializableIndices:true;this.ttl={age:null,ttlInterval:null,daemon:null};this.setTTL(options.ttl||-1,options.ttlInterval);this.maxId=0;this.DynamicViews=[];this.events={insert:[],update:[],"pre-insert":[],"pre-update":[],close:[],flushbuffer:[],error:[],delete:[],warning:[]};this.changes=[];this.ensureId();var indices=[];if(options&&options.indices){if(Object.prototype.toString.call(options.indices)==="[object Array]"){indices=options.indices}else if(typeof options.indices==="string"){indices=[options.indices]}else{throw new TypeError("Indices needs to be a string or an array of strings")}}for(var idx=0;idx<indices.length;idx++){this.ensureIndex(indices[idx])}function observerCallback(changes){var changedObjects=typeof Set==="function"?new Set:[];if(!changedObjects.add)changedObjects.add=function(object){if(this.indexOf(object)===-1)this.push(object);return this};changes.forEach(function(change){changedObjects.add(change.object)});changedObjects.forEach(function(object){if(!hasOwnProperty.call(object,"$loki"))return self.removeAutoUpdateObserver(object);try{self.update(object)}catch(err){}})}this.observerCallback=observerCallback;function createChange(name,op,obj,old){self.changes.push({name:name,operation:op,obj:op=="U"&&!self.disableDeltaChangesApi?getChangeDelta(obj,old):JSON.parse(JSON.stringify(obj))})}function getChangeDelta(obj,old){if(old){return getObjectDelta(old,obj)}else{return JSON.parse(JSON.stringify(obj))}}this.getChangeDelta=getChangeDelta;function getObjectDelta(oldObject,newObject){var propertyNames=newObject!==null&&typeof newObject==="object"?Object.keys(newObject):null;if(propertyNames&&propertyNames.length&&["string","boolean","number"].indexOf(typeof newObject)<0){var delta={};for(var i=0;i<propertyNames.length;i++){var propertyName=propertyNames[i];if(newObject.hasOwnProperty(propertyName)){if(!oldObject.hasOwnProperty(propertyName)||self.uniqueNames.indexOf(propertyName)>=0||propertyName=="$loki"||propertyName=="meta"){delta[propertyName]=newObject[propertyName]}else{var propertyDelta=getObjectDelta(oldObject[propertyName],newObject[propertyName]);if(typeof propertyDelta!=="undefined"&&propertyDelta!={}){delta[propertyName]=propertyDelta}}}}return Object.keys(delta).length===0?undefined:delta}else{return oldObject===newObject?undefined:newObject}}this.getObjectDelta=getObjectDelta;function flushChanges(){self.changes=[]}this.getChanges=function(){return self.changes};this.flushChanges=flushChanges;function insertMeta(obj){var len,idx;if(!obj){return}if(Array.isArray(obj)){len=obj.length;for(idx=0;idx<len;idx++){if(!obj[idx].hasOwnProperty("meta")){obj[idx].meta={}}obj[idx].meta.created=(new Date).getTime();obj[idx].meta.revision=0}return}if(!obj.meta){obj.meta={}}obj.meta.created=(new Date).getTime();obj.meta.revision=0}function updateMeta(obj){if(!obj){return}obj.meta.updated=(new Date).getTime();obj.meta.revision+=1}function createInsertChange(obj){createChange(self.name,"I",obj)}function createUpdateChange(obj,old){createChange(self.name,"U",obj,old)}function insertMetaWithChange(obj){insertMeta(obj);createInsertChange(obj)}function updateMetaWithChange(obj,old){updateMeta(obj);createUpdateChange(obj,old)}var insertHandler,updateHandler;function setHandlers(){insertHandler=self.disableChangesApi?insertMeta:insertMetaWithChange;updateHandler=self.disableChangesApi?updateMeta:updateMetaWithChange}setHandlers();this.setChangesApi=function(enabled){self.disableChangesApi=!enabled;if(!enabled){self.disableDeltaChangesApi=false}setHandlers()};this.on("insert",function insertCallback(obj){insertHandler(obj)});this.on("update",function updateCallback(obj,old){updateHandler(obj,old)});this.on("delete",function deleteCallback(obj){if(!self.disableChangesApi){createChange(self.name,"R",obj)}});this.on("warning",function(warning){self.console.warn(warning)});flushChanges()}Collection.prototype=new LokiEventEmitter;Collection.prototype.console={log:function(){},warn:function(){},error:function(){}};Collection.prototype.addAutoUpdateObserver=function(object){if(!this.autoupdate||typeof Object.observe!=="function")return;Object.observe(object,this.observerCallback,["add","update","delete","reconfigure","setPrototype"])};Collection.prototype.removeAutoUpdateObserver=function(object){if(!this.autoupdate||typeof Object.observe!=="function")return;Object.unobserve(object,this.observerCallback)};Collection.prototype.addTransform=function(name,transform){if(this.transforms.hasOwnProperty(name)){throw new Error("a transform by that name already exists")}this.transforms[name]=transform};Collection.prototype.getTransform=function(name){return this.transforms[name]};Collection.prototype.setTransform=function(name,transform){this.transforms[name]=transform};Collection.prototype.removeTransform=function(name){delete this.transforms[name]};Collection.prototype.byExample=function(template){var k,obj,query;query=[];for(k in template){if(!template.hasOwnProperty(k))continue;query.push((obj={},obj[k]=template[k],obj))}return{$and:query}};Collection.prototype.findObject=function(template){return this.findOne(this.byExample(template))};Collection.prototype.findObjects=function(template){return this.find(this.byExample(template))};Collection.prototype.ttlDaemonFuncGen=function(){var collection=this;var age=this.ttl.age;return function ttlDaemon(){var now=Date.now();var toRemove=collection.chain().where(function daemonFilter(member){var timestamp=member.meta.updated||member.meta.created;var diff=now-timestamp;return age<diff});toRemove.remove()}};Collection.prototype.setTTL=function(age,interval){if(age<0){clearInterval(this.ttl.daemon)}else{this.ttl.age=age;this.ttl.ttlInterval=interval;this.ttl.daemon=setInterval(this.ttlDaemonFuncGen(),interval)}};Collection.prototype.prepareFullDocIndex=function(){var len=this.data.length;var indexes=new Array(len);for(var i=0;i<len;i+=1){indexes[i]=i}return indexes};Collection.prototype.configureOptions=function(options){options=options||{};if(options.hasOwnProperty("adaptiveBinaryIndices")){this.adaptiveBinaryIndices=options.adaptiveBinaryIndices;if(this.adaptiveBinaryIndices){this.ensureAllIndexes()}}};Collection.prototype.ensureIndex=function(property,force){if(typeof force==="undefined"){force=false}if(property===null||property===undefined){throw new Error("Attempting to set index without an associated property")}if(this.binaryIndices[property]&&!force){if(!this.binaryIndices[property].dirty)return}if(this.adaptiveBinaryIndices===true&&this.binaryIndices.hasOwnProperty(property)&&!force){return}var index={name:property,dirty:true,values:this.prepareFullDocIndex()};this.binaryIndices[property]=index;var wrappedComparer=function(prop,data){var val1,val2,arr;return function(a,b){if(~prop.indexOf(".")){arr=prop.split(".");val1=arr.reduce(function(obj,i){return obj&&obj[i]||undefined},data[a]);val2=arr.reduce(function(obj,i){return obj&&obj[i]||undefined},data[b])}else{val1=data[a][prop];val2=data[b][prop]}if(val1!==val2){if(ltHelper(val1,val2,false))return-1;if(gtHelper(val1,val2,false))return 1}return 0}}(property,this.data);index.values.sort(wrappedComparer);index.dirty=false;this.dirty=true};Collection.prototype.getSequencedIndexValues=function(property){var idx,idxvals=this.binaryIndices[property].values;var result="";for(idx=0;idx<idxvals.length;idx++){result+=" ["+idx+"] "+this.data[idxvals[idx]][property]}return result};Collection.prototype.ensureUniqueIndex=function(field){var index=this.constraints.unique[field];if(!index){if(this.uniqueNames.indexOf(field)==-1){this.uniqueNames.push(field)}}this.constraints.unique[field]=index=new UniqueIndex(field);this.data.forEach(function(obj){index.set(obj)});return index};Collection.prototype.ensureAllIndexes=function(force){var key,bIndices=this.binaryIndices;for(key in bIndices){if(hasOwnProperty.call(bIndices,key)){this.ensureIndex(key,force)}}};Collection.prototype.flagBinaryIndexesDirty=function(){var key,bIndices=this.binaryIndices;for(key in bIndices){if(hasOwnProperty.call(bIndices,key)){bIndices[key].dirty=true}}};Collection.prototype.flagBinaryIndexDirty=function(index){if(this.binaryIndices[index])this.binaryIndices[index].dirty=true};Collection.prototype.count=function(query){if(!query){return this.data.length}return this.chain().find(query).filteredrows.length};Collection.prototype.ensureId=function(){var len=this.data.length,i=0;this.idIndex=[];for(i;i<len;i+=1){this.idIndex.push(this.data[i].$loki)}};Collection.prototype.ensureIdAsync=function(callback){this.async(function(){this.ensureId()},callback)};Collection.prototype.addDynamicView=function(name,options){var dv=new DynamicView(this,name,options);this.DynamicViews.push(dv);return dv};Collection.prototype.removeDynamicView=function(name){for(var idx=0;idx<this.DynamicViews.length;idx++){if(this.DynamicViews[idx].name===name){this.DynamicViews.splice(idx,1)}}};Collection.prototype.getDynamicView=function(name){for(var idx=0;idx<this.DynamicViews.length;idx++){if(this.DynamicViews[idx].name===name){return this.DynamicViews[idx]}}return null};Collection.prototype.findAndUpdate=function(filterObject,updateFunction){if(typeof filterObject==="function"){this.updateWhere(filterObject,updateFunction)}else{this.chain().find(filterObject).update(updateFunction)}};Collection.prototype.findAndRemove=function(filterObject){this.chain().find(filterObject).remove()};Collection.prototype.insert=function(doc){if(!Array.isArray(doc)){return this.insertOne(doc)}var obj;var results=[];this.emit("pre-insert",doc);for(var i=0,len=doc.length;i<len;i++){obj=this.insertOne(doc[i],true);if(!obj){return undefined}results.push(obj)}this.emit("insert",results);results=this.cloneObjects?clone(results,this.cloneMethod):results;return results.length===1?results[0]:results};Collection.prototype.insertOne=function(doc,bulkInsert){var err=null;var returnObj;if(typeof doc!=="object"){err=new TypeError("Document needs to be an object")}else if(doc===null){err=new TypeError("Object cannot be null")}if(err!==null){
this.emit("error",err);throw err}var obj=this.cloneObjects?clone(doc,this.cloneMethod):doc;if(typeof obj.meta==="undefined"){obj.meta={revision:0,created:0}}if(!bulkInsert){this.emit("pre-insert",obj)}if(!this.add(obj)){return undefined}returnObj=obj;if(!bulkInsert){this.emit("insert",obj);returnObj=this.cloneObjects?clone(obj,this.cloneMethod):obj}this.addAutoUpdateObserver(returnObj);return returnObj};Collection.prototype.clear=function(options){var self=this;options=options||{};this.data=[];this.idIndex=[];this.cachedIndex=null;this.cachedBinaryIndex=null;this.cachedData=null;this.maxId=0;this.DynamicViews=[];this.dirty=true;if(options.removeIndices===true){this.binaryIndices={};this.constraints={unique:{},exact:{}};this.uniqueNames=[]}else{var keys=Object.keys(this.binaryIndices);keys.forEach(function(biname){self.binaryIndices[biname].dirty=false;self.binaryIndices[biname].values=[]});this.constraints={unique:{},exact:{}};this.uniqueNames.forEach(function(uiname){self.ensureUniqueIndex(uiname)})}};Collection.prototype.update=function(doc){if(Array.isArray(doc)){var k=0,len=doc.length;for(k;k<len;k+=1){this.update(doc[k])}return}if(!hasOwnProperty.call(doc,"$loki")){throw new Error("Trying to update unsynced document. Please save the document first by using insert() or addMany()")}try{this.startTransaction();var arr=this.get(doc.$loki,true),oldInternal,newInternal,position,self=this;if(!arr){throw new Error("Trying to update a document not in collection.")}oldInternal=arr[0];position=arr[1];newInternal=this.cloneObjects||!this.disableDeltaChangesApi?clone(doc,this.cloneMethod):doc;this.emit("pre-update",doc);Object.keys(this.constraints.unique).forEach(function(key){self.constraints.unique[key].update(oldInternal,newInternal)});this.data[position]=newInternal;if(newInternal!==doc){this.addAutoUpdateObserver(doc)}for(var idx=0;idx<this.DynamicViews.length;idx++){this.DynamicViews[idx].evaluateDocument(position,false)}var key;if(this.adaptiveBinaryIndices){var bIndices=this.binaryIndices;for(key in bIndices){this.adaptiveBinaryIndexUpdate(position,key)}}else{this.flagBinaryIndexesDirty()}this.idIndex[position]=newInternal.$loki;this.commit();this.dirty=true;this.emit("update",doc,this.cloneObjects||!this.disableDeltaChangesApi?clone(oldInternal,this.cloneMethod):null);return doc}catch(err){this.rollback();this.console.error(err.message);this.emit("error",err);throw err}};Collection.prototype.add=function(obj){if("object"!==typeof obj){throw new TypeError("Object being added needs to be an object")}if(typeof obj.$loki!=="undefined"){throw new Error("Document is already in collection, please use update()")}try{this.startTransaction();this.maxId++;if(isNaN(this.maxId)){this.maxId=this.data[this.data.length-1].$loki+1}obj.$loki=this.maxId;obj.meta.version=0;var key,constrUnique=this.constraints.unique;for(key in constrUnique){if(hasOwnProperty.call(constrUnique,key)){constrUnique[key].set(obj)}}this.idIndex.push(obj.$loki);this.data.push(obj);var addedPos=this.data.length-1;var dvlen=this.DynamicViews.length;for(var i=0;i<dvlen;i++){this.DynamicViews[i].evaluateDocument(addedPos,true)}if(this.adaptiveBinaryIndices){var bIndices=this.binaryIndices;for(key in bIndices){this.adaptiveBinaryIndexInsert(addedPos,key)}}else{this.flagBinaryIndexesDirty()}this.commit();this.dirty=true;return this.cloneObjects?clone(obj,this.cloneMethod):obj}catch(err){this.rollback();this.console.error(err.message);this.emit("error",err);throw err}};Collection.prototype.updateWhere=function(filterFunction,updateFunction){var results=this.where(filterFunction),i=0,obj;try{for(i;i<results.length;i++){obj=updateFunction(results[i]);this.update(obj)}}catch(err){this.rollback();this.console.error(err.message)}};Collection.prototype.removeWhere=function(query){var list;if(typeof query==="function"){list=this.data.filter(query);this.remove(list)}else{this.chain().find(query).remove()}};Collection.prototype.removeDataOnly=function(){this.remove(this.data.slice())};Collection.prototype.remove=function(doc){if(typeof doc==="number"){doc=this.get(doc)}if("object"!==typeof doc){throw new Error("Parameter is not an object")}if(Array.isArray(doc)){var k=0,len=doc.length;for(k;k<len;k+=1){this.remove(doc[k])}return}if(!hasOwnProperty.call(doc,"$loki")){throw new Error("Object is not a document stored in the collection")}try{this.startTransaction();var arr=this.get(doc.$loki,true),position=arr[1];var self=this;Object.keys(this.constraints.unique).forEach(function(key){if(doc[key]!==null&&typeof doc[key]!=="undefined"){self.constraints.unique[key].remove(doc[key])}});for(var idx=0;idx<this.DynamicViews.length;idx++){this.DynamicViews[idx].removeDocument(position)}if(this.adaptiveBinaryIndices){var key,bIndices=this.binaryIndices;for(key in bIndices){this.adaptiveBinaryIndexRemove(position,key)}}else{this.flagBinaryIndexesDirty()}this.data.splice(position,1);this.removeAutoUpdateObserver(doc);this.idIndex.splice(position,1);this.commit();this.dirty=true;this.emit("delete",arr[0]);delete doc.$loki;delete doc.meta;return doc}catch(err){this.rollback();this.console.error(err.message);this.emit("error",err);return null}};Collection.prototype.get=function(id,returnPosition){var retpos=returnPosition||false,data=this.idIndex,max=data.length-1,min=0,mid=min+max>>1;id=typeof id==="number"?id:parseInt(id,10);if(isNaN(id)){throw new TypeError("Passed id is not an integer")}while(data[min]<data[max]){mid=min+max>>1;if(data[mid]<id){min=mid+1}else{max=mid}}if(max===min&&data[min]===id){if(retpos){return[this.data[min],min]}return this.data[min]}return null};Collection.prototype.getBinaryIndexPosition=function(dataPosition,binaryIndexName){var val=this.data[dataPosition][binaryIndexName];var index=this.binaryIndices[binaryIndexName].values;var range=this.calculateRange("$eq",binaryIndexName,val);if(range[0]===0&&range[1]===-1){return null}var min=range[0];var max=range[1];for(var idx=min;idx<=max;idx++){if(index[idx]===dataPosition)return idx}return null};Collection.prototype.adaptiveBinaryIndexInsert=function(dataPosition,binaryIndexName){var index=this.binaryIndices[binaryIndexName].values;var val=this.data[dataPosition][binaryIndexName];if(this.serializableIndices===true&&val instanceof Date){this.data[dataPosition][binaryIndexName]=val.getTime();val=this.data[dataPosition][binaryIndexName]}var idxPos=index.length===0?0:this.calculateRangeStart(binaryIndexName,val,true);this.binaryIndices[binaryIndexName].values.splice(idxPos,0,dataPosition)};Collection.prototype.adaptiveBinaryIndexUpdate=function(dataPosition,binaryIndexName){var idxPos,index=this.binaryIndices[binaryIndexName].values,len=index.length;for(idxPos=0;idxPos<len;idxPos++){if(index[idxPos]===dataPosition)break}this.binaryIndices[binaryIndexName].values.splice(idxPos,1);this.adaptiveBinaryIndexInsert(dataPosition,binaryIndexName)};Collection.prototype.adaptiveBinaryIndexRemove=function(dataPosition,binaryIndexName,removedFromIndexOnly){var idxPos=this.getBinaryIndexPosition(dataPosition,binaryIndexName);var index=this.binaryIndices[binaryIndexName].values;var len,idx;if(idxPos===null){return null}this.binaryIndices[binaryIndexName].values.splice(idxPos,1);if(removedFromIndexOnly===true){return}len=index.length;for(idx=0;idx<len;idx++){if(index[idx]>dataPosition){index[idx]--}}};Collection.prototype.calculateRangeStart=function(prop,val,adaptive){var rcd=this.data;var index=this.binaryIndices[prop].values;var min=0;var max=index.length-1;var mid=0;if(index.length===0){return-1}var minVal=rcd[index[min]][prop];var maxVal=rcd[index[max]][prop];while(min<max){mid=min+max>>1;if(ltHelper(rcd[index[mid]][prop],val,false)){min=mid+1}else{max=mid}}var lbound=min;if(aeqHelper(val,rcd[index[lbound]][prop])){return lbound}if(ltHelper(val,rcd[index[lbound]][prop],false)){return adaptive?lbound:lbound-1}return adaptive?lbound+1:lbound};Collection.prototype.calculateRangeEnd=function(prop,val){var rcd=this.data;var index=this.binaryIndices[prop].values;var min=0;var max=index.length-1;var mid=0;if(index.length===0){return-1}var minVal=rcd[index[min]][prop];var maxVal=rcd[index[max]][prop];while(min<max){mid=min+max>>1;if(ltHelper(val,rcd[index[mid]][prop],false)){max=mid}else{min=mid+1}}var ubound=max;if(aeqHelper(val,rcd[index[ubound]][prop])){return ubound}if(gtHelper(val,rcd[index[ubound]][prop],false)){return ubound+1}if(aeqHelper(val,rcd[index[ubound-1]][prop])){return ubound-1}return ubound};Collection.prototype.calculateRange=function(op,prop,val){var rcd=this.data;var index=this.binaryIndices[prop].values;var min=0;var max=index.length-1;var mid=0;var lbound,lval;var ubound,uval;if(rcd.length===0){return[0,-1]}var minVal=rcd[index[min]][prop];var maxVal=rcd[index[max]][prop];switch(op){case"$eq":case"$aeq":if(ltHelper(val,minVal,false)||gtHelper(val,maxVal,false)){return[0,-1]}break;case"$dteq":if(ltHelper(val,minVal,false)||gtHelper(val,maxVal,false)){return[0,-1]}break;case"$gt":if(gtHelper(val,maxVal,true)){return[0,-1]}if(gtHelper(minVal,val,false)){return[min,max]}break;case"$gte":if(gtHelper(val,maxVal,false)){return[0,-1]}if(gtHelper(minVal,val,true)){return[min,max]}break;case"$lt":if(ltHelper(val,minVal,true)){return[0,-1]}if(ltHelper(maxVal,val,false)){return[min,max]}break;case"$lte":if(ltHelper(val,minVal,false)){return[0,-1]}if(ltHelper(maxVal,val,true)){return[min,max]}break;case"$between":if(gtHelper(val[0],maxVal,false)){return[0,-1]}if(ltHelper(val[1],minVal,false)){return[0,-1]}lbound=this.calculateRangeStart(prop,val[0]);ubound=this.calculateRangeEnd(prop,val[1]);if(lbound<0)lbound++;if(ubound>max)ubound--;if(!gtHelper(rcd[index[lbound]][prop],val[0],true))lbound++;if(!ltHelper(rcd[index[ubound]][prop],val[1],true))ubound--;if(ubound<lbound)return[0,-1];return[lbound,ubound];case"$in":var idxset=[],segResult=[];for(var j=0,len=val.length;j<len;j++){var seg=this.calculateRange("$eq",prop,val[j]);for(var i=seg[0];i<=seg[1];i++){if(idxset[i]===undefined){idxset[i]=true;segResult.push(i)}}}return segResult}switch(op){case"$eq":case"$aeq":case"$dteq":case"$gte":case"$lt":lbound=this.calculateRangeStart(prop,val);lval=rcd[index[lbound]][prop];break;default:break}switch(op){case"$eq":case"$aeq":case"$dteq":case"$lte":case"$gt":ubound=this.calculateRangeEnd(prop,val);uval=rcd[index[ubound]][prop];break;default:break}switch(op){case"$eq":case"$aeq":case"$dteq":if(!aeqHelper(lval,val)){return[0,-1]}return[lbound,ubound];case"$gt":if(!aeqHelper(rcd[index[ubound]][prop],val)){return[ubound,max]}return[ubound+1,max];case"$gte":if(!aeqHelper(rcd[index[lbound]][prop],val)){return[lbound+1,max]}return[lbound,max];case"$lt":if(!aeqHelper(rcd[index[lbound]][prop],val)){return[min,lbound]}return[min,lbound-1];case"$lte":if(!aeqHelper(rcd[index[ubound]][prop],val)){return[min,ubound-1]}return[min,ubound];default:return[0,rcd.length-1]}};Collection.prototype.by=function(field,value){var self;if(value===undefined){self=this;return function(value){return self.by(field,value)}}var result=this.constraints.unique[field].get(value);if(!this.cloneObjects){return result}else{return clone(result,this.cloneMethod)}};Collection.prototype.findOne=function(query){query=query||{};var result=this.chain().find(query,true).data();if(Array.isArray(result)&&result.length===0){return null}else{if(!this.cloneObjects){return result[0]}else{return clone(result[0],this.cloneMethod)}}};Collection.prototype.chain=function(transform,parameters){var rs=new Resultset(this);if(typeof transform==="undefined"){return rs}return rs.transform(transform,parameters)};Collection.prototype.find=function(query){return this.chain().find(query).data()};Collection.prototype.findOneUnindexed=function(prop,value){var i=this.data.length,doc;while(i--){if(this.data[i][prop]===value){doc=this.data[i];return doc}}return null};Collection.prototype.startTransaction=function(){if(this.transactional){this.cachedData=clone(this.data,this.cloneMethod);this.cachedIndex=this.idIndex;this.cachedBinaryIndex=this.binaryIndices;for(var idx=0;idx<this.DynamicViews.length;idx++){this.DynamicViews[idx].startTransaction()}}};Collection.prototype.commit=function(){if(this.transactional){this.cachedData=null;this.cachedIndex=null;this.cachedBinaryIndex=null;for(var idx=0;idx<this.DynamicViews.length;idx++){this.DynamicViews[idx].commit()}}};Collection.prototype.rollback=function(){if(this.transactional){if(this.cachedData!==null&&this.cachedIndex!==null){this.data=this.cachedData;this.idIndex=this.cachedIndex;this.binaryIndices=this.cachedBinaryIndex}for(var idx=0;idx<this.DynamicViews.length;idx++){this.DynamicViews[idx].rollback()}}};Collection.prototype.async=function(fun,callback){setTimeout(function(){if(typeof fun==="function"){fun();callback()}else{throw new TypeError("Argument passed for async execution is not a function")}},0)};Collection.prototype.where=function(fun){return this.chain().where(fun).data()};Collection.prototype.mapReduce=function(mapFunction,reduceFunction){try{return reduceFunction(this.data.map(mapFunction))}catch(err){throw err}};Collection.prototype.eqJoin=function(joinData,leftJoinProp,rightJoinProp,mapFun,dataOptions){return new Resultset(this).eqJoin(joinData,leftJoinProp,rightJoinProp,mapFun,dataOptions)};Collection.prototype.stages={};Collection.prototype.getStage=function(name){if(!this.stages[name]){this.stages[name]={}}return this.stages[name]};Collection.prototype.commitLog=[];Collection.prototype.stage=function(stageName,obj){var copy=JSON.parse(JSON.stringify(obj));this.getStage(stageName)[obj.$loki]=copy;return copy};Collection.prototype.commitStage=function(stageName,message){var stage=this.getStage(stageName),prop,timestamp=(new Date).getTime();for(prop in stage){this.update(stage[prop]);this.commitLog.push({timestamp:timestamp,message:message,data:JSON.parse(JSON.stringify(stage[prop]))})}this.stages[stageName]={}};Collection.prototype.no_op=function(){return};Collection.prototype.extract=function(field){var i=0,len=this.data.length,isDotNotation=isDeepProperty(field),result=[];for(i;i<len;i+=1){result.push(deepProperty(this.data[i],field,isDotNotation))}return result};Collection.prototype.max=function(field){return Math.max.apply(null,this.extract(field))};Collection.prototype.min=function(field){return Math.min.apply(null,this.extract(field))};Collection.prototype.maxRecord=function(field){var i=0,len=this.data.length,deep=isDeepProperty(field),result={index:0,value:undefined},max;for(i;i<len;i+=1){if(max!==undefined){if(max<deepProperty(this.data[i],field,deep)){max=deepProperty(this.data[i],field,deep);result.index=this.data[i].$loki}}else{max=deepProperty(this.data[i],field,deep);result.index=this.data[i].$loki}}result.value=max;return result};Collection.prototype.minRecord=function(field){var i=0,len=this.data.length,deep=isDeepProperty(field),result={index:0,value:undefined},min;for(i;i<len;i+=1){if(min!==undefined){if(min>deepProperty(this.data[i],field,deep)){min=deepProperty(this.data[i],field,deep);result.index=this.data[i].$loki}}else{min=deepProperty(this.data[i],field,deep);result.index=this.data[i].$loki}}result.value=min;return result};Collection.prototype.extractNumerical=function(field){return this.extract(field).map(parseBase10).filter(Number).filter(function(n){return!isNaN(n)})};Collection.prototype.avg=function(field){return average(this.extractNumerical(field))};Collection.prototype.stdDev=function(field){return standardDeviation(this.extractNumerical(field))};Collection.prototype.mode=function(field){var dict={},data=this.extract(field);data.forEach(function(obj){if(dict[obj]){dict[obj]+=1}else{dict[obj]=1}});var max,prop,mode;for(prop in dict){if(max){if(max<dict[prop]){mode=prop}}else{mode=prop;max=dict[prop]}}return mode};Collection.prototype.median=function(field){var values=this.extractNumerical(field);values.sort(sub);var half=Math.floor(values.length/2);if(values.length%2){return values[half]}else{return(values[half-1]+values[half])/2}};function isDeepProperty(field){return field.indexOf(".")!==-1}function parseBase10(num){return parseFloat(num,10)}function isNotUndefined(obj){return obj!==undefined}function add(a,b){return a+b}function sub(a,b){return a-b}function median(values){values.sort(sub);var half=Math.floor(values.length/2);return values.length%2?values[half]:(values[half-1]+values[half])/2}function average(array){return array.reduce(add,0)/array.length}function standardDeviation(values){var avg=average(values);var squareDiffs=values.map(function(value){var diff=value-avg;var sqrDiff=diff*diff;return sqrDiff});var avgSquareDiff=average(squareDiffs);var stdDev=Math.sqrt(avgSquareDiff);return stdDev}function deepProperty(obj,property,isDeep){if(isDeep===false){return obj[property]}var pieces=property.split("."),root=obj;while(pieces.length>0){root=root[pieces.shift()]}return root}function binarySearch(array,item,fun){var lo=0,hi=array.length,compared,mid;while(lo<hi){mid=lo+hi>>1;compared=fun.apply(null,[item,array[mid]]);if(compared===0){return{found:true,index:mid}}else if(compared<0){hi=mid}else{lo=mid+1}}return{found:false,index:hi}}function BSonSort(fun){return function(array,item){return binarySearch(array,item,fun)}}function KeyValueStore(){}KeyValueStore.prototype={keys:[],values:[],sort:function(a,b){return a<b?-1:a>b?1:0},setSort:function(fun){this.bs=new BSonSort(fun)},bs:function(){return new BSonSort(this.sort)},set:function(key,value){var pos=this.bs(this.keys,key);if(pos.found){this.values[pos.index]=value}else{this.keys.splice(pos.index,0,key);this.values.splice(pos.index,0,value)}},get:function(key){return this.values[binarySearch(this.keys,key,this.sort).index]}};function UniqueIndex(uniqueField){this.field=uniqueField;this.keyMap={};this.lokiMap={}}UniqueIndex.prototype.keyMap={};UniqueIndex.prototype.lokiMap={};UniqueIndex.prototype.set=function(obj){var fieldValue=obj[this.field];if(fieldValue!==null&&typeof fieldValue!=="undefined"){if(this.keyMap[fieldValue]){throw new Error("Duplicate key for property "+this.field+": "+fieldValue)}else{this.keyMap[fieldValue]=obj;this.lokiMap[obj.$loki]=fieldValue}}};UniqueIndex.prototype.get=function(key){return this.keyMap[key]};UniqueIndex.prototype.byId=function(id){return this.keyMap[this.lokiMap[id]]};UniqueIndex.prototype.update=function(obj,doc){if(this.lokiMap[obj.$loki]!==doc[this.field]){var old=this.lokiMap[obj.$loki];this.set(doc);this.keyMap[old]=undefined}else{this.keyMap[obj[this.field]]=doc}};UniqueIndex.prototype.remove=function(key){var obj=this.keyMap[key];if(obj!==null&&typeof obj!=="undefined"){this.keyMap[key]=undefined;this.lokiMap[obj.$loki]=undefined}else{throw new Error("Key is not in unique index: "+this.field)}};UniqueIndex.prototype.clear=function(){this.keyMap={};this.lokiMap={}};function ExactIndex(exactField){this.index={};this.field=exactField}ExactIndex.prototype={set:function add(key,val){if(this.index[key]){this.index[key].push(val)}else{this.index[key]=[val]}},remove:function remove(key,val){var idxSet=this.index[key];for(var i in idxSet){if(idxSet[i]==val){idxSet.splice(i,1)}}if(idxSet.length<1){this.index[key]=undefined}},get:function get(key){return this.index[key]},clear:function clear(key){this.index={}}};function SortedIndex(sortedField){this.field=sortedField}SortedIndex.prototype={keys:[],values:[],sort:function(a,b){return a<b?-1:a>b?1:0},bs:function(){return new BSonSort(this.sort)},setSort:function(fun){this.bs=new BSonSort(fun)},set:function(key,value){var pos=binarySearch(this.keys,key,this.sort);if(pos.found){this.values[pos.index].push(value)}else{this.keys.splice(pos.index,0,key);this.values.splice(pos.index,0,[value])}},get:function(key){var bsr=binarySearch(this.keys,key,this.sort);if(bsr.found){return this.values[bsr.index]}else{return[]}},getLt:function(key){var bsr=binarySearch(this.keys,key,this.sort);var pos=bsr.index;if(bsr.found)pos--;return this.getAll(key,0,pos)},getGt:function(key){var bsr=binarySearch(this.keys,key,this.sort);var pos=bsr.index;if(bsr.found)pos++;return this.getAll(key,pos,this.keys.length)},getAll:function(key,start,end){var results=[];for(var i=start;i<end;i++){results=results.concat(this.values[i])}return results},getPos:function(key){return binarySearch(this.keys,key,this.sort)},remove:function(key,value){var pos=binarySearch(this.keys,key,this.sort).index;var idxSet=this.values[pos];for(var i in idxSet){if(idxSet[i]==value)idxSet.splice(i,1)}if(idxSet.length<1){this.keys.splice(pos,1);this.values.splice(pos,1)}},clear:function(){this.keys=[];this.values=[]}};Loki.LokiOps=LokiOps;Loki.Collection=Collection;Loki.KeyValueStore=KeyValueStore;Loki.LokiMemoryAdapter=LokiMemoryAdapter;Loki.LokiPartitioningAdapter=LokiPartitioningAdapter;Loki.LokiLocalStorageAdapter=LokiLocalStorageAdapter;Loki.LokiFsAdapter=LokiFsAdapter;Loki.persistenceAdapters={fs:LokiFsAdapter,localStorage:LokiLocalStorageAdapter};Loki.aeq=aeqHelper;Loki.lt=ltHelper;Loki.gt=gtHelper;return Loki}()})}).call(this,typeof global!=="undefined"?global:typeof self!=="undefined"?self:typeof window!=="undefined"?window:{})},{"./loki-indexed-adapter.js":21,fs:9}],23:[function(require,module,exports){"use strict";module.exports=function(fn,errMsg){if(typeof fn!=="function"){throw new TypeError("Expected a function")}var ret;var called=false;var fnName=fn.displayName||fn.name||(/function ([^\(]+)/.exec(fn.toString())||[])[1];var onetime=function(){if(called){if(errMsg===true){fnName=fnName?fnName+"()":"Function";throw new Error(fnName+" can only be called once.")}return ret}called=true;ret=fn.apply(this,arguments);fn=null;return ret};onetime.displayName=fnName;return onetime}},{}],24:[function(require,module,exports){var process=module.exports={};var cachedSetTimeout;var cachedClearTimeout;function defaultSetTimout(){throw new Error("setTimeout has not been defined")}function defaultClearTimeout(){throw new Error("clearTimeout has not been defined")}(function(){try{if(typeof setTimeout==="function"){cachedSetTimeout=setTimeout}else{cachedSetTimeout=defaultSetTimout}}catch(e){cachedSetTimeout=defaultSetTimout}try{if(typeof clearTimeout==="function"){cachedClearTimeout=clearTimeout}else{cachedClearTimeout=defaultClearTimeout}}catch(e){cachedClearTimeout=defaultClearTimeout}})();function runTimeout(fun){if(cachedSetTimeout===setTimeout){return setTimeout(fun,0)}if((cachedSetTimeout===defaultSetTimout||!cachedSetTimeout)&&setTimeout){cachedSetTimeout=setTimeout;return setTimeout(fun,0)}try{return cachedSetTimeout(fun,0)}catch(e){try{return cachedSetTimeout.call(null,fun,0)}catch(e){return cachedSetTimeout.call(this,fun,0)}}}function runClearTimeout(marker){if(cachedClearTimeout===clearTimeout){return clearTimeout(marker)}if((cachedClearTimeout===defaultClearTimeout||!cachedClearTimeout)&&clearTimeout){cachedClearTimeout=clearTimeout;return clearTimeout(marker)}try{return cachedClearTimeout(marker)}catch(e){try{return cachedClearTimeout.call(null,marker)}catch(e){return cachedClearTimeout.call(this,marker)}}}var queue=[];var draining=false;var currentQueue;var queueIndex=-1;function cleanUpNextTick(){if(!draining||!currentQueue){return}draining=false;if(currentQueue.length){queue=currentQueue.concat(queue)}else{queueIndex=-1}if(queue.length){drainQueue()}}function drainQueue(){if(draining){return}var timeout=runTimeout(cleanUpNextTick);draining=true;var len=queue.length;while(len){currentQueue=queue;queue=[];while(++queueIndex<len){if(currentQueue){currentQueue[queueIndex].run()}}queueIndex=-1;len=queue.length}currentQueue=null;draining=false;runClearTimeout(timeout)}process.nextTick=function(fun){var args=new Array(arguments.length-1);if(arguments.length>1){for(var i=1;i<arguments.length;i++){args[i-1]=arguments[i]}}queue.push(new Item(fun,args));if(queue.length===1&&!draining){runTimeout(drainQueue)}};function Item(fun,array){this.fun=fun;this.array=array}Item.prototype.run=function(){this.fun.apply(null,this.array)};process.title="browser";process.browser=true;process.env={};process.argv=[];process.version="";process.versions={};function noop(){}process.on=noop;process.addListener=noop;process.once=noop;process.off=noop;process.removeListener=noop;process.removeAllListeners=noop;process.emit=noop;process.prependListener=noop;process.prependOnceListener=noop;process.listeners=function(name){return[]};process.binding=function(name){throw new Error("process.binding is not supported")};process.cwd=function(){return"/"};process.chdir=function(dir){throw new Error("process.chdir is not supported")};process.umask=function(){return 0}},{}],25:[function(require,module,exports){void function(root,factory){if(typeof define==="function"&&define.amd){define(factory)}else if(typeof exports==="object"){module.exports=factory()}else{root.resolveUrl=factory()}}(this,function(){function resolveUrl(){var numUrls=arguments.length;if(numUrls===0){throw new Error("resolveUrl requires at least one argument; got none.")}var base=document.createElement("base");base.href=arguments[0];if(numUrls===1){return base.href}var head=document.getElementsByTagName("head")[0];head.insertBefore(base,head.firstChild);var a=document.createElement("a");var resolved;for(var index=1;index<numUrls;index++){a.href=arguments[index];resolved=a.href;base.href=resolved}head.removeChild(base);return resolved}return resolveUrl})},{}],26:[function(require,module,exports){"use strict";module.exports=typeof setImmediate==="function"?setImmediate:function setImmediate(){var args=[].slice.apply(arguments);args.splice(1,0,0);setTimeout.apply(null,args)}},{}],27:[function(require,module,exports){"use strict";function uniq(arr){var u={},a=[];for(var i=0,l=arr.length;i<l;++i){if(Object.prototype.hasOwnProperty.call(u,arr[i])){continue}a.push(arr[i]);u[arr[i]]=1}return a}function _add(trie,array){var i,j,node,prevNode,values,goRecursive;node=trie;goRecursive=false;for(i=0;i<array.length;i++){values=array[i].split(",");for(j=0;j<values.length;j++){if(!node.hasOwnProperty(values[j])){node[values[j]]={}}if(values.length>1){goRecursive=goRecursive||array.slice(i+1);node[values[j]]=_add(node[values[j]],goRecursive);i=array.length}else{prevNode=node;node=node[values[j]]}}}if(!goRecursive&&(!prevNode||!prevNode.hasOwnProperty("*"))){node["*"]={}}return trie}function _check(trie,array){var i,node;node=trie;if(array.length<1||array[array.length-1]!=="*"){array.push("*")}for(i=0;i<array.length;i++){if(node.hasOwnProperty("*")&&(array[i]!=="*"&&node.hasOwnProperty(array[i]))){return _check(node["*"],array.slice(i+1))||_check(node[array[i]],array.slice(i+1))}else if(node.hasOwnProperty("*")){if(Object.keys(node["*"]).length===0){return true}node=node["*"]}else if(node.hasOwnProperty(array[i])){node=node[array[i]]}else{if(!node.hasOwnProperty(array[i])){return false}}}return true}function _permissions(trie,array){var current,results;if(!trie||!array||typeof trie!=="object"||!Array.isArray(array)||Object.keys(trie).length<1||array.length<1){return[]}array=[].concat(array);if(trie.hasOwnProperty("*")){return["*"]}current=array.shift();if(current==="?"){results=Object.keys(trie);if(array.length>0){var anyObj={};results.forEach(function(node){anyObj[node]=_expandTrie(trie[node],array)});return results.filter(function(node){return anyObj[node].length>0})}return results}if(current==="$"){results=[];Object.keys(trie).forEach(function concatPermissions(node){results=results.concat(_permissions(trie[node],[].concat(array)))});var u=uniq(results);for(var i=u.length-1;i>=0;i--){if(u[i]==="*"){u.splice(i,1)}}return u}if(trie.hasOwnProperty(current)){return _permissions(trie[current],array)}return[]}function _expand(permission){var results=[];var parts=permission.split(":");var i,alternatives;for(i=0;i<parts.length;i++){alternatives=parts[i].split(",");if(results.length===0){results=alternatives}else{alternatives=alternatives.map(function(alternative){return results.map(function(perm){return perm+":"+alternative},this)},this);results=[].concat.apply([],uniq(alternatives))}}return results}function _expandTrie(trie,array){var a=[].concat(array);return Object.keys(trie).map(function(node){if(node==="*"){return[node]}if(array[0]===node||array[0]==="$"){if(array.length<=1){return[node]}var child=_expandTrie(trie[node],array.slice(1));return child.map(function(inner){return node+":"+inner})}return[]}).reduce(function(a,b){return a.concat(b)},[])}var ShiroTrie=function(){this.data={};return this};ShiroTrie.prototype.reset=function(){this.data={};return this};ShiroTrie.prototype.add=function(){var args=[].concat.apply([],arguments);var arg;for(arg in args){if(args.hasOwnProperty(arg)&&typeof args[arg]==="string"){this.data=_add(this.data,args[arg].split(":"))}}return this};ShiroTrie.prototype.check=function(string){if(typeof string!=="string"){return false}if(string.indexOf(",")!==-1){return _expand(string).map(function(permission){return _check(this.data,permission.split(":"))},this).every(Boolean)}return _check(this.data,string.split(":"))};ShiroTrie.prototype.get=function(){return this.data};ShiroTrie.prototype.permissions=function(string){if(typeof string!=="string"){return[]}return _permissions(this.data,string.split(":"))};module.exports={new:function(){return new ShiroTrie},newTrie:function(){return new ShiroTrie},_expand:_expand}},{}],28:[function(require,module,exports){function Agent(){this._defaults=[]}["use","on","once","set","query","type","accept","auth","withCredentials","sortQuery","retry","ok","redirects","timeout","buffer","serialize","parse","ca","key","pfx","cert"].forEach(function(fn){Agent.prototype[fn]=function(){this._defaults.push({fn:fn,arguments:arguments});return this}});Agent.prototype._setDefaults=function(req){this._defaults.forEach(function(def){req[def.fn].apply(req,def.arguments)})};module.exports=Agent},{}],29:[function(require,module,exports){var root;if(typeof window!=="undefined"){root=window}else if(typeof self!=="undefined"){root=self}else{console.warn("Using browser-only version of superagent in non-browser environment");root=this}var Emitter=require("component-emitter");var RequestBase=require("./request-base");var isObject=require("./is-object");var ResponseBase=require("./response-base");var Agent=require("./agent-base");function noop(){}var request=exports=module.exports=function(method,url){if("function"==typeof url){return new exports.Request("GET",method).end(url)}if(1==arguments.length){return new exports.Request("GET",method)}return new exports.Request(method,url)};exports.Request=Request;request.getXHR=function(){if(root.XMLHttpRequest&&(!root.location||"file:"!=root.location.protocol||!root.ActiveXObject)){return new XMLHttpRequest}else{try{return new ActiveXObject("Microsoft.XMLHTTP")}catch(e){}try{return new ActiveXObject("Msxml2.XMLHTTP.6.0")}catch(e){}try{return new ActiveXObject("Msxml2.XMLHTTP.3.0")}catch(e){}try{return new ActiveXObject("Msxml2.XMLHTTP")}catch(e){}}throw Error("Browser-only version of superagent could not find XHR")};var trim="".trim?function(s){return s.trim()}:function(s){return s.replace(/(^\s*|\s*$)/g,"")};function serialize(obj){if(!isObject(obj))return obj;var pairs=[];for(var key in obj){pushEncodedKeyValuePair(pairs,key,obj[key])}return pairs.join("&")}function pushEncodedKeyValuePair(pairs,key,val){if(val!=null){if(Array.isArray(val)){val.forEach(function(v){pushEncodedKeyValuePair(pairs,key,v)})}else if(isObject(val)){for(var subkey in val){pushEncodedKeyValuePair(pairs,key+"["+subkey+"]",val[subkey])}}else{pairs.push(encodeURIComponent(key)+"="+encodeURIComponent(val))}}else if(val===null){pairs.push(encodeURIComponent(key))}}request.serializeObject=serialize;function parseString(str){var obj={};var pairs=str.split("&");var pair;var pos;for(var i=0,len=pairs.length;i<len;++i){pair=pairs[i];pos=pair.indexOf("=");if(pos==-1){obj[decodeURIComponent(pair)]=""}else{obj[decodeURIComponent(pair.slice(0,pos))]=decodeURIComponent(pair.slice(pos+1))}}return obj}request.parseString=parseString;request.types={html:"text/html",json:"application/json",xml:"text/xml",
urlencoded:"application/x-www-form-urlencoded",form:"application/x-www-form-urlencoded","form-data":"application/x-www-form-urlencoded"};request.serialize={"application/x-www-form-urlencoded":serialize,"application/json":JSON.stringify};request.parse={"application/x-www-form-urlencoded":parseString,"application/json":JSON.parse};function parseHeader(str){var lines=str.split(/\r?\n/);var fields={};var index;var line;var field;var val;for(var i=0,len=lines.length;i<len;++i){line=lines[i];index=line.indexOf(":");if(index===-1){continue}field=line.slice(0,index).toLowerCase();val=trim(line.slice(index+1));fields[field]=val}return fields}function isJSON(mime){return/[\/+]json\b/.test(mime)}function Response(req){this.req=req;this.xhr=this.req.xhr;this.text=this.req.method!="HEAD"&&(this.xhr.responseType===""||this.xhr.responseType==="text")||typeof this.xhr.responseType==="undefined"?this.xhr.responseText:null;this.statusText=this.req.xhr.statusText;var status=this.xhr.status;if(status===1223){status=204}this._setStatusProperties(status);this.header=this.headers=parseHeader(this.xhr.getAllResponseHeaders());this.header["content-type"]=this.xhr.getResponseHeader("content-type");this._setHeaderProperties(this.header);if(null===this.text&&req._responseType){this.body=this.xhr.response}else{this.body=this.req.method!="HEAD"?this._parseBody(this.text?this.text:this.xhr.response):null}}ResponseBase(Response.prototype);Response.prototype._parseBody=function(str){var parse=request.parse[this.type];if(this.req._parser){return this.req._parser(this,str)}if(!parse&&isJSON(this.type)){parse=request.parse["application/json"]}return parse&&str&&(str.length||str instanceof Object)?parse(str):null};Response.prototype.toError=function(){var req=this.req;var method=req.method;var url=req.url;var msg="cannot "+method+" "+url+" ("+this.status+")";var err=new Error(msg);err.status=this.status;err.method=method;err.url=url;return err};request.Response=Response;function Request(method,url){var self=this;this._query=this._query||[];this.method=method;this.url=url;this.header={};this._header={};this.on("end",function(){var err=null;var res=null;try{res=new Response(self)}catch(e){err=new Error("Parser is unable to parse the response");err.parse=true;err.original=e;if(self.xhr){err.rawResponse=typeof self.xhr.responseType=="undefined"?self.xhr.responseText:self.xhr.response;err.status=self.xhr.status?self.xhr.status:null;err.statusCode=err.status}else{err.rawResponse=null;err.status=null}return self.callback(err)}self.emit("response",res);var new_err;try{if(!self._isResponseOK(res)){new_err=new Error(res.statusText||"Unsuccessful HTTP response")}}catch(custom_err){new_err=custom_err}if(new_err){new_err.original=err;new_err.response=res;new_err.status=res.status;self.callback(new_err,res)}else{self.callback(null,res)}})}Emitter(Request.prototype);RequestBase(Request.prototype);Request.prototype.type=function(type){this.set("Content-Type",request.types[type]||type);return this};Request.prototype.accept=function(type){this.set("Accept",request.types[type]||type);return this};Request.prototype.auth=function(user,pass,options){if(1===arguments.length)pass="";if(typeof pass==="object"&&pass!==null){options=pass;pass=""}if(!options){options={type:"function"===typeof btoa?"basic":"auto"}}var encoder=function(string){if("function"===typeof btoa){return btoa(string)}throw new Error("Cannot use basic auth, btoa is not a function")};return this._auth(user,pass,options,encoder)};Request.prototype.query=function(val){if("string"!=typeof val)val=serialize(val);if(val)this._query.push(val);return this};Request.prototype.attach=function(field,file,options){if(file){if(this._data){throw Error("superagent can't mix .send() and .attach()")}this._getFormData().append(field,file,options||file.name)}return this};Request.prototype._getFormData=function(){if(!this._formData){this._formData=new root.FormData}return this._formData};Request.prototype.callback=function(err,res){if(this._shouldRetry(err,res)){return this._retry()}var fn=this._callback;this.clearTimeout();if(err){if(this._maxRetries)err.retries=this._retries-1;this.emit("error",err)}fn(err,res)};Request.prototype.crossDomainError=function(){var err=new Error("Request has been terminated\nPossible causes: the network is offline, Origin is not allowed by Access-Control-Allow-Origin, the page is being unloaded, etc.");err.crossDomain=true;err.status=this.status;err.method=this.method;err.url=this.url;this.callback(err)};Request.prototype.buffer=Request.prototype.ca=Request.prototype.agent=function(){console.warn("This is not supported in browser version of superagent");return this};Request.prototype.pipe=Request.prototype.write=function(){throw Error("Streaming is not supported in browser version of superagent")};Request.prototype._isHost=function _isHost(obj){return obj&&"object"===typeof obj&&!Array.isArray(obj)&&Object.prototype.toString.call(obj)!=="[object Object]"};Request.prototype.end=function(fn){if(this._endCalled){console.warn("Warning: .end() was called twice. This is not supported in superagent")}this._endCalled=true;this._callback=fn||noop;this._finalizeQueryString();return this._end()};Request.prototype._end=function(){var self=this;var xhr=this.xhr=request.getXHR();var data=this._formData||this._data;this._setTimeouts();xhr.onreadystatechange=function(){var readyState=xhr.readyState;if(readyState>=2&&self._responseTimeoutTimer){clearTimeout(self._responseTimeoutTimer)}if(4!=readyState){return}var status;try{status=xhr.status}catch(e){status=0}if(!status){if(self.timedout||self._aborted)return;return self.crossDomainError()}self.emit("end")};var handleProgress=function(direction,e){if(e.total>0){e.percent=e.loaded/e.total*100}e.direction=direction;self.emit("progress",e)};if(this.hasListeners("progress")){try{xhr.onprogress=handleProgress.bind(null,"download");if(xhr.upload){xhr.upload.onprogress=handleProgress.bind(null,"upload")}}catch(e){}}try{if(this.username&&this.password){xhr.open(this.method,this.url,true,this.username,this.password)}else{xhr.open(this.method,this.url,true)}}catch(err){return this.callback(err)}if(this._withCredentials)xhr.withCredentials=true;if(!this._formData&&"GET"!=this.method&&"HEAD"!=this.method&&"string"!=typeof data&&!this._isHost(data)){var contentType=this._header["content-type"];var serialize=this._serializer||request.serialize[contentType?contentType.split(";")[0]:""];if(!serialize&&isJSON(contentType)){serialize=request.serialize["application/json"]}if(serialize)data=serialize(data)}for(var field in this.header){if(null==this.header[field])continue;if(this.header.hasOwnProperty(field))xhr.setRequestHeader(field,this.header[field])}if(this._responseType){xhr.responseType=this._responseType}this.emit("request",this);xhr.send(typeof data!=="undefined"?data:null);return this};request.agent=function(){return new Agent};["GET","POST","OPTIONS","PATCH","PUT","DELETE"].forEach(function(method){Agent.prototype[method.toLowerCase()]=function(url,fn){var req=new request.Request(method,url);this._setDefaults(req);if(fn){req.end(fn)}return req}});Agent.prototype.del=Agent.prototype["delete"];request.get=function(url,data,fn){var req=request("GET",url);if("function"==typeof data)fn=data,data=null;if(data)req.query(data);if(fn)req.end(fn);return req};request.head=function(url,data,fn){var req=request("HEAD",url);if("function"==typeof data)fn=data,data=null;if(data)req.query(data);if(fn)req.end(fn);return req};request.options=function(url,data,fn){var req=request("OPTIONS",url);if("function"==typeof data)fn=data,data=null;if(data)req.send(data);if(fn)req.end(fn);return req};function del(url,data,fn){var req=request("DELETE",url);if("function"==typeof data)fn=data,data=null;if(data)req.send(data);if(fn)req.end(fn);return req}request["del"]=del;request["delete"]=del;request.patch=function(url,data,fn){var req=request("PATCH",url);if("function"==typeof data)fn=data,data=null;if(data)req.send(data);if(fn)req.end(fn);return req};request.post=function(url,data,fn){var req=request("POST",url);if("function"==typeof data)fn=data,data=null;if(data)req.send(data);if(fn)req.end(fn);return req};request.put=function(url,data,fn){var req=request("PUT",url);if("function"==typeof data)fn=data,data=null;if(data)req.send(data);if(fn)req.end(fn);return req}},{"./agent-base":28,"./is-object":30,"./request-base":31,"./response-base":32,"component-emitter":10}],30:[function(require,module,exports){"use strict";function isObject(obj){return null!==obj&&"object"===typeof obj}module.exports=isObject},{}],31:[function(require,module,exports){"use strict";var isObject=require("./is-object");module.exports=RequestBase;function RequestBase(obj){if(obj)return mixin(obj)}function mixin(obj){for(var key in RequestBase.prototype){obj[key]=RequestBase.prototype[key]}return obj}RequestBase.prototype.clearTimeout=function _clearTimeout(){clearTimeout(this._timer);clearTimeout(this._responseTimeoutTimer);delete this._timer;delete this._responseTimeoutTimer;return this};RequestBase.prototype.parse=function parse(fn){this._parser=fn;return this};RequestBase.prototype.responseType=function(val){this._responseType=val;return this};RequestBase.prototype.serialize=function serialize(fn){this._serializer=fn;return this};RequestBase.prototype.timeout=function timeout(options){if(!options||"object"!==typeof options){this._timeout=options;this._responseTimeout=0;return this}for(var option in options){switch(option){case"deadline":this._timeout=options.deadline;break;case"response":this._responseTimeout=options.response;break;default:console.warn("Unknown timeout option",option)}}return this};RequestBase.prototype.retry=function retry(count,fn){if(arguments.length===0||count===true)count=1;if(count<=0)count=0;this._maxRetries=count;this._retries=0;this._retryCallback=fn;return this};var ERROR_CODES=["ECONNRESET","ETIMEDOUT","EADDRINFO","ESOCKETTIMEDOUT"];RequestBase.prototype._shouldRetry=function(err,res){if(!this._maxRetries||this._retries++>=this._maxRetries){return false}if(this._retryCallback){try{var override=this._retryCallback(err,res);if(override===true)return true;if(override===false)return false}catch(e){console.error(e)}}if(res&&res.status&&res.status>=500&&res.status!=501)return true;if(err){if(err.code&&~ERROR_CODES.indexOf(err.code))return true;if(err.timeout&&err.code=="ECONNABORTED")return true;if(err.crossDomain)return true}return false};RequestBase.prototype._retry=function(){this.clearTimeout();if(this.req){this.req=null;this.req=this.request()}this._aborted=false;this.timedout=false;return this._end()};RequestBase.prototype.then=function then(resolve,reject){if(!this._fullfilledPromise){var self=this;if(this._endCalled){console.warn("Warning: superagent request was sent twice, because both .end() and .then() were called. Never call .end() if you use promises")}this._fullfilledPromise=new Promise(function(innerResolve,innerReject){self.end(function(err,res){if(err)innerReject(err);else innerResolve(res)})})}return this._fullfilledPromise.then(resolve,reject)};RequestBase.prototype.catch=function(cb){return this.then(undefined,cb)};RequestBase.prototype.use=function use(fn){fn(this);return this};RequestBase.prototype.ok=function(cb){if("function"!==typeof cb)throw Error("Callback required");this._okCallback=cb;return this};RequestBase.prototype._isResponseOK=function(res){if(!res){return false}if(this._okCallback){return this._okCallback(res)}return res.status>=200&&res.status<300};RequestBase.prototype.get=function(field){return this._header[field.toLowerCase()]};RequestBase.prototype.getHeader=RequestBase.prototype.get;RequestBase.prototype.set=function(field,val){if(isObject(field)){for(var key in field){this.set(key,field[key])}return this}this._header[field.toLowerCase()]=val;this.header[field]=val;return this};RequestBase.prototype.unset=function(field){delete this._header[field.toLowerCase()];delete this.header[field];return this};RequestBase.prototype.field=function(name,val){if(null===name||undefined===name){throw new Error(".field(name, val) name can not be empty")}if(this._data){console.error(".field() can't be used if .send() is used. Please use only .send() or only .field() & .attach()")}if(isObject(name)){for(var key in name){this.field(key,name[key])}return this}if(Array.isArray(val)){for(var i in val){this.field(name,val[i])}return this}if(null===val||undefined===val){throw new Error(".field(name, val) val can not be empty")}if("boolean"===typeof val){val=""+val}this._getFormData().append(name,val);return this};RequestBase.prototype.abort=function(){if(this._aborted){return this}this._aborted=true;this.xhr&&this.xhr.abort();this.req&&this.req.abort();this.clearTimeout();this.emit("abort");return this};RequestBase.prototype._auth=function(user,pass,options,base64Encoder){switch(options.type){case"basic":this.set("Authorization","Basic "+base64Encoder(user+":"+pass));break;case"auto":this.username=user;this.password=pass;break;case"bearer":this.set("Authorization","Bearer "+user);break}return this};RequestBase.prototype.withCredentials=function(on){if(on==undefined)on=true;this._withCredentials=on;return this};RequestBase.prototype.redirects=function(n){this._maxRedirects=n;return this};RequestBase.prototype.maxResponseSize=function(n){if("number"!==typeof n){throw TypeError("Invalid argument")}this._maxResponseSize=n;return this};RequestBase.prototype.toJSON=function(){return{method:this.method,url:this.url,data:this._data,headers:this._header}};RequestBase.prototype.send=function(data){var isObj=isObject(data);var type=this._header["content-type"];if(this._formData){console.error(".send() can't be used if .attach() or .field() is used. Please use only .send() or only .field() & .attach()")}if(isObj&&!this._data){if(Array.isArray(data)){this._data=[]}else if(!this._isHost(data)){this._data={}}}else if(data&&this._data&&this._isHost(this._data)){throw Error("Can't merge these send calls")}if(isObj&&isObject(this._data)){for(var key in data){this._data[key]=data[key]}}else if("string"==typeof data){if(!type)this.type("form");type=this._header["content-type"];if("application/x-www-form-urlencoded"==type){this._data=this._data?this._data+"&"+data:data}else{this._data=(this._data||"")+data}}else{this._data=data}if(!isObj||this._isHost(data)){return this}if(!type)this.type("json");return this};RequestBase.prototype.sortQuery=function(sort){this._sort=typeof sort==="undefined"?true:sort;return this};RequestBase.prototype._finalizeQueryString=function(){var query=this._query.join("&");if(query){this.url+=(this.url.indexOf("?")>=0?"&":"?")+query}this._query.length=0;if(this._sort){var index=this.url.indexOf("?");if(index>=0){var queryArr=this.url.substring(index+1).split("&");if("function"===typeof this._sort){queryArr.sort(this._sort)}else{queryArr.sort()}this.url=this.url.substring(0,index)+"?"+queryArr.join("&")}}};RequestBase.prototype._appendQueryString=function(){console.trace("Unsupported")};RequestBase.prototype._timeoutError=function(reason,timeout,errno){if(this._aborted){return}var err=new Error(reason+timeout+"ms exceeded");err.timeout=timeout;err.code="ECONNABORTED";err.errno=errno;this.timedout=true;this.abort();this.callback(err)};RequestBase.prototype._setTimeouts=function(){var self=this;if(this._timeout&&!this._timer){this._timer=setTimeout(function(){self._timeoutError("Timeout of ",self._timeout,"ETIME")},this._timeout)}if(this._responseTimeout&&!this._responseTimeoutTimer){this._responseTimeoutTimer=setTimeout(function(){self._timeoutError("Response timeout of ",self._responseTimeout,"ETIMEDOUT")},this._responseTimeout)}}},{"./is-object":30}],32:[function(require,module,exports){"use strict";var utils=require("./utils");module.exports=ResponseBase;function ResponseBase(obj){if(obj)return mixin(obj)}function mixin(obj){for(var key in ResponseBase.prototype){obj[key]=ResponseBase.prototype[key]}return obj}ResponseBase.prototype.get=function(field){return this.header[field.toLowerCase()]};ResponseBase.prototype._setHeaderProperties=function(header){var ct=header["content-type"]||"";this.type=utils.type(ct);var params=utils.params(ct);for(var key in params)this[key]=params[key];this.links={};try{if(header.link){this.links=utils.parseLinks(header.link)}}catch(err){}};ResponseBase.prototype._setStatusProperties=function(status){var type=status/100|0;this.status=this.statusCode=status;this.statusType=type;this.info=1==type;this.ok=2==type;this.redirect=3==type;this.clientError=4==type;this.serverError=5==type;this.error=4==type||5==type?this.toError():false;this.accepted=202==status;this.noContent=204==status;this.badRequest=400==status;this.unauthorized=401==status;this.notAcceptable=406==status;this.forbidden=403==status;this.notFound=404==status}},{"./utils":33}],33:[function(require,module,exports){"use strict";exports.type=function(str){return str.split(/ *; */).shift()};exports.params=function(str){return str.split(/ *; */).reduce(function(obj,str){var parts=str.split(/ *= */);var key=parts.shift();var val=parts.shift();if(key&&val)obj[key]=val;return obj},{})};exports.parseLinks=function(str){return str.split(/ *, */).reduce(function(obj,str){var parts=str.split(/ *; */);var url=parts[0].slice(1,-1);var rel=parts[1].split(/ *= */)[1].slice(1,-1);obj[rel]=url;return obj},{})};exports.cleanHeader=function(header,changesOrigin){delete header["content-type"];delete header["content-length"];delete header["transfer-encoding"];delete header["host"];if(changesOrigin){delete header["authorization"];delete header["cookie"]}return header}},{}],34:[function(require,module,exports){"use strict";var halfred=require("halfred");function JsonHalAdapter(log){this.log=log}JsonHalAdapter.errors={InvalidArgumentError:"InvalidArgumentError",InvalidStateError:"InvalidStateError",LinkError:"HalLinkError",LinkMissingOrInvalidError:"HalLinkMissingOrInvalidError",EmbeddedDocumentsError:"HalEmbeddedDocumentsError"};JsonHalAdapter.mediaType="application/hal+json";JsonHalAdapter.prototype.findNextStep=function(t,linkObject){if(typeof linkObject==="undefined"||linkObject===null){throw createError("Link object is null or undefined.",JsonHalAdapter.errors.InvalidArgumentError)}if(typeof linkObject!=="object"){throw createError("Links must be objects, not "+typeof linkObject+": ",JsonHalAdapter.errors.InvalidArgumentError,linkObject)}if(!linkObject.type){throw createError("Link objects has no type attribute.",JsonHalAdapter.errors.InvalidArgumentError,linkObject)}switch(linkObject.type){case"link-rel":return this._handleLinkRel(t,linkObject);case"header":return this._handleHeader(t.lastStep.response,linkObject);default:throw createError("Link objects with type "+linkObject.type+" are not supported by this adapter.",JsonHalAdapter.errors.InvalidArgumentError,linkObject)}};JsonHalAdapter.prototype._handleLinkRel=function(t,linkObject){var doc=t.lastStep.doc;var key=linkObject.value;this.log.debug("parsing hal");var ctx={doc:doc,halResource:halfred.parse(doc),parsedKey:parseKey(key),linkStep:null,embeddedStep:null};resolveCurie(ctx);findLink(ctx,this.log);findEmbedded(ctx,this.log);return prepareResult(ctx,key,t.preferEmbedded)};function prepareResult(ctx,key,preferEmbedded){var step;if(preferEmbedded||ctx.parsedKey.mode==="all"){step=ctx.embeddedStep||ctx.linkStep}else{step=ctx.linkStep||ctx.embeddedStep}if(step){return step}else{var message="Could not find a matching link nor an embedded document "+"for "+key+".";var errorName=JsonHalAdapter.errors.LinkError;if(ctx.linkError){message+=" Error while resolving linked documents: "+ctx.linkError;errorName=JsonHalAdapter.errors.LinkMissingOrInvalidError}if(ctx.embeddedError){message+=" Error while resolving embedded documents: "+ctx.embeddedError;if(!ctx.linkError||preferEmbedded){errorName=JsonHalAdapter.errors.EmbeddedDocumentsError}}message+=" Document: "+JSON.stringify(ctx.doc);throw createError(message,errorName,ctx.doc)}}function parseKey(key){var match=key.match(/(.*)\[(.*):(.*)\]/);if(match){return{mode:"secondary",key:match[1],secondaryKey:match[2],secondaryValue:match[3],index:null}}match=key.match(/(.*)\[(\d+)\]/);if(match){return{mode:"index",key:match[1],secondaryKey:null,secondaryValue:null,index:match[2]}}match=key.match(/(.*)\[\$all\]/);if(match){return{mode:"all",key:match[1],secondaryKey:null,secondaryValue:null,index:null}}return{mode:"first",key:key,secondaryKey:null,secondaryValue:null,index:null}}function resolveCurie(ctx){if(ctx.halResource.hasCuries()){ctx.parsedKey.curie=ctx.halResource.reverseResolveCurie(ctx.parsedKey.key)}}function findLink(ctx,log){var linkArray=ctx.halResource.linkArray(ctx.parsedKey.key);if(!linkArray){linkArray=ctx.halResource.linkArray(ctx.parsedKey.curie)}if(!linkArray||linkArray.length===0){return}switch(ctx.parsedKey.mode){case"secondary":findLinkBySecondaryKey(ctx,linkArray,log);break;case"index":findLinkByIndex(ctx,linkArray,log);break;case"first":findLinkWithoutIndex(ctx,linkArray,log);break;case"all":break;default:throw createError("Illegal mode: "+ctx.parsedKey.mode,JsonHalAdapter.errors.InvalidArgumentError)}}function findLinkBySecondaryKey(ctx,linkArray,log){var i=0;for(;i<linkArray.length;i++){var val=linkArray[i][ctx.parsedKey.secondaryKey];if(val!=null&&val==ctx.parsedKey.secondaryValue){if(!linkArray[i].href){ctx.linkError="The link "+ctx.parsedKey.key+"["+ctx.parsedKey.secondaryKey+":"+ctx.parsedKey.secondaryValue+"] exists, but it has no href attribute.";return}log.debug("found hal link: "+linkArray[i].href);ctx.linkStep={url:linkArray[i].href};return}}ctx.linkError=ctx.parsedKey.key+"["+ctx.parsedKey.secondaryKey+":"+ctx.parsedKey.secondaryValue+"] requested, but there is no such link."}function findLinkByIndex(ctx,linkArray,log){if(!linkArray[ctx.parsedKey.index]){ctx.linkError="The link array "+ctx.parsedKey.key+" exists, but has no element at index "+ctx.parsedKey.index+".";return}if(!linkArray[ctx.parsedKey.index].href){ctx.linkError="The link "+ctx.parsedKey.key+"["+ctx.parsedKey.index+"] exists, but it has no href attribute.";return}log.debug("found hal link: "+linkArray[ctx.parsedKey.index].href);ctx.linkStep={url:linkArray[ctx.parsedKey.index].href}}function findLinkWithoutIndex(ctx,linkArray,log){var link;for(var index=0;index<linkArray.length;index++){if(linkArray[index].href){link=linkArray[index];break}}if(link){if(linkArray.length>1){log.warn("Found HAL link array with more than one element for "+"key "+ctx.parsedKey.key+", arbitrarily choosing index "+index+", because it was the first that had a href attribute.")}log.debug("found hal link: "+link.href);ctx.linkStep={url:link.href}}}function findEmbedded(ctx,log){log.debug("checking for embedded: "+ctx.parsedKey.key+(ctx.parsedKey.index?ctx.parsedKey.index:""));var resourceArray=ctx.halResource.embeddedArray(ctx.parsedKey.key);if((!resourceArray||resourceArray.length===0)&&ctx.parsedKey.mode!=="all"){return}log.debug("Found an array of embedded resource for: "+ctx.parsedKey.key);switch(ctx.parsedKey.mode){case"secondary":findEmbeddedBySecondaryKey(ctx,resourceArray,log);break;case"index":findEmbeddedByIndex(ctx,resourceArray,log);break;case"all":findEmbeddedAll(ctx,resourceArray,log);break;case"first":findEmbeddedWithoutIndex(ctx,resourceArray,log);break;default:throw createError("Illegal mode: "+ctx.parsedKey.mode,JsonHalAdapter.errors.InvalidArgumentError)}}function findEmbeddedBySecondaryKey(ctx,embeddedArray,log){var i=0;for(;i<embeddedArray.length;i++){var val=embeddedArray[i][ctx.parsedKey.secondaryKey];if(val!=null&&val==ctx.parsedKey.secondaryValue){log.debug("Found an embedded resource for: "+ctx.parsedKey.key+"["+ctx.parsedKey.secondaryKey+":"+ctx.parsedKey.secondaryValue+"]");ctx.embeddedStep={doc:embeddedArray[i].original()};return}}ctx.embeddedError=ctx.parsedKey.key+"["+ctx.parsedKey.secondaryKey+":"+ctx.parsedKey.secondaryValue+"] requested, but the embedded array "+ctx.parsedKey.key+" has no such element."}function findEmbeddedByIndex(ctx,resourceArray,log){if(!resourceArray[ctx.parsedKey.index]){ctx.embeddedError="The embedded array "+ctx.parsedKey.key+" exists, but has no element at index "+ctx.parsedKey.index+".";return}log.debug("Found an embedded resource for: "+ctx.parsedKey.key+"["+ctx.parsedKey.index+"]");ctx.embeddedStep={doc:resourceArray[ctx.parsedKey.index].original()}}function findEmbeddedAll(ctx,embeddedArray,log){var result=ctx.halResource.original()._embedded&&ctx.halResource.original()._embedded[ctx.parsedKey.key];if(!result){result=[]}else if(!(result instanceof Array)){result=[].concat(result)}ctx.embeddedStep={doc:result}}function findEmbeddedWithoutIndex(ctx,resourceArray,log){if(resourceArray.length>1){log.warn("Found HAL embedded resource array with more than one element "+" for key "+ctx.parsedKey.key+", arbitrarily choosing first element.")}ctx.embeddedStep={doc:resourceArray[0].original()}}JsonHalAdapter.prototype._handleHeader=function(httpResponse,link){switch(link.value){case"location":var locationHeader=httpResponse.headers.location;if(!locationHeader){throw createError("Following the location header but there was no "+"location header in the last response.",JsonHalAdapter.errors.InvalidStateError)}return{url:locationHeader};default:throw createError("Link objects with type header and value "+link.value+" are not supported by this adapter.",JsonHalAdapter.errors.InvalidArgumentError,link)}};function createError(message,name,data){var error=new Error(message);error.name=name;if(data){error.data=data}return error}module.exports=JsonHalAdapter},{halfred:13}],35:[function(require,module,exports){"use strict";var enabled=false;function Logger(id){if(id==null){id=""}this.id=id}Logger.prototype.enable=function(){this.enabled=true};Logger.prototype.debug=function(message){if(enabled){console.log(this.id+"/debug: "+message)}};Logger.prototype.info=function(message){if(enabled){console.log(this.id+"/info: "+message)}};Logger.prototype.warn=function(message){if(enabled){console.log(this.id+"/warn: "+message)}};Logger.prototype.error=function(message){if(enabled){console.log(this.id+"/error: "+message)}};function minilog(id){return new Logger(id)}minilog.enable=function(){enabled=true};module.exports=minilog},{}],36:[function(require,module,exports){"use strict";module.exports={isArray:function(o){if(o==null){return false}return Object.prototype.toString.call(o)==="[object Array]"}}},{}],37:[function(require,module,exports){"use strict";var superagent=require("superagent");function Request(){}Request.prototype.get=function(uri,options,callback){return mapRequest(superagent.get(uri),options).end(handleResponse(callback))};Request.prototype.post=function(uri,options,callback){return mapRequest(superagent.post(uri),options).end(handleResponse(callback))};Request.prototype.put=function(uri,options,callback){return mapRequest(superagent.put(uri),options).end(handleResponse(callback))};Request.prototype.patch=function(uri,options,callback){return mapRequest(superagent.patch(uri),options).end(handleResponse(callback))};Request.prototype.del=function(uri,options,callback){return mapRequest(superagent.del(uri),options).end(handleResponse(callback))};function mapRequest(superagentRequest,options){options=options||{};mapQuery(superagentRequest,options);mapHeaders(superagentRequest,options);mapAuth(superagentRequest,options);mapBody(superagentRequest,options);mapForm(superagentRequest,options);mapWithCredentials(superagentRequest,options);return superagentRequest}function mapQuery(superagentRequest,options){var qs=options.qs;if(qs!=null){superagentRequest=superagentRequest.query(qs)}}function mapHeaders(superagentRequest,options){var headers=options.headers;if(headers!=null){superagentRequest=superagentRequest.set(headers)}}function mapAuth(superagentRequest,options){var auth=options.auth;if(auth!=null){superagentRequest=superagentRequest.auth(auth.user||auth.username,auth.pass||auth.password)}}function mapBody(superagentRequest,options){if(options!=null){var body=options.body;if(body!=null){superagentRequest=superagentRequest.send(body)}}}function mapForm(superagentRequest,options){if(options!=null){var form=options.form;if(form!=null){superagentRequest=superagentRequest.set("content-type","application/x-www-form-urlencoded");superagentRequest=superagentRequest.send(form)}}}function mapWithCredentials(superagentRequest,options){if(options!=null){var withCredentials=options.withCredentials;if(withCredentials===true){superagentRequest.withCredentials()}}}function mapResponse(response){response.body=response.text;response.statusCode=response.status;return response}function handleResponse(callback){return function(err,response){if(err){if(!response){return callback(err)}else{callback(null,mapResponse(response))}}else{callback(null,mapResponse(response))}}}module.exports=new Request},{superagent:29}],38:[function(require,module,exports){"use strict";var _s={startsWith:function(str,starts){if(starts==="")return true;if(str==null||starts==null)return false;str=String(str);starts=String(starts);return str.length>=starts.length&&str.slice(0,starts.length)===starts},endsWith:function(str,ends){if(ends==="")return true;if(str==null||ends==null)return false;str=String(str);ends=String(ends);return str.length>=ends.length&&str.slice(str.length-ends.length)===ends},splice:function(str,i,howmany,substr){var arr=_s.chars(str);arr.splice(~~i,~~howmany,substr);return arr.join("")},contains:function(str,needle){if(needle==="")return true;if(str==null)return false;return String(str).indexOf(needle)!==-1},chars:function(str){if(str==null)return[];return String(str).split("")}};module.exports=_s},{}],39:[function(require,module,exports){"use strict";var resolveUrl=require("resolve-url");exports.resolve=function(from,to){return resolveUrl(from,to)}},{"resolve-url":25}],40:[function(require,module,exports){"use strict";var minilog=require("minilog"),errorModule=require("./errors"),errors=errorModule.errors,createError=errorModule.createError,log=minilog("traverson");exports.abortTraversal=function abortTraversal(){log.debug("aborting link traversal");this.aborted=true;if(this.currentRequest){log.debug("request in progress. trying to abort it, too.");this.currentRequest.abort()}};exports.registerAbortListener=function registerAbortListener(t,callback){if(t.currentRequest){t.currentRequest.on("abort",function(){exports.callCallbackOnAbort(t)})}};exports.callCallbackOnAbort=function callCallbackOnAbort(t){log.debug("link traversal aborted");if(!t.callbackHasBeenCalledAfterAbort){t.callbackHasBeenCalledAfterAbort=true;t.callback(exports.abortError(),t)}};exports.abortError=function abortError(){var error=createError("Link traversal process has been aborted.",errors.TraversalAbortedError);error.aborted=true;return error}},{"./errors":43,minilog:35}],41:[function(require,module,exports){"use strict";var minilog=require("minilog"),log=minilog("traverson"),abortTraversal=require("./abort_traversal"),applyTransforms=require("./transforms/apply_transforms"),httpRequests=require("./http_requests"),isContinuation=require("./is_continuation"),walker=require("./walker");var checkHttpStatus=require("./transforms/check_http_status"),continuationToDoc=require("./transforms/continuation_to_doc"),continuationToResponse=require("./transforms/continuation_to_response"),convertEmbeddedDocToResponse=require("./transforms/convert_embedded_doc_to_response"),extractDoc=require("./transforms/extract_doc"),extractResponse=require("./transforms/extract_response"),extractUrl=require("./transforms/extract_url"),fetchLastResource=require("./transforms/fetch_last_resource"),executeLastHttpRequest=require("./transforms/execute_last_http_request"),executeHttpRequest=require("./transforms/execute_http_request"),parse=require("./transforms/parse"),parseLinkHeader=require("./transforms/parse_link_header");exports.get=function(t,callback){var transformsAfterLastStep;if(t.convertResponseToObject){
transformsAfterLastStep=[continuationToDoc,fetchLastResource,checkHttpStatus,parse,parseLinkHeader,extractDoc]}else{transformsAfterLastStep=[continuationToResponse,fetchLastResource,convertEmbeddedDocToResponse,extractResponse]}walker.walk(t,transformsAfterLastStep,callback);return createTraversalHandle(t)};exports.getUrl=function(t,callback){walker.walk(t,[extractUrl],callback);return createTraversalHandle(t)};exports.post=function(t,callback){walkAndExecute(t,t.requestModuleInstance,t.requestModuleInstance.post,callback);return createTraversalHandle(t)};exports.put=function(t,callback){walkAndExecute(t,t.requestModuleInstance,t.requestModuleInstance.put,callback);return createTraversalHandle(t)};exports.patch=function(t,callback){walkAndExecute(t,t.requestModuleInstance,t.requestModuleInstance.patch,callback);return createTraversalHandle(t)};exports.delete=function(t,callback){walkAndExecute(t,t.requestModuleInstance,t.requestModuleInstance.del,callback);return createTraversalHandle(t)};function walkAndExecute(t,request,method,callback){var transformsAfterLastStep;if(t.convertResponseToObject){transformsAfterLastStep=[executeHttpRequest,checkHttpStatus,parse,parseLinkHeader,extractDoc]}else{transformsAfterLastStep=[executeLastHttpRequest]}t.lastMethod=method;walker.walk(t,transformsAfterLastStep,callback)}function createTraversalHandle(t){return{abort:t.abortTraversal}}},{"./abort_traversal":40,"./http_requests":44,"./is_continuation":45,"./transforms/apply_transforms":52,"./transforms/check_http_status":53,"./transforms/continuation_to_doc":54,"./transforms/continuation_to_response":55,"./transforms/convert_embedded_doc_to_response":56,"./transforms/execute_http_request":58,"./transforms/execute_last_http_request":59,"./transforms/extract_doc":60,"./transforms/extract_response":61,"./transforms/extract_url":62,"./transforms/fetch_last_resource":63,"./transforms/parse":66,"./transforms/parse_link_header":67,"./walker":73,minilog:35}],42:[function(require,module,exports){"use strict";var minilog=require("minilog"),standardRequest=require("request"),util=require("util");var actions=require("./actions"),abortTraversal=require("./abort_traversal").abortTraversal,errorModule=require("./errors"),errors=errorModule.errors,createError=errorModule.createError,mediaTypeRegistry=require("./media_type_registry"),mediaTypes=require("./media_types"),mergeRecursive=require("./merge_recursive");var log=minilog("traverson");function Builder(mediaType,linkType){this.mediaType=mediaType||mediaTypes.CONTENT_NEGOTIATION;this.linkType=linkType||"link-rel";this.adapter=this._createAdapter(this.mediaType);this.autoHeaders=true;this.contentNegotiation=true;this.convertResponseToObjectFlag=false;this.links=[];this.jsonParser=JSON.parse;this.requestModuleInstance=standardRequest;this.requestOptions={};this.resolveRelativeFlag=false;this.preferEmbedded=false;this.lastTraversalState=null;this.continuation=null}Builder.prototype._createAdapter=function(mediaType){var AdapterType=mediaTypeRegistry.get(mediaType);if(!AdapterType){throw createError("Unknown or unsupported media type: "+mediaType,errors.UnsupportedMediaType)}log.debug("creating new "+AdapterType.name);return new AdapterType(log)};Builder.prototype.newRequest=function(){var clonedRequestBuilder=new Builder(this.getMediaType(),this.getLinkType());clonedRequestBuilder.useAutoHeaders(this.setsAutoHeaders());clonedRequestBuilder.contentNegotiation=this.doesContentNegotiation();clonedRequestBuilder.convertResponseToObject(this.convertsResponseToObject());clonedRequestBuilder.from(shallowCloneArray(this.getFrom()));clonedRequestBuilder.withTemplateParameters(cloneArrayOrObject(this.getTemplateParameters()));clonedRequestBuilder.withRequestOptions(cloneArrayOrObject(this.getRequestOptions()));clonedRequestBuilder.withRequestLibrary(this.getRequestLibrary());clonedRequestBuilder.parseResponseBodiesWith(this.getJsonParser());clonedRequestBuilder.resolveRelative(this.doesResolveRelative());clonedRequestBuilder.preferEmbeddedResources(this.doesPreferEmbeddedResources());clonedRequestBuilder.continuation=this.continuation;return clonedRequestBuilder};Builder.prototype.setMediaType=function(mediaType){this.mediaType=mediaType||mediaTypes.CONTENT_NEGOTIATION;this.adapter=this._createAdapter(mediaType);this.contentNegotiation=mediaType===mediaTypes.CONTENT_NEGOTIATION;return this};Builder.prototype.getLinkType=function(){return this.linkType};Builder.prototype.json=function(){this.setMediaType(mediaTypes.JSON);return this};Builder.prototype.jsonHal=function(){this.setMediaType(mediaTypes.JSON_HAL);return this};Builder.prototype.useContentNegotiation=function(){this.setMediaType(mediaTypes.CONTENT_NEGOTIATION);this.contentNegotiation=true;return this};Builder.prototype.from=function(url){this.startUrl=url;return this};Builder.prototype.follow=function(){var newLinks=Array.prototype.slice.apply(arguments.length===1&&util.isArray(arguments[0])?arguments[0]:arguments);for(var i=0;i<newLinks.length;i++){if(typeof newLinks[i]==="string"){newLinks[i]={type:this.linkType,value:newLinks[i]}}}this.links=this.links.concat(newLinks);return this};Builder.prototype.followLocationHeader=function(){this.links.push({type:"header",value:"location"});return this};Builder.prototype.walk=Builder.prototype.follow;Builder.prototype.withTemplateParameters=function(parameters){this.templateParameters=parameters;return this};Builder.prototype.withRequestOptions=function(options){this.requestOptions=options;return this};Builder.prototype.addRequestOptions=function(options){if(util.isArray(this.requestOptions)&&util.isArray(options)){mergeArrayElements(this.requestOptions,options)}else if(typeof this.requestOptions==="object"&&util.isArray(options)){this.requestOptions=mergeBaseObjectWithArrayElements(this.requestOptions,options)}else if(util.isArray(this.requestOptions)&&typeof options==="object"){mergeOptionObjectIntoEachArrayElement(this.requestOptions,options)}else{mergeRecursive(this.requestOptions,options)}return this};function mergeArrayElements(existingOptions,newOptions){for(var i=0;i<Math.max(existingOptions.length,newOptions.length);i++){existingOptions[i]=mergeRecursive(existingOptions[i],newOptions[i])}}function mergeBaseObjectWithArrayElements(existingOptions,newOptions){var newOptArray=[];for(var i=0;i<newOptions.length;i++){newOptArray[i]=mergeRecursive(newOptions[i],existingOptions)}return newOptArray}function mergeOptionObjectIntoEachArrayElement(existingOptions,newOptions){for(var i=0;i<existingOptions.length;i++){mergeRecursive(existingOptions[i],newOptions)}}Builder.prototype.withRequestLibrary=function(request){this.requestModuleInstance=request;return this};Builder.prototype.parseResponseBodiesWith=function(parser){this.jsonParser=parser;return this};Builder.prototype.disableAutoHeaders=function(){return this.useAutoHeaders(false)};Builder.prototype.enableAutoHeaders=function(){return this.useAutoHeaders(true)};Builder.prototype.useAutoHeaders=function(flag){if(typeof flag==="undefined"||flag===null){flag=true}this.autoHeaders=!!flag;return this};Builder.prototype.convertResponseToObject=function(flag){if(typeof flag==="undefined"||flag===null){flag=true}this.convertResponseToObjectFlag=!!flag;return this};Builder.prototype.resolveRelative=function(flag){if(typeof flag==="undefined"||flag===null){flag=true}this.resolveRelativeFlag=!!flag;return this};Builder.prototype.preferEmbeddedResources=function(flag){if(typeof flag==="undefined"||flag===null){flag=true}this.preferEmbedded=!!flag;return this};Builder.prototype.getMediaType=function(){return this.mediaType};Builder.prototype.getFrom=function(){return this.startUrl};Builder.prototype.getTemplateParameters=function(){return this.templateParameters};Builder.prototype.getRequestOptions=function(){return this.requestOptions};Builder.prototype.getRequestLibrary=function(){return this.requestModuleInstance};Builder.prototype.getJsonParser=function(){return this.jsonParser};Builder.prototype.setsAutoHeaders=function(){return this.autoHeaders};Builder.prototype.convertsResponseToObject=function(){return this.convertResponseToObjectFlag};Builder.prototype.doesResolveRelative=function(){return this.resolveRelativeFlag};Builder.prototype.doesPreferEmbeddedResources=function(){return this.preferEmbedded};Builder.prototype.doesContentNegotiation=function(){return this.contentNegotiation};Builder.prototype.get=function get(callback){log.debug("initiating traversal (get)");var t=createInitialTraversalState(this);return actions.get(t,wrapForContinue(this,t,callback,"get"))};Builder.prototype.getResource=function getResource(callback){log.debug("initiating traversal (getResource)");this.convertResponseToObjectFlag=true;var t=createInitialTraversalState(this);return actions.get(t,wrapForContinue(this,t,callback,"getResource"))};Builder.prototype.getUrl=function getUrl(callback){log.debug("initiating traversal (getUrl)");var t=createInitialTraversalState(this);return actions.getUrl(t,wrapForContinue(this,t,callback,"getUrl"))};Builder.prototype.getUri=Builder.prototype.getUrl;Builder.prototype.post=function post(body,callback){log.debug("initiating traversal (post)");var t=createInitialTraversalState(this,body);return actions.post(t,wrapForContinue(this,t,callback,"post"))};Builder.prototype.put=function put(body,callback){log.debug("initiating traversal (put)");var t=createInitialTraversalState(this,body);return actions.put(t,wrapForContinue(this,t,callback,"put"))};Builder.prototype.patch=function patch(body,callback){log.debug("initiating traversal (patch)");var t=createInitialTraversalState(this,body);return actions.patch(t,wrapForContinue(this,t,callback,"patch"))};Builder.prototype.delete=function del(callback){log.debug("initiating traversal (delete)");var t=createInitialTraversalState(this);return actions.delete(t,wrapForContinue(this,t,callback,"delete"))};Builder.prototype.del=Builder.prototype.delete;Builder.prototype.linkHeader=function(){this.linkType="link-header";return this};function createInitialTraversalState(self,body){var normalizedBody=body!==null&&typeof body!==undefined?body:null;var traversalState={aborted:false,adapter:self.adapter||null,body:normalizedBody,callbackHasBeenCalledAfterAbort:false,autoHeaders:self.setsAutoHeaders(),contentNegotiation:self.doesContentNegotiation(),continuation:null,convertResponseToObject:self.convertsResponseToObject(),links:self.links,jsonParser:self.getJsonParser(),requestModuleInstance:self.getRequestLibrary(),requestOptions:self.getRequestOptions(),resolveRelative:self.doesResolveRelative(),preferEmbedded:self.doesPreferEmbeddedResources(),startUrl:self.startUrl,step:{url:self.startUrl,index:0},templateParameters:self.getTemplateParameters()};traversalState.abortTraversal=abortTraversal.bind(traversalState);if(self.continuation){traversalState.continuation=self.continuation;traversalState.step=self.continuation.step;self.continuation=null}return traversalState}function wrapForContinue(self,t,callback,firstTraversalAction){return function(err,result){if(err){return callback(err)}return callback(null,result,{continue:function(){if(!t){throw createError("No traversal state to continue from.",errors.InvalidStateError)}log.debug("> continuing finished traversal process");self.continuation={step:t.step,action:firstTraversalAction};self.continuation.step.index=0;initFromTraversalState(self,t);return self}})}}function initFromTraversalState(self,t){self.aborted=false;self.adapter=t.adapter;self.body=t.body;self.callbackHasBeenCalledAfterAbort=false;self.autoHeaders=t.autoHeaders;self.contentNegotiation=t.contentNegotiation;self.convertResponseToObjectFlag=t.convertResponseToObject;self.links=[];self.jsonParser=t.jsonParser;self.requestModuleInstance=t.requestModuleInstance,self.requestOptions=t.requestOptions,self.resolveRelativeFlag=t.resolveRelative;self.preferEmbedded=t.preferEmbedded;self.startUrl=t.startUrl;self.templateParameters=t.templateParameters}function cloneArrayOrObject(thing){if(util.isArray(thing)){return shallowCloneArray(thing)}else if(typeof thing==="object"){return deepCloneObject(thing)}else{return thing}}function deepCloneObject(object){return mergeRecursive(null,object)}function shallowCloneArray(array){if(!array){return array}return array.slice(0)}module.exports=Builder},{"./abort_traversal":40,"./actions":41,"./errors":43,"./media_type_registry":47,"./media_types":48,"./merge_recursive":49,minilog:35,request:37,util:36}],43:[function(require,module,exports){"use strict";module.exports={errors:{HTTPError:"HTTPError",InvalidArgumentError:"InvalidArgumentError",InvalidStateError:"InvalidStateError",JSONError:"JSONError",JSONPathError:"JSONPathError",LinkError:"LinkError",TraversalAbortedError:"TraversalAbortedError",UnsupportedMediaType:"UnsupportedMediaTypeError"},createError:function(message,name,data){var error=new Error(message);error.name=name;if(data){error.data=data}return error}}},{}],44:[function(require,module,exports){(function(process){"use strict";var minilog=require("minilog"),log=minilog("traverson"),abortTraversal=require("./abort_traversal"),detectContentType=require("./transforms/detect_content_type"),errorModule=require("./errors"),errors=errorModule.errors,createError=errorModule.createError,getOptionsForStep=require("./transforms/get_options_for_step");exports.fetchResource=function fetchResource(t,callback){log.debug("fetching resource for next step");if(t.step.url){log.debug("fetching resource from ",t.step.url);return executeHttpGet(t,callback)}else if(t.step.doc){log.debug("resource for next step has already been fetched, using "+"embedded");return process.nextTick(function(){callback(null,t)})}else{return process.nextTick(function(){var error=createError("Can not process step.",errors.InvalidStateError);error.step=t.step;callback(error,t)})}};function executeHttpGet(t,callback){var options=getOptionsForStep(t);log.debug("HTTP GET request to ",t.step.url);log.debug("options ",options);t.currentRequest=t.requestModuleInstance.get(t.step.url,options,function(err,response,body){log.debug("HTTP GET request to "+t.step.url+" returned");t.currentRequest=null;if(body&&!response.body){response.body=body}t.step.response=response;if(err){return callback(err,t)}log.debug("request to "+t.step.url+" finished without error ("+response.statusCode+")");if(!detectContentType(t,callback))return;return callback(null,t)});abortTraversal.registerAbortListener(t,callback)}exports.executeHttpRequest=function(t,request,method,callback){var requestOptions=getOptionsForStep(t);if(t.body!==null&&typeof t.body!=="undefined"){requestOptions.body=requestOptions.jsonReplacer?t.body:JSON.stringify(t.body)}log.debug("HTTP "+method.name+" request to ",t.step.url);log.debug("options ",requestOptions);t.currentRequest=method.call(request,t.step.url,requestOptions,function(err,response,body){log.debug("HTTP "+method.name+" request to "+t.step.url+" returned");t.currentRequest=null;if(body&&!response.body){response.body=body}t.step.response=response;if(err){return callback(err)}return callback(null,response)});abortTraversal.registerAbortListener(t,callback)}}).call(this,require("_process"))},{"./abort_traversal":40,"./errors":43,"./transforms/detect_content_type":57,"./transforms/get_options_for_step":65,_process:24,minilog:35}],45:[function(require,module,exports){"use strict";module.exports=function isContinuation(t){return t.continuation&&t.step&&t.step.response}},{}],46:[function(require,module,exports){"use strict";var jsonpath=require("jsonpath-plus"),minilog=require("minilog"),_s=require("underscore.string");var errorModule=require("./errors"),errors=errorModule.errors,createError=errorModule.createError,parseLinkHeaderValue=require("./parse_link_header_value");function JsonAdapter(log){this.log=log}JsonAdapter.mediaType="application/json";JsonAdapter.prototype.findNextStep=function(t,link){validateLinkObject(link);var doc=t.lastStep.doc;this.log.debug("resolving link",link);switch(link.type){case"link-rel":return this._handleLinkRel(doc,link);case"header":return this._handleHeader(t.lastStep.response,link);case"link-header":return this._handleLinkHeader(t.lastStep.response,link);default:throw createError("Link objects with type "+link.type+" are not "+"supported by this adapter.",errors.InvalidArgumentError,link)}};JsonAdapter.prototype._handleLinkRel=function(doc,link){var linkRel=link.value;this.log.debug("looking for link-rel in doc",linkRel,doc);var url;if(this._testJSONPath(linkRel)){return{url:this._resolveJSONPath(doc,linkRel)}}else if(doc[linkRel]){return{url:doc[linkRel]}}else{throw createError("Could not find property "+linkRel+" in document.",errors.LinkError,doc)}};function validateLinkObject(link){if(typeof link==="undefined"||link===null){throw createError("Link object is null or undefined.",errors.InvalidArgumentError)}if(typeof link!=="object"){throw createError("Links must be objects, not "+typeof link+".",errors.InvalidArgumentError,link)}if(!link.type){throw createError("Link objects has no type attribute.",errors.InvalidArgumentError,link)}}JsonAdapter.prototype._testJSONPath=function(link){return _s.startsWith(link,"$.")||_s.startsWith(link,"$[")};JsonAdapter.prototype._resolveJSONPath=function(doc,link){var matches=jsonpath({json:doc,path:link});if(matches.length===1){var url=matches[0];if(!url){throw createError("JSONPath expression "+link+" was resolved but the result was null, undefined or an empty"+" string in document:\n"+JSON.stringify(doc),errors.JSONPathError,doc)}if(typeof url!=="string"){throw createError("JSONPath expression "+link+" was resolved but the result is not a property of type string. "+'Instead it has type "'+typeof url+'" in document:\n'+JSON.stringify(doc),errors.JSONPathError,doc)}return url}else if(matches.length>1){throw createError("JSONPath expression "+link+" returned more than one match in document:\n"+JSON.stringify(doc),errors.JSONPathError,doc)}else{throw createError("JSONPath expression "+link+" returned no match in document:\n"+JSON.stringify(doc),errors.JSONPathError,doc)}};JsonAdapter.prototype._handleHeader=function(httpResponse,link){switch(link.value){case"location":var locationHeader=httpResponse.headers.location;if(!locationHeader){throw createError("Following the location header but there was no "+"location header in the last response.",errors.LinkError,httpResponse.headers)}return{url:locationHeader};default:throw createError("Link objects with type header and value "+link.value+" are not supported by this adapter.",errors.InvalidArgumentError,link)}};JsonAdapter.prototype._handleLinkHeader=function(httpResponse,link){if(!httpResponse.headers.link)throw createError("There was no link header in the last response.",errors.InvalidArgumentError,link);var links=parseLinkHeaderValue(httpResponse.headers.link);if(links[link.value]){return{url:links[link.value].url}}else{throw createError("Link with relation "+link.value+" not found in link header.",errors.InvalidArgumentError,link)}};module.exports=JsonAdapter},{"./errors":43,"./parse_link_header_value":51,"jsonpath-plus":19,minilog:35,"underscore.string":38}],47:[function(require,module,exports){"use strict";var mediaTypes=require("./media_types");var registry={};exports.register=function register(contentType,constructor){registry[contentType]=constructor};exports.get=function get(contentType){return registry[contentType]};exports.register(mediaTypes.CONTENT_NEGOTIATION,require("./negotiation_adapter"));exports.register(mediaTypes.JSON,require("./json_adapter"))},{"./json_adapter":46,"./media_types":48,"./negotiation_adapter":50}],48:[function(require,module,exports){"use strict";var JsonAdapter=require("./json_adapter");module.exports={CONTENT_NEGOTIATION:"content-negotiation",JSON:JsonAdapter.mediaType,JSON_HAL:"application/hal+json"}},{"./json_adapter":46}],49:[function(require,module,exports){"use strict";function mergeRecursive(obj1,obj2){if(!obj1&&obj2){obj1={}}for(var key in obj2){if(!obj2.hasOwnProperty(key)){continue}merge(obj1,obj2,key)}return obj1}function merge(obj1,obj2,key){if(typeof obj2[key]==="object"){if(!obj1[key]||typeof obj1[key]!=="object"){obj1[key]={}}mergeRecursive(obj1[key],obj2[key])}else{obj1[key]=obj2[key]}}module.exports=mergeRecursive},{}],50:[function(require,module,exports){"use strict";var errorModule=require("./errors"),errors=errorModule.errors,createError=errorModule.createError;function NegotiationAdapter(log){}NegotiationAdapter.prototype.findNextStep=function(doc,link){throw createError("Content negotiation did not happen",errors.InvalidStateError)};module.exports=NegotiationAdapter},{"./errors":43}],51:[function(require,module,exports){var mergeRecursive=require("./merge_recursive");module.exports=function parseLinkHeaderValue(linkHeader){if(!linkHeader){return null}return linkHeader.split(/,\s*</).map(parseLink).filter(hasRel).reduce(intoRels,{})};function parseLink(link){try{var parts=link.split(";");var linkUrl=parts.shift().replace(/[<>]/g,"");var info=parts.reduce(createObjects,{});info.url=linkUrl;return info}catch(e){return null}}function createObjects(acc,p){var m=p.match(/\s*(.+)\s*=\s*"?([^"]+)"?/);if(m)acc[m[1]]=m[2];return acc}function hasRel(linkHeaderValuePart){return linkHeaderValuePart&&linkHeaderValuePart.rel}function intoRels(acc,linkHeaderValuePart){function splitRel(rel){acc[rel]=mergeRecursive({rel:rel},linkHeaderValuePart)}linkHeaderValuePart.rel.split(/\s+/).forEach(splitRel);return acc}},{"./merge_recursive":49}],52:[function(require,module,exports){(function(process){"use strict";var minilog=require("minilog"),log=minilog("traverson");function applyTransforms(transforms,t,callback){log.debug("applying",transforms.length,"transforms");for(var i=0;i<transforms.length;i++){var transform=transforms[i];log.debug("next transform",transform);if(transform.isAsync){return transform(t,function(t){applyTransforms(transforms.slice(i+1),t,callback)})}else{var result=transform(t);if(!result){log.debug("transform has failed or was a final transform");return}}}log.debug("all transformations done, starting next step");return process.nextTick(function(){callback(t)})}module.exports=applyTransforms}).call(this,require("_process"))},{_process:24,minilog:35}],53:[function(require,module,exports){"use strict";var minilog=require("minilog"),log=minilog("traverson"),errorModule=require("../errors"),errors=errorModule.errors,createError=errorModule.createError,isContinuation=require("../is_continuation");module.exports=function checkHttpStatus(t){if(isContinuation(t)){return true}log.debug("checking http status");if(!t.step.response&&t.step.doc){log.debug("found embedded document, assuming no HTTP request has been "+"made");return true}var httpStatus=t.step.response.statusCode;if(httpStatus&&(httpStatus<200||httpStatus>=300)){var error=httpError(t.step.url,httpStatus,t.step.response.body);log.error("unexpected http status code");log.error(error);t.callback(error);return false}log.debug("http status code ok ("+httpStatus+")");return true};function httpError(url,httpStatus,body){var error=createError("HTTP GET for "+url+" resulted in HTTP status code "+httpStatus+".",errors.HTTPError);error.url=url;error.httpStatus=httpStatus;error.body=body;try{error.doc=JSON.parse(body)}catch(e){}return error}},{"../errors":43,"../is_continuation":45,minilog:35}],54:[function(require,module,exports){"use strict";var minilog=require("minilog"),log=minilog("traverson"),isContinuation=require("../is_continuation");module.exports=function continuationToDoc(t){if(isContinuation(t)){log.debug("continuing from last traversal process (actions)");t.continuation=null;t.callback(null,t.step.doc);return false}return true}},{"../is_continuation":45,minilog:35}],55:[function(require,module,exports){"use strict";var minilog=require("minilog"),log=minilog("traverson"),convertEmbeddedDocToResponse=require("./convert_embedded_doc_to_response"),isContinuation=require("../is_continuation");module.exports=function continuationToResponse(t){if(isContinuation(t)){log.debug("continuing from last traversal process (actions)");t.continuation=null;convertEmbeddedDocToResponse(t);t.callback(null,t.step.response);return false}return true}},{"../is_continuation":45,"./convert_embedded_doc_to_response":56,minilog:35}],56:[function(require,module,exports){"use strict";var minilog=require("minilog"),log=minilog("traverson");module.exports=function convertEmbeddedDocToResponse(t){if(!t.step.response&&t.step.doc){log.debug("faking HTTP response for embedded resource");t.step.response={statusCode:200,body:JSON.stringify(t.step.doc),remark:"This is not an actual HTTP response. The resource you "+"requested was an embedded resource, so no HTTP request was "+"made to acquire it."}}return true}},{minilog:35}],57:[function(require,module,exports){"use strict";var minilog=require("minilog"),log=minilog("traverson");var mediaTypeRegistry=require("../media_type_registry"),errorModule=require("../errors"),errors=errorModule.errors,createError=errorModule.createError;module.exports=function detectContentType(t,callback){if(t.contentNegotiation&&t.step.response&&t.step.response.headers&&t.step.response.headers["content-type"]){var contentType=t.step.response.headers["content-type"].split(/[; ]/)[0];log.debug("found content type string",contentType);var AdapterType=mediaTypeRegistry.get(contentType);if(!AdapterType){log.error("no adapter for content type",contentType);callback(createError("Unknown content type for content "+"type detection: "+contentType,errors.UnsupportedMediaType),t);return false}t.adapter=new AdapterType(log);log.debug("switched to media type adapter",t.adapter.name||t.adapter.constructor.name)}return true}},{"../errors":43,"../media_type_registry":47,minilog:35}],58:[function(require,module,exports){"use strict";var minilog=require("minilog"),log=minilog("traverson"),abortTraversal=require("../abort_traversal"),httpRequests=require("../http_requests");function executeLastHttpRequest(t,callback){if(t.aborted){return abortTraversal.callCallbackOnAbort(t)}httpRequests.executeHttpRequest(t,t.requestModuleInstance,t.lastMethod,function(err,response){if(err){if(!err.aborted){log.debug("error while executing http request, "+"processing step ",t.step);log.error(err)}return t.callback(err)}callback(t)})}executeLastHttpRequest.isAsync=true;module.exports=executeLastHttpRequest},{"../abort_traversal":40,"../http_requests":44,minilog:35}],59:[function(require,module,exports){"use strict";var minilog=require("minilog"),log=minilog("traverson"),abortTraversal=require("../abort_traversal"),httpRequests=require("../http_requests");function executeLastHttpRequest(t,callback){if(t.aborted){return abortTraversal.callCallbackOnAbort(t)}httpRequests.executeHttpRequest(t,t.requestModuleInstance,t.lastMethod,t.callback)}executeLastHttpRequest.isAsync=true;module.exports=executeLastHttpRequest},{"../abort_traversal":40,"../http_requests":44,minilog:35}],60:[function(require,module,exports){"use strict";var minilog=require("minilog"),log=minilog("traverson");module.exports=function extractDoc(t){log.debug("walker.walk has finished");t.callback(null,t.step.doc);return false}},{minilog:35}],61:[function(require,module,exports){"use strict";var minilog=require("minilog"),log=minilog("traverson");module.exports=function extractDoc(t){log.debug("walker.walk has finished");t.callback(null,t.step.response);return false}},{minilog:35}],62:[function(require,module,exports){"use strict";var minilog=require("minilog"),log=minilog("traverson"),url=require("url");var errorModule=require("../errors"),errors=errorModule.errors,createError=errorModule.createError;module.exports=function extractDoc(t){log.debug("walker.walk has finished");if(t.step.url){return t.callback(null,t.step.url)}else if(t.step.doc&&t.step.doc._links&&t.step.doc._links.self&&t.step.doc._links.self.href){return t.callback(null,url.resolve(t.startUrl,t.step.doc._links.self.href))}else{return t.callback(createError("You requested an URL but the last "+"resource is an embedded resource and has no URL of its own "+'(that is, it has no link with rel="self"',errors.LinkError))}}},{"../errors":43,minilog:35,url:39}],63:[function(require,module,exports){"use strict";var minilog=require("minilog"),log=minilog("traverson"),abortTraversal=require("../abort_traversal"),httpRequests=require("../http_requests");function fetchLastResource(t,callback){if(t.aborted){return abortTraversal.callCallbackOnAbort(t)}httpRequests.fetchResource(t,function(err,t){log.debug("fetchResource returned (fetchLastResource).");if(err){if(!err.aborted){log.debug("error while executing http request");log.error(err)}return t.callback(err)}callback(t)})}fetchLastResource.isAsync=true;module.exports=fetchLastResource},{"../abort_traversal":40,"../http_requests":44,minilog:35}],64:[function(require,module,exports){(function(process){"use strict";var minilog=require("minilog"),log=minilog("traverson"),abortTraversal=require("../abort_traversal"),isContinuation=require("../is_continuation"),httpRequests=require("../http_requests");function fetchResource(t,callback){if(isContinuation(t)){convertContinuation(t,callback)}else{fetchViaHttp(t,callback)}}fetchResource.isAsync=true;function convertContinuation(t,callback){log.debug("continuing from last traversal process (walker)");process.nextTick(function(){callback(t)})}function fetchViaHttp(t,callback){if(t.aborted){return abortTraversal.callCallbackOnAbort(t)}httpRequests.fetchResource(t,function(err,t){log.debug("fetchResource returned");if(err){if(!err.aborted){log.debug("error while executing http request");log.error(err)}return t.callback(err)}callback(t)})}module.exports=fetchResource}).call(this,require("_process"))},{"../abort_traversal":40,"../http_requests":44,"../is_continuation":45,_process:24,minilog:35}],65:[function(require,module,exports){"use strict";var minilog=require("minilog"),log=minilog("traverson"),util=require("util"),mergeRecursive=require("../merge_recursive");module.exports=function getOptionsForStep(t){var options=t.requestOptions;if(util.isArray(t.requestOptions)){options=t.requestOptions[t.step.index]||{}}if(t.autoHeaders){addAutoHeaders(t,options)}log.debug("options",options);return options};function addAutoHeaders(t,options){var autoHeaderValue=t.adapter.constructor.mediaType||t.adapter.mediaType;if(autoHeaderValue){if(!options.headers){options.headers=createAutoHeaders(options,autoHeaderValue)}else{options.headers=mergeRecursive(createAutoHeaders(options,autoHeaderValue),options.headers)}}}function createAutoHeaders(options,autoHeaderValue){if(!options.form){return{Accept:autoHeaderValue,"Content-Type":autoHeaderValue}}else{return{Accept:autoHeaderValue}}}},{"../merge_recursive":49,minilog:35,util:36}],66:[function(require,module,exports){"use strict";var minilog=require("minilog"),log=minilog("traverson");var errorModule=require("../errors"),errors=errorModule.errors,createError=errorModule.createError,isContinuation=require("../is_continuation");module.exports=function parse(t){if(isContinuation(t)){log.debug("continuing from last traversal process (transforms/parse)");if(t.continuation.action==="getResource"){return true}}if(t.step.doc){log.debug("no parsing necessary, probably an embedded document");return true}try{parseBody(t);return true}catch(e){handleError(t,e);return false}};function parseBody(t){log.debug("parsing response body");if(t.requestOptions&&t.requestOptions.jsonReviver){t.step.doc=t.step.response.body}else{t.step.doc=t.jsonParser(t.step.response.body)}}function handleError(t,e){var error=e;if(e.name==="SyntaxError"){error=jsonError(t.step.url,t.step.response.body)}log.error("parsing failed");log.error(error);t.callback(error)}function jsonError(url,body){var error=createError("The document at "+url+" could not be parsed as JSON: "+body,errors.JSONError,body);error.url=url;error.body=body;return error}},{"../errors":43,"../is_continuation":45,minilog:35}],
67:[function(require,module,exports){"use strict";var minilog=require("minilog"),log=minilog("traverson");var parseLinkHeaderValue=require("../parse_link_header_value");module.exports=function parseLinkHeader(t){if(!t.step.doc||!t.step.response||!t.step.response.headers||!t.step.response.headers.link){return true}try{var links=parseLinkHeaderValue(t.step.response.headers.link);t.step.doc._linkHeaders=links;return true}catch(e){handleError(t,e);return false}};function handleError(t,e){log.error("failed to parse link header");log.error(e);t.callback(e)}},{"../parse_link_header_value":51,minilog:35}],68:[function(require,module,exports){"use strict";var isContinuation=require("../is_continuation");module.exports=function resetLastStep(t){if(isContinuation(t)){return true}t.continuation=null;return true}},{"../is_continuation":45}],69:[function(require,module,exports){"use strict";var isContinuation=require("../is_continuation");module.exports=function resetLastStep(t){if(isContinuation(t)){return true}t.lastStep=null;return true}},{"../is_continuation":45}],70:[function(require,module,exports){"use strict";var minilog=require("minilog"),log=minilog("traverson"),_s=require("underscore.string"),url=require("url");var protocolRegEx=/https?:\/\//i;module.exports=function resolveNextUrl(t){if(t.step.url){if(t.step.url.search(protocolRegEx)!==0){log.debug("found non full qualified URL");if(t.resolveRelative&&t.lastStep&&t.lastStep.url){log.debug("resolving URL relative");if(_s.startsWith(t.step.url,"/")&&_s.endsWith(t.lastStep.url,"/")){t.step.url=_s.splice(t.step.url,0,1)}t.step.url=t.lastStep.url+t.step.url}else{t.step.url=url.resolve(t.startUrl,t.step.url)}}}return true}},{minilog:35,"underscore.string":38,url:39}],71:[function(require,module,exports){"use strict";var minilog=require("minilog"),log=minilog("traverson"),_s=require("underscore.string"),uriTemplate=require("url-template"),util=require("util");module.exports=function resolveUriTemplate(t){if(t.step.url){var templateParams=t.templateParameters;if(util.isArray(templateParams)){templateParams=templateParams[t.step.index]}templateParams=templateParams||{};if(_s.contains(t.step.url,"{")){log.debug("resolving URI template");var template=uriTemplate.parse(t.step.url);var resolved=template.expand(templateParams);log.debug("resolved to ",resolved);t.step.url=resolved}}return true}},{minilog:35,"underscore.string":38,"url-template":75,util:36}],72:[function(require,module,exports){"use strict";var minilog=require("minilog"),log=minilog("traverson");module.exports=function switchToNextStep(t){var link=t.links[t.step.index];log.debug("next link: "+link);t.lastStep=t.step;t.step=findNextStep(t,link);if(!t.step)return false;log.debug("found next step",t.step);t.step.index=t.lastStep.index+1;return true};function findNextStep(t,link){try{return t.adapter.findNextStep(t,link)}catch(e){log.error("could not find next step");log.error(e);t.callback(e);return null}}},{minilog:35}],73:[function(require,module,exports){"use strict";var minilog=require("minilog"),log=minilog("traverson"),abortTraversal=require("./abort_traversal"),applyTransforms=require("./transforms/apply_transforms"),isContinuation=require("./is_continuation"),resolveUriTemplate=require("./transforms/resolve_uri_template");var transforms=[require("./transforms/fetch_resource"),require("./transforms/reset_last_step"),require("./transforms/check_http_status"),require("./transforms/parse"),require("./transforms/switch_to_next_step"),resolveUriTemplate,require("./transforms/resolve_next_url"),require("./transforms/reset_continuation")];exports.walk=function(t,transformsAfterLastStep,callback){if(!resolveUriTemplate(t))return;log.debug("starting to follow links");transformsAfterLastStep=transformsAfterLastStep||[];t.callback=callback;processStep(t,transformsAfterLastStep)};function processStep(t,transformsAfterLastStep){log.debug("processing next step");if(moreLinksToFollow(t)&&!isAborted(t)){applyTransforms(transforms,t,function(t){log.debug("successfully processed step");processStep(t,transformsAfterLastStep)})}else if(isAborted(t)){return abortTraversal.callCallbackOnAbort(t)}else{log.debug("link array exhausted");applyTransforms(transformsAfterLastStep,t,function(t){return t.callback()})}}function moreLinksToFollow(t){return t.step.index<t.links.length}function isAborted(t){return t.aborted}},{"./abort_traversal":40,"./is_continuation":45,"./transforms/apply_transforms":52,"./transforms/check_http_status":53,"./transforms/fetch_resource":64,"./transforms/parse":66,"./transforms/reset_continuation":68,"./transforms/reset_last_step":69,"./transforms/resolve_next_url":70,"./transforms/resolve_uri_template":71,"./transforms/switch_to_next_step":72,minilog:35}],74:[function(require,module,exports){(function(process){"use strict";var minilog=require("minilog"),errorModule=require("./lib/errors"),errors=errorModule.errors,createError=errorModule.createError,mediaTypes=require("./lib/media_types"),Builder=require("./lib/builder"),mediaTypeRegistry=require("./lib/media_type_registry");if(process.env.TRAVERSON_LOGGING){require("minilog").enable()}exports._Builder=Builder;exports.newRequest=function newRequest(){return new Builder};exports.from=function from(url){var builder=new Builder;builder.from(url);return builder};exports.json={from:function(url){var builder=new Builder;builder.from(url);builder.setMediaType(mediaTypes.JSON);return builder}},exports.jsonHal={from:function(url){if(!mediaTypeRegistry.get(mediaTypes.JSON_HAL)){throw createError("JSON HAL adapter is not registered. From version "+"1.0.0 on, Traverson has no longer built-in support for "+"application/hal+json. HAL support was moved to a separate, optional "+"plug-in. See https://github.com/traverson/traverson-hal",errors.UnsupportedMediaType)}var builder=new Builder;builder.from(url);builder.setMediaType(mediaTypes.JSON_HAL);return builder}};exports.registerMediaType=mediaTypeRegistry.register;exports.mediaTypes=mediaTypes;exports.errors=errors}).call(this,require("_process"))},{"./lib/builder":42,"./lib/errors":43,"./lib/media_type_registry":47,"./lib/media_types":48,_process:24,minilog:35}],75:[function(require,module,exports){(function(root,factory){if(typeof exports==="object"){module.exports=factory()}else if(typeof define==="function"&&define.amd){define([],factory)}else{root.urltemplate=factory()}})(this,function(){function UrlTemplate(){}UrlTemplate.prototype.encodeReserved=function(str){return str.split(/(%[0-9A-Fa-f]{2})/g).map(function(part){if(!/%[0-9A-Fa-f]/.test(part)){part=encodeURI(part).replace(/%5B/g,"[").replace(/%5D/g,"]")}return part}).join("")};UrlTemplate.prototype.encodeUnreserved=function(str){return encodeURIComponent(str).replace(/[!'()*]/g,function(c){return"%"+c.charCodeAt(0).toString(16).toUpperCase()})};UrlTemplate.prototype.encodeValue=function(operator,value,key){value=operator==="+"||operator==="#"?this.encodeReserved(value):this.encodeUnreserved(value);if(key){return this.encodeUnreserved(key)+"="+value}else{return value}};UrlTemplate.prototype.isDefined=function(value){return value!==undefined&&value!==null};UrlTemplate.prototype.isKeyOperator=function(operator){return operator===";"||operator==="&"||operator==="?"};UrlTemplate.prototype.getValues=function(context,operator,key,modifier){var value=context[key],result=[];if(this.isDefined(value)&&value!==""){if(typeof value==="string"||typeof value==="number"||typeof value==="boolean"){value=value.toString();if(modifier&&modifier!=="*"){value=value.substring(0,parseInt(modifier,10))}result.push(this.encodeValue(operator,value,this.isKeyOperator(operator)?key:null))}else{if(modifier==="*"){if(Array.isArray(value)){value.filter(this.isDefined).forEach(function(value){result.push(this.encodeValue(operator,value,this.isKeyOperator(operator)?key:null))},this)}else{Object.keys(value).forEach(function(k){if(this.isDefined(value[k])){result.push(this.encodeValue(operator,value[k],k))}},this)}}else{var tmp=[];if(Array.isArray(value)){value.filter(this.isDefined).forEach(function(value){tmp.push(this.encodeValue(operator,value))},this)}else{Object.keys(value).forEach(function(k){if(this.isDefined(value[k])){tmp.push(this.encodeUnreserved(k));tmp.push(this.encodeValue(operator,value[k].toString()))}},this)}if(this.isKeyOperator(operator)){result.push(this.encodeUnreserved(key)+"="+tmp.join(","))}else if(tmp.length!==0){result.push(tmp.join(","))}}}}else{if(operator===";"){if(this.isDefined(value)){result.push(this.encodeUnreserved(key))}}else if(value===""&&(operator==="&"||operator==="?")){result.push(this.encodeUnreserved(key)+"=")}else if(value===""){result.push("")}}return result};UrlTemplate.prototype.parse=function(template){var that=this;var operators=["+","#",".","/",";","?","&"];return{expand:function(context){return template.replace(/\{([^\{\}]+)\}|([^\{\}]+)/g,function(_,expression,literal){if(expression){var operator=null,values=[];if(operators.indexOf(expression.charAt(0))!==-1){operator=expression.charAt(0);expression=expression.substr(1)}expression.split(/,/g).forEach(function(variable){var tmp=/([^:\*]*)(?::(\d+)|(\*))?/.exec(variable);values.push.apply(values,that.getValues(context,operator,tmp[1],tmp[2]||tmp[3]))});if(operator&&operator!=="+"){var separator=",";if(operator==="?"){separator="&"}else if(operator!=="#"){separator=operator}return(values.length!==0?operator:"")+values.join(separator)}else{return values.join(",")}}else{return that.encodeReserved(literal)}})}}};return new UrlTemplate})},{}],76:[function(require,module,exports){var indexOf=require("indexof");var Object_keys=function(obj){if(Object.keys)return Object.keys(obj);else{var res=[];for(var key in obj)res.push(key);return res}};var forEach=function(xs,fn){if(xs.forEach)return xs.forEach(fn);else for(var i=0;i<xs.length;i++){fn(xs[i],i,xs)}};var defineProp=function(){try{Object.defineProperty({},"_",{});return function(obj,name,value){Object.defineProperty(obj,name,{writable:true,enumerable:false,configurable:true,value:value})}}catch(e){return function(obj,name,value){obj[name]=value}}}();var globals=["Array","Boolean","Date","Error","EvalError","Function","Infinity","JSON","Math","NaN","Number","Object","RangeError","ReferenceError","RegExp","String","SyntaxError","TypeError","URIError","decodeURI","decodeURIComponent","encodeURI","encodeURIComponent","escape","eval","isFinite","isNaN","parseFloat","parseInt","undefined","unescape"];function Context(){}Context.prototype={};var Script=exports.Script=function NodeScript(code){if(!(this instanceof Script))return new Script(code);this.code=code};Script.prototype.runInContext=function(context){if(!(context instanceof Context)){throw new TypeError("needs a 'context' argument.")}var iframe=document.createElement("iframe");if(!iframe.style)iframe.style={};iframe.style.display="none";document.body.appendChild(iframe);var win=iframe.contentWindow;var wEval=win.eval,wExecScript=win.execScript;if(!wEval&&wExecScript){wExecScript.call(win,"null");wEval=win.eval}forEach(Object_keys(context),function(key){win[key]=context[key]});forEach(globals,function(key){if(context[key]){win[key]=context[key]}});var winKeys=Object_keys(win);var res=wEval.call(win,this.code);forEach(Object_keys(win),function(key){if(key in context||indexOf(winKeys,key)===-1){context[key]=win[key]}});forEach(globals,function(key){if(!(key in context)){defineProp(context,key,win[key])}});document.body.removeChild(iframe);return res};Script.prototype.runInThisContext=function(){return eval(this.code)};Script.prototype.runInNewContext=function(context){var ctx=Script.createContext(context);var res=this.runInContext(ctx);forEach(Object_keys(ctx),function(key){context[key]=ctx[key]});return res};forEach(Object_keys(Script.prototype),function(name){exports[name]=Script[name]=function(code){var s=Script(code);return s[name].apply(s,[].slice.call(arguments,1))}});exports.createScript=function(code){return exports.Script(code)};exports.createContext=Script.createContext=function(context){var copy=new Context;if(typeof context==="object"){forEach(Object_keys(context),function(key){copy[key]=context[key]})}return copy}},{indexof:17}],"ec.datamanager.js":[function(require,module,exports){"use strict";module.exports=require("./lib/DataManager")},{"./lib/DataManager":2}]},{},[])("ec.datamanager.js")});